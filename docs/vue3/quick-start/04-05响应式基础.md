# âœ¨ å“åº”å¼åŸºç¡€ ğŸ‘Œ

[[TOC]]

> æœ¬ç« ç›®æ ‡ï¼š
>
> - æŒæ¡ `ref` ä¸ `reactive` çš„ä½¿ç”¨åœºæ™¯ä¸å·®å¼‚
> - ç†è§£ `shallowRef` / `shallowReactive` çš„è¡Œä¸º
> - æ¸…æ¥š DOM æ›´æ–°æ—¶æœºä¸ `nextTick`
> - ç†Ÿæ‚‰æ¨¡æ¿ä¸­çš„è‡ªåŠ¨è§£åŒ…è§„åˆ™ä¸å¸¸è§é™·é˜±

## ä½¿ç”¨ ref

`ref` ç”¨äºåˆ›å»ºä¸€ä¸ªå¯å“åº”çš„â€œå€¼å®¹å™¨â€ã€‚å®ƒè¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œéœ€è¦é€šè¿‡ `.value` è¯»å†™å†…éƒ¨å€¼ã€‚æ¨¡æ¿ä¸­ä¼šè‡ªåŠ¨è§£åŒ… `ref`ï¼Œå› æ­¤å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼š

```vue
<template>
  <div>{{ name }}</div>
  <!-- æ¨¡æ¿è‡ªåŠ¨è§£åŒ…ï¼Œæ— éœ€ .value -->
</template>

<script setup>
import { ref } from "vue";
const name = ref("Bill");

console.log(name); // { value: 'Bill' }
console.log(name.value); // 'Bill'

setTimeout(() => {
  name.value = "Tom";
}, 2000);
</script>
```

`ref` å¯ä»¥æŒæœ‰ä»»æ„ç±»å‹ï¼šåŸå§‹å€¼ã€å¯¹è±¡ã€æ•°ç»„ã€ç”šè‡³ `Map`/`Set`ã€‚

å¯¹è±¡å€¼ï¼ˆæ·±å±‚å“åº”ï¼‰çš„ç¤ºä¾‹ï¼š

```vue
<template>
  <div>{{ person.name }}</div>
  <div>{{ person.age }}</div>
  <div>{{ person.nested.count }}</div>
  <!-- æ¨¡æ¿ä¸­çš„å¯¹è±¡å±æ€§åŒæ ·ä¼šè¢«è‡ªåŠ¨è§£åŒ… -->
  <!-- æ³¨æ„ï¼šä»…åœ¨æ¨¡æ¿å†…è‡ªåŠ¨è§£åŒ…ï¼Œè„šæœ¬å†…ä»éœ€ .value -->
</template>

<script setup>
import { ref } from "vue";
const person = ref({
  name: "Bill",
  age: 18,
  nested: { count: 1 },
});

setTimeout(() => {
  person.value.name = "Bill2";
  person.value.age = 20;
  person.value.nested.count += 2;
}, 2000);
</script>
```

æ•°ç»„å€¼çš„ç¤ºä¾‹ï¼š

```vue
<template>
  <div>{{ arr }}</div>
</template>

<script setup>
import { ref } from "vue";
const arr = ref([1, 2, 3]);
setTimeout(() => {
  arr.value.push(4, 5, 6);
}, 2000);
</script>
```

---

## æ·±æµ…å“åº”ï¼šshallowRef

`shallowRef` åªå¯¹ `.value` çš„æ›¿æ¢åšå“åº”ï¼Œå†…éƒ¨å¯¹è±¡ä¸ä¼šè¢«æ·±åº¦è½¬ä¸ºå“åº”å¼ï¼š

```js
import { shallowRef } from "vue";

const state = shallowRef({ count: 1 });
// ä¸è§¦å‘æ›´æ–°ï¼ˆä»…å†…éƒ¨å­—æ®µå˜åŒ–ï¼‰
state.value.count += 2;
// è§¦å‘æ›´æ–°ï¼ˆæ›¿æ¢ .valueï¼‰
state.value = { count: 2 };
```

å®Œæ•´ç¤ºä¾‹ï¼š

```vue
<template>
  <div>{{ person.name }}</div>
  <div>{{ person.age }}</div>
  <div>{{ person.nested.count }}</div>
</template>

<script setup>
import { shallowRef } from "vue";
const person = shallowRef({
  name: "Bill",
  age: 18,
  nested: { count: 1 },
});

// ä¸ä¼šè§¦å‘è§†å›¾æ›´æ–°
setTimeout(() => {
  person.value.name = "Bill2";
  person.value.age = 20;
  person.value.nested.count += 2;
}, 2000);

// ä¼šè§¦å‘è§†å›¾æ›´æ–°ï¼ˆæ›¿æ¢å¼•ç”¨ï¼‰
setTimeout(() => {
  person.value = {
    name: "Bill3",
    age: 30,
    nested: { count: 3 },
  };
}, 4000);
</script>
```

---

## DOM æ›´æ–°ä¸ nextTick

å“åº”å¼çŠ¶æ€æ”¹å˜ä¼šå®‰æ’ä¸€æ¬¡å¼‚æ­¥ DOM æ›´æ–°ã€‚ä¿®æ”¹åç«‹å³è¯»å– DOMï¼Œæ‹¿åˆ°çš„æ˜¯â€œæ—§å€¼â€ã€‚ä½¿ç”¨ `nextTick` ç­‰å¾… DOM æ›´æ–°å®Œæˆï¼š

```vue
<template>
  <div id="container">{{ count }}</div>
</template>

<script setup>
import { ref, onMounted, nextTick } from "vue";
const count = ref(1);
let container = null;

onMounted(() => {
  container = document.getElementById("container");
  console.log("ç¬¬ä¸€æ¬¡æ‰“å°ï¼š", container.innerText);
});

setTimeout(async () => {
  count.value = 2; // ä¿®æ”¹å“åº”å¼çŠ¶æ€
  await nextTick(); // ç­‰åˆ° DOM æ›´æ–°å®Œæˆ
  console.log("ç¬¬äºŒæ¬¡æ‰“å°ï¼š", container.innerText); // æœ€æ–°å€¼
}, 2000);
</script>
```

ä¸ä½¿ç”¨ `async/await` ä¹Ÿå¯ä»¥ç”¨å›è°ƒå½¢å¼ï¼š

```js
nextTick(() => {
  // æ­¤å¤„ DOM å·²æ›´æ–°
});
```

---

## ä½¿ç”¨ reactive

`reactive` å°†ä¸€ä¸ªå¯¹è±¡è½¬ä¸ºå“åº”å¼å¯¹è±¡ï¼Œé€‚ç”¨äºåŒ…å«å¤šä¸ªå­—æ®µçš„çŠ¶æ€ï¼š

```vue
<template>
  <div>{{ state.count1 }}</div>
  <div>{{ state.nested.count2 }}</div>
  <!-- æ¨¡æ¿ä¸­ä½¿ç”¨æ— éœ€ .valueï¼Œå› ä¸º reactive è¿”å›çš„å°±æ˜¯â€œå“åº”å¼å¯¹è±¡â€ -->
</template>

<script setup>
import { reactive } from "vue";
const state = reactive({
  count1: 0,
  nested: { count2: 0 },
});

setTimeout(() => {
  state.count1++;
  state.nested.count2 += 2;
}, 2000);
</script>
```

è¯´æ˜ï¼šVue 3 çš„å“åº”å¼å¯¹å¯¹è±¡ä½¿ç”¨ `Proxy` æ‹¦æˆªï¼›åŸå§‹å€¼æ— æ³•ç”¨ `Proxy` ç›´æ¥æ‹¦æˆªï¼Œå› æ­¤ä½¿ç”¨ `ref` çš„ `.value` getter/setter æ¥è¿›è¡Œä¾èµ–æ”¶é›†å’Œè§¦å‘(æ¯”å¦‚`Object.defineProperty`)ã€‚`ref` åœ¨æŒæœ‰å¯¹è±¡å€¼æ—¶ï¼Œä¼šå°†å¯¹è±¡æ·±åº¦è½¬ä¸ºå“åº”å¼ï¼ˆç­‰ä»·äº `reactive`ï¼‰ã€‚

æµ…å“åº”å¯¹è±¡å¯ä½¿ç”¨ `shallowReactive`ï¼š

```vue
<template>
  <div>{{ state.count1 }}</div>
  <div>{{ state.nested.count2 }}</div>
</template>

<script setup>
import { shallowReactive } from "vue";
const state = shallowReactive({
  count1: 0,
  nested: { count2: 0 },
});

// ä»…é¡¶å±‚å­—æ®µå˜åŒ–ä¼šè¢«è¿½è¸ª
setTimeout(() => {
  state.count1++;
}, 2000);

// åµŒå¥—å¯¹è±¡å­—æ®µå˜åŒ–ä¸ä¼šè§¦å‘æ›´æ–°
setTimeout(() => {
  state.nested.count2++;
}, 4000);
</script>
```

---

## ä½¿ç”¨ç»†èŠ‚ä¸æœ€ä½³å®è·µ

- ä¼˜å…ˆä½¿ç”¨ `ref` ç®¡ç†çŠ¶æ€ï¼ˆç±»å‹æ¨æ–­å¥½ã€è¿ç§»çµæ´»ã€åŸå§‹å€¼ç›´æ¥å¯ç”¨ï¼‰ã€‚
- å½“çŠ¶æ€å¤©ç„¶æ˜¯â€œä¸€ä¸ªå¯¹è±¡â€ã€ä¸”éœ€è¦æŒ‰å¯¹è±¡è¯­ä¹‰ä½¿ç”¨æ—¶ä½¿ç”¨ `reactive`ï¼ˆå¦‚è¡¨å•æ¨¡å‹ï¼‰ã€‚
- é¿å…æ›¿æ¢ `reactive` å¯¹è±¡æœ¬èº«çš„å¼•ç”¨ï¼Œå¦åˆ™ä¼šä¸¢å¤±å“åº”å¼ï¼š

```js
let state = reactive({ count: 0 });
// âŒ æ›¿æ¢å¼•ç”¨ä¼šå¯¼è‡´æ—§å¯¹è±¡ä¸å†è¢«è¿½è¸ª
state = reactive({ count: 1 });
```

- æ³¨æ„è§£æ„ä¼šä¸¢å¤±å“åº”å¼ï¼š

```js
const state = reactive({ count: 0 });
let { count } = state; // è§£æ„å¾—åˆ°çš„æ˜¯æ™®é€šå€¼
count++; // ä¸ä¼šè§¦å‘å“åº”å¼æ›´æ–°

// å‡½æ•°ä¼ å‚åŒç†ï¼šä¼ å…¥çš„æ˜¯æ™®é€šå€¼
func(state.count);
```

::: important
å“åº”å¼ä¾èµ–äº Proxy å¯¹å±æ€§è®¿é—®çš„æ‹¦æˆªï¼Œè§£æ„èµ‹å€¼åˆ›å»ºäº†æ–°çš„å˜é‡ï¼Œè¿™äº›å˜é‡ä¸å†è¢«åŸå§‹å¯¹è±¡çš„ Proxy æ‰€ç®¡ç†ï¼Œå› æ­¤å¤±å»äº†å“åº”å¼èƒ½åŠ›ã€‚ä½¿ç”¨ `toRefs()` æˆ–è€… `toRef()`å¯ä»¥ä¿æŒè¿™ç§è¿æ¥ã€‚
:::

---

## ref è§£åŒ…è§„åˆ™ä¸å¸¸è§é™·é˜±

### 1) ä½œä¸º reactive å¯¹è±¡çš„å±æ€§ï¼ˆè‡ªåŠ¨è§£åŒ…ï¼‰

```vue
<script setup>
import { ref, reactive } from "vue";
const name = ref("Bill");
const state = reactive({ name });

console.log(state.name); // è‡ªåŠ¨è§£åŒ…ï¼ˆBillï¼‰
console.log(name.value); // Bill
</script>
```

### 2) ä½œä¸º shallowReactive çš„å±æ€§ï¼ˆä¸è§£åŒ…ï¼‰

```vue
<script setup>
import { ref, shallowReactive } from "vue";
const name = ref("Bill");
const state = shallowReactive({ name });

console.log(state.name.value); // ä¸ä¼šè‡ªåŠ¨è§£åŒ…
</script>
```

å˜åŒ–ä»ä¼šè¢«è¿½è¸ªï¼ˆå› ä¸ºå±æ€§æœ¬èº«æ˜¯ä¸ª `ref`ï¼‰ï¼š

```vue
<template>
  <div>{{ state.name.value }}</div>
</template>

<script setup>
import { ref, shallowReactive } from "vue";
const name = ref("Bill");
const state = shallowReactive({ name });
setTimeout(() => {
  name.value = "Tom";
}, 2000);
</script>
```

### 3) ç»ƒä¹ ï¼šå¤±å»å…³è”çš„é—®é¢˜

```vue
<template>
  <div>{{ obj.name }}</div>
</template>

<script setup>
import { ref, shallowReactive } from "vue";
const name = ref("Bill");
const obj = shallowReactive({ name });

setTimeout(() => {
  obj.name = "John"; // å°† ref å±æ€§æ›¿æ¢ä¸ºæ™®é€šå­—ç¬¦ä¸²ï¼Œå¤±å»å…³è”
}, 1000);
setTimeout(() => {
  name.value = "Smith"; // ä¸å†å½±å“ obj.name
}, 2000);
</script>
```

ç­”æ¡ˆï¼š

- `shallowReactive` å†…çš„ `ref` ä¸è‡ªåŠ¨è§£åŒ…ï¼Œå› æ­¤æ¸²æŸ“ä¼šå¸¦å¼•å·æ˜¾ç¤ºå¯¹è±¡çš„å­—ç¬¦ä¸²åŒ–ç»“æœï¼›
- 1 ç§’å `obj.name` è¢«æ›¿æ¢ä¸ºæ™®é€šå­—ç¬¦ä¸²ï¼Œä»åŸæ¥çš„ `ref` å¤±å»å…³è”ï¼Œåç»­ `name.value` æ”¹å˜ä¸ä¼šå½±å“æ¸²æŸ“ã€‚

æ­£ç¡®å†™æ³•ï¼ˆä¿æŒå…³è”ï¼‰ï¼š

```js
obj.name.value = "John";
// åç»­ä¿®æ”¹ name.value ä»ä¼šç”Ÿæ•ˆ
```

å¦ä¸€ä¸ªç¤ºä¾‹ï¼ˆåˆ‡æ¢ä¸ºå¦ä¸€ä¸ª refï¼‰ï¼š

```vue
<template>
  <div>{{ obj.name.value }}</div>
</template>

<script setup>
import { ref, shallowReactive } from "vue";
const name = ref("Bill");
const stuName = ref("John");
const obj = shallowReactive({ name });

// åˆ‡æ¢ä¸ºå¦ä¸€ä¸ª refï¼Œä¿æŒå“åº”å¼ä½†ä¸åŸ ref å¤±å»å…³è”
obj.name = stuName;

setTimeout(() => {
  name.value = "Tom"; // ä¸å½±å“ obj.name
}, 2000);
setTimeout(() => {
  stuName.value = "Smith"; // ä¼šå½±å“ obj.name
}, 4000);
</script>
```

### 4) æ•°ç»„ä¸ Map ä¸­çš„ refï¼ˆä¸è§£åŒ…ï¼‰

å½“ `ref` ä½äºå“åº”å¼æ•°ç»„æˆ–é›†åˆä¸­æ—¶ï¼Œä¸ä¼šè‡ªåŠ¨è§£åŒ…ï¼š

```js
import { ref, reactive } from "vue";

const books = reactive([ref("Vue 3 Guide")]);
console.log(books[0].value); // éœ€è¦ .value

const map = reactive(new Map([["count", ref(0)]]));
console.log(map.get("count").value); // éœ€è¦ .value
```

```vue
<script setup>
import { ref, reactive } from "vue";
const name = ref("Bill");
const score = ref(100);
const state = reactive({
  name, // å±æ€§ä¸Šçš„ refï¼ˆè‡ªåŠ¨è§£åŒ…ï¼‰
  scores: [score], // æ•°ç»„ä¸­çš„ refï¼ˆä¸è§£åŒ…ï¼‰
});
console.log(state.name); // Billï¼ˆè‡ªåŠ¨è§£åŒ…ï¼‰
console.log(state.scores[0]); // Ref å¯¹è±¡
console.log(state.scores[0].value); // 100
</script>
```

### 5) æ¨¡æ¿ä¸­çš„è‡ªåŠ¨è§£åŒ…ï¼ˆä»…é¡¶çº§ï¼‰

æ¨¡æ¿ä¸­ä»…â€œé¡¶çº§â€ `ref` ä¼šè‡ªåŠ¨è§£åŒ…ï¼š

```vue
<template>
  <div>
    <div>{{ count }}</div>
    <!-- é¡¶çº§ ref è‡ªåŠ¨è§£åŒ… -->
    <div>{{ object.id }}</div>
    <!-- éé¡¶çº§ ref è¡¨é¢çœ‹èƒ½æ¸²æŸ“ï¼Œä½†ä¸æ˜¯è§£åŒ… -->
  </div>
</template>

<script setup>
import { ref } from "vue";
const count = ref(0);
const object = { id: ref(1) }; // éé¡¶çº§ ref
</script>
```

éªŒè¯ï¼š

```vue
<template>
  <div>
    <div>{{ count + 1 }}</div>
    <!-- 1 -->
    <div>{{ object.id + 1 }}</div>
    <!-- [object Object]1 -->
    <div>{{ object.id.value + 1 }}</div>
    <!-- 2 -->
  </div>
</template>
```

---

## å°ç»“

- `ref` é€‚åˆæ‰€æœ‰ç±»å‹çš„çŠ¶æ€ï¼Œæ¨¡æ¿è‡ªåŠ¨è§£åŒ…ï¼Œè„šæœ¬éœ€ `.value`ã€‚
- `reactive` é€‚åˆå¯¹è±¡çŠ¶æ€ï¼Œè¿”å›çš„å°±æ˜¯å“åº”å¼å¯¹è±¡ï¼Œç›´æ¥è¯»å†™å­—æ®µå³å¯ã€‚
- ä½¿ç”¨æµ…å“åº”ï¼ˆ`shallowRef`/`shallowReactive`ï¼‰æ—¶ï¼Œåªæœ‰æ›¿æ¢å¼•ç”¨ä¼šè§¦å‘æ›´æ–°ï¼›å†…å±‚å­—æ®µå˜æ›´ä¸ä¼šè§¦å‘æ›´æ–°ã€‚
- DOM æ›´æ–°æ˜¯å¼‚æ­¥çš„ï¼Œç”¨ `nextTick` è·å–æ›´æ–°åçš„ DOMã€‚
- å¸¸è§é™·é˜±ï¼šæ›¿æ¢å“åº”å¼å¯¹è±¡å¼•ç”¨ã€è§£æ„å¯¼è‡´ä¸¢å¤±å“åº”å¼ã€æ•°ç»„/é›†åˆä¸­çš„ `ref` ä¸è‡ªåŠ¨è§£åŒ…ã€æ¨¡æ¿ä»…é¡¶çº§ `ref` è‡ªåŠ¨è§£åŒ…ã€‚

å»ºè®®ï¼šä¼˜å…ˆä½¿ç”¨ `ref` ä½œä¸ºçŠ¶æ€é¦–é€‰ï¼›éœ€è¦å¯¹è±¡è¯­ä¹‰æ—¶ä½¿ç”¨ `reactive`ï¼›æµ…å“åº”åªåœ¨æ˜ç¡®éœ€è¦æ§åˆ¶æ›´æ–°ç²’åº¦æ—¶ä½¿ç”¨ã€‚
