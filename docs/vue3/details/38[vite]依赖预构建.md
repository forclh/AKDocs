# ã€Viteã€‘ä¾èµ–é¢„æ„å»º ğŸ‘Œ

## ä»€ä¹ˆæ˜¯ä¾èµ–é¢„æ„å»ºï¼Ÿ

ä¸€å¥è¯æ€»ç»“ï¼šåœ¨ä½ **é¦–æ¬¡**ä½¿ç”¨ Vite å¯åŠ¨é¡¹ç›®çš„æ—¶å€™ï¼Œä¼šæŠŠä½ çš„é¡¹ç›®**ä¾èµ–**é¢„å…ˆæ„å»ºä¸€æ¬¡ã€‚

> æ€è€ƒ ğŸ¤”ï¼šå‰é¢ä¸æ˜¯è¯´ Vite ç›¸æ¯” Webpack çš„ä¼˜ç‚¹ä¸å°±æ˜¯ä¸æ‰“åŒ…ä¹ˆï¼Ÿè¿™é‡Œé¢„æ„å»ºåˆæ˜¯æ€ä¹ˆä¸€å›äº‹å„¿ï¼Ÿ

Vite åˆ©ç”¨ç°ä»£æµè§ˆå™¨å¯¹ ESM çš„æ”¯æŒè·³è¿‡æ‰“åŒ…ç¯èŠ‚ï¼Œé€šè¿‡æµè§ˆå™¨å‘é€è¯·æ±‚çš„æ–¹å¼åŠ¨æ€åŠ è½½æ¨¡å—ä¾ç„¶ä¼šå­˜åœ¨ç›¸åº”é—®é¢˜ï¼š

1. ä¾èµ–æ–‡ä»¶è¿‡å¤šï¼Œå¯¼è‡´è¯·æ±‚è¿‡å¤š
2. æŸäº›ä¾èµ–ä»ç„¶æ˜¯ä»¥ CommonJS æ ¼å¼å‘å¸ƒçš„ï¼Œå®ƒä»¬å¹¶ä¸å…¼å®¹åŸç”Ÿ ESM ç¯å¢ƒ

ä¸ºäº†è§£å†³ä¸Šé¢çš„ä¸¤ä¸ªé—®é¢˜ï¼ŒVite åœ¨ç¬¬ä¸€æ¬¡å¯åŠ¨é¡¹ç›®çš„æ—¶å€™ï¼Œä¼šé’ˆå¯¹ **ä¾èµ–** è¿›è¡Œä¸€ä¸ªé¢„æ„å»ºï¼ˆæ‰“åŒ…ï¼‰ï¼Œå‡å°‘æ–‡ä»¶çš„æ•°é‡ï¼ŒåŒæ—¶å°† CommonJS æ ¼å¼çš„ä¾èµ–è½¬æ¢ä¸º ESM æ ¼å¼ï¼Œä»¥ç¡®ä¿æµè§ˆå™¨èƒ½å¤Ÿæ­£ç¡®åŠ è½½è¿™äº›æ¨¡å—ã€‚

é¢„æ„å»ºé˜¶æ®µæ‰€ä½¿ç”¨çš„æ‰“åŒ…å·¥å…·æ˜¯ [esbuild](https://esbuild.github.io/)ï¼Œè¿™æ˜¯ä¸€ä¸ªç”¨ Go è¯­è¨€ç¼–å†™çš„æ„å»ºå·¥å…·ï¼Œæ•ˆç‡æé«˜ï¼Œ**å¤§éƒ¨åˆ†å·¥ä½œéƒ½æ˜¯å¹¶è¡Œå¤„ç†çš„**ï¼Œesbuild èƒ½å¤Ÿè¿…é€Ÿå°†ä¾èµ–è½¬æ¢ä¸ºæœ‰æ•ˆçš„ ESM æ ¼å¼ï¼Œå¹¶è¿›è¡Œæ‰“åŒ…ï¼Œä»è€Œä¼˜åŒ–ä¾èµ–ç®¡ç†å’ŒåŠ è½½æ•ˆç‡ã€‚

esbuild æ‰€åšçš„äº‹æƒ…ï¼š

1. è½¬æ¢ï¼šå°†ä¸€äº› CommonJSã€UMD æ ¼å¼çš„æ¨¡å—è½¬æ¢ä¸º ESM æ ¼å¼ã€‚
2. æ‰“åŒ…ï¼šé’ˆå¯¹**ä¾èµ–**è¿›è¡Œæ‰“åŒ…ï¼Œå‡å°‘æµè§ˆå™¨åœ¨å¼€å‘ç¯å¢ƒè¯·æ±‚çš„æ¬¡æ•°ã€‚
3. æœ€å°åŒ–å’Œå‹ç¼©ï¼šè¿™ä¸ªæ˜¯åœ¨**æ„å»ºé˜¶æ®µ**ï¼Œé’ˆå¯¹ä»£ç çš„æœ€å°åŒ–å’Œå‹ç¼©ä¹Ÿæ˜¯ esbuild æ¥åšçš„ã€‚

## ç¼“å­˜

ç¼“å­˜åˆ†ä¸ºä¸¤ç§ï¼š

1. æ–‡ä»¶ç¼“å­˜
2. æµè§ˆå™¨ç¼“å­˜

### æ–‡ä»¶ç¼“å­˜

esbuild ä¼šå¯¹**ä¾èµ–é¢„æ„å»ºçš„äº§ç‰©**è¿›è¡Œç¼“å­˜ï¼Œç¼“å­˜åˆ° node_modules/.vite ç›®å½•ä¸‹é¢ã€‚

å½“ä¸‹é¢ä»»æ„ä¸€é¡¹å‘ç”Ÿæ›´æ”¹æ—¶ï¼Œéœ€è¦é‡æ–°è¿è¡Œé¢„æ„å»º

-   åŒ…ç®¡ç†å™¨çš„é”æ–‡ä»¶å†…å®¹ï¼Œä¾‹å¦‚ package-lock.jsonï¼Œyarn.lockï¼Œpnpm-lock.yamlï¼Œæˆ–è€… bun.lockb å‘ç”Ÿäº†å˜åŒ–
-   è¡¥ä¸æ–‡ä»¶å¤¹çš„ä¿®æ”¹æ—¶é—´å‘ç”Ÿäº†å˜åŒ–
-   vite.config.js ä¸­çš„ç›¸å…³å­—æ®µå‘ç”Ÿäº†å˜åŒ–ï¼Œåœ¨é…ç½®æ–‡ä»¶ä¸­ä¹Ÿå­˜åœ¨ä¾èµ–é¢„æ„å»ºçš„ç›¸å…³é…ç½®ï¼Œä¾èµ–é¢„æ„å»ºç›¸å…³é…ç½®å‘ç”Ÿäº†å˜åŒ–ï¼Œè‡ªç„¶éœ€è¦é‡æ–°é¢„æ„å»ºã€‚
-   NODE_ENV çš„å€¼å˜åŠ¨

### æµè§ˆå™¨ç¼“å­˜

å¦å¤–ï¼Œå·²é¢„æ„å»ºçš„ä¾èµ–ï¼Œ**åœ¨æµè§ˆå™¨ç«¯ä¹Ÿä¼šå­˜åœ¨ç¼“å­˜**ã€‚ä¼šä½¿ç”¨ HTTP å¤´ max-age=31536000, immutable è¿›è¡Œ**å¼ºç¼“å­˜**ï¼Œä»¥æé«˜å¼€å‘æœŸé—´é¡µé¢é‡æ–°åŠ è½½çš„æ€§èƒ½ã€‚ä¸€æ—¦è¢«ç¼“å­˜ï¼Œè¿™äº›è¯·æ±‚å°†æ°¸è¿œä¸ä¼šå†æ¬¡è®¿é—®å¼€å‘æœåŠ¡å™¨ã€‚

å¦‚æœå®‰è£…äº†ä¸åŒç‰ˆæœ¬çš„ä¾èµ–é¡¹ï¼ˆè¿™åæ˜ åœ¨åŒ…ç®¡ç†å™¨çš„ lockfile ä¸­ï¼‰ï¼Œåˆ™ä¼šé€šè¿‡é™„åŠ ç‰ˆæœ¬æŸ¥è¯¢æŠŠä¹‹å‰çš„å¼ºç¼“å­˜è‡ªåŠ¨å¤±æ•ˆã€‚

ä¾‹å¦‚ï¼šå½“å‰é¡¹ç›®ä½¿ç”¨äº† lodashï¼Œå½“å‰ç‰ˆæœ¬ä¸º 4.17.19

```
http://localhost:3000/node_modules/.vite/lodash.js?v=4.17.19
```

å‘é€è¯·æ±‚åæµè§ˆå™¨ä¼šè¿›è¡Œç¼“å­˜ã€‚

ä¹‹åå¯¹ lodash ç‰ˆæœ¬å‡çº§ï¼Œå‡çº§åˆ° 4.17.20ï¼Œé”æ–‡ä»¶å†…å®¹å˜åŒ–ä¼šå¯¼è‡´é‡æ–°é¢„æ„å»ºï¼Œè¯·æ±‚ URL å°±ä¼šå‘ç”Ÿå˜åŒ–

```
http://localhost:3000/node_modules/.vite/lodash.js?v=4.17.20
```

URL å‘ç”Ÿå˜åŒ–åï¼Œæµè§ˆå™¨å°±ä¼šå‘ç”Ÿæ–°çš„è¯·æ±‚åˆ°å¼€å‘æœåŠ¡å™¨ï¼Œè€Œä¸å†ä½¿ç”¨æ—§çš„ç¼“å­˜ã€‚

> ç‚¹å‡»å¯ä»¥æŸ¥çœ‹æ›´å¤šå…³äº[æµè§ˆå™¨ç¼“å­˜](/interview/browser/06æµè§ˆå™¨ç¼“å­˜.md)çš„ç›¸å…³å†…å®¹ã€‚

## è‡ªå®šä¹‰é¢„æ„å»ºè¡Œä¸º

åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œé€šè¿‡ optimizeDeps å¯¹é¢„æ„å»ºè¡Œä¸ºè¿›è¡Œé…ç½®ã€‚ä¸€ä¸ªåŸºæœ¬çš„æ ¼å¼ï¼š

```js
// vite.config.js
import { defineConfig } from "vite";

export default defineConfig({
    optimizeDeps: {
        // å…¶ä»–çš„é…ç½®
    },
});
```

### 1. entries

é»˜è®¤æƒ…å†µä¸‹ï¼Œ**Vite ä¼šæŠ“å– index.html æ¥æ£€æµ‹éœ€è¦é¢„æ„å»ºçš„ä¾èµ–é¡¹**ï¼ˆå¿½ç•¥ node_modulesã€build.outDirã€**tests** å’Œ coverageï¼‰ã€‚**å¦‚æœæŒ‡å®šäº† build.rollupOptions.inputï¼ŒVite å°†è½¬è€Œå»æŠ“å–è¿™äº›å…¥å£ç‚¹**ã€‚

å¦‚æœè¿™ä¸¤è€…éƒ½ä¸åˆæ„ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ **entries é€‰é¡¹**æŒ‡å®šè‡ªå®šä¹‰æ¡ç›®ï¼Œåœ¨ Vite ä¸­æ˜ç¡®æŒ‡å®šåº”å½“è¢«é¢„æ„å»ºçš„**ä¾èµ–å…¥å£**ã€‚

**ç¤ºä¾‹ 1ï¼šåŸºæœ¬ç”¨æ³•**

```
my-project/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.js         // ä¸»å…¥å£æ–‡ä»¶
â”‚   â”œâ”€â”€ admin.js        // ç®¡ç†å‘˜å…¥å£æ–‡ä»¶
â”‚   â””â”€â”€ vendor/
â”‚       â””â”€â”€ custom.js   // è‡ªå®šä¹‰åº“
â”œâ”€â”€ index.html
â””â”€â”€ vite.config.js
```

é…ç½®å¦‚ä¸‹ï¼š

```js
// vite.config.js
import { defineConfig } from "vite";

export default defineConfig({
    optimizeDeps: {
        entries: ["src/main.js", "src/admin.js"], // æ˜¾å¼æŒ‡å®šå…¥å£æ–‡ä»¶
    },
});
```

**ç¤ºä¾‹ 2ï¼šä½¿ç”¨ glob æ¨¡å¼**

[glob æ¨¡å¼ä»‹ç»](https://juejin.cn/post/6844904077801816077)

```js
// vite.config.js
import { defineConfig } from 'vite';

export.default defineConfig({
  optimizeDeps: {
    // viteä¼šæ‰«æsrcç›®å½•ä¸‹é¢çš„æ‰€æœ‰çš„.jsæ–‡ä»¶ï¼Œä¹‹åä¼šå°†è¿™äº›æ–‡ä»¶å¼•ç”¨çš„ä¾èµ–åšä¸€ä¸ªé¢„æ„å»ºå¤„ç†
    entries: ['src/**/*.js']  // ä½¿ç”¨ glob æ¨¡å¼åŒ¹é…æ‰€æœ‰ JS æ–‡ä»¶
  }
});
```

**ç¤ºä¾‹ 3ï¼šå¿½ç•¥ç‰¹å®šç›®å½•**

```js
// vite.config.js
import { defineConfig } from "vite";

export default defineConfig({
    optimizeDeps: {
        entries: [
            "src/**/*.js", // åŒ¹é…æ‰€æœ‰ JS æ–‡ä»¶
            "!src/experimental/**/*.js", // ä½†å¿½ç•¥ experimental ç›®å½•
        ],
    },
});
```

### 2. include å’Œ exclude

include ç”¨äºåŒ…å«æŸä¸ªåŒ…ï¼Œexclude ç”¨äºæ’é™¤æŸä¸ªåŒ…ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼Œé¢„æ„å»ºä¸»è¦æ˜¯é’ˆå¯¹ä¾èµ–ï¼Œä¹Ÿå°±æ˜¯ node_modules ä¸‹é¢çš„åŒ…ã€‚å¯ä»¥é€šè¿‡ include é€‰é¡¹æ¥åŒ…å«ç‰¹å®šçš„åŒ…ï¼Œæˆ–è€…é€šè¿‡ exclude é€‰é¡¹æ¥æ’é™¤ç‰¹å®šçš„åŒ…ã€‚

```js
export default defineConfig({
    optimizeDeps: {
        include: ["my-lib/components/**/*.vue"],
    },
});
```

### 3. esbuildOptions

Vite ä½¿ç”¨ esbuild æ¥é¢„æ„å»ºé¡¹ç›®ä¾èµ–ï¼Œä»¥æé«˜å¼€å‘æœåŠ¡å™¨çš„å¯åŠ¨é€Ÿåº¦å’Œæ•´ä½“æ„å»ºæ€§èƒ½ã€‚

åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼ŒVite çš„é»˜è®¤è®¾ç½®å·²ç»è¶³å¤Ÿé«˜æ•ˆã€‚ç„¶è€Œï¼Œæœ‰æ—¶å¯èƒ½éœ€è¦å¯¹ [esbuild](https://esbuild.github.io/) çš„è¡Œä¸ºè¿›è¡Œç‰¹å®šçš„è°ƒæ•´ï¼Œä¾‹å¦‚ï¼Œæ›´æ”¹æºæ˜ å°„ç”Ÿæˆã€å®šä¹‰å®æ›¿æ¢ç­‰ï¼Œä»¥é€‚åº”ç‰¹å®šçš„é¡¹ç›®éœ€æ±‚æˆ–è§£å†³å…¼å®¹æ€§é—®é¢˜ã€‚

**ç¤ºä¾‹ 1ï¼šè‡ªå®šä¹‰æºæ˜ å°„**

```js
// vite.config.js
import { defineConfig } from "vite";

export default defineConfig({
    optimizeDeps: {
        esbuildOptions: {
            sourcemap: "inline", // å°†æºæ˜ å°„ç›´æ¥åµŒå…¥åˆ°è¾“å‡ºæ–‡ä»¶ä¸­
        },
    },
});
```

**ç¤ºä¾‹ 2ï¼šä½¿ç”¨å®æ›¿æ¢**

```js
// vite.config.js
import { defineConfig } from "vite";

export default defineConfig({
    optimizeDeps: {
        esbuildOptions: {
            define: {
                // å®šä¹‰å…¨å±€å˜é‡
                "process.env.NODE_ENV": '"production"',
                __VERSION__: '"1.0.0"',
            },
        },
    },
});
```

**ç¤ºä¾‹ 3ï¼šè°ƒæ•´ç›®æ ‡ JavaScript ç‰ˆæœ¬**

```js
// vite.config.js
import { defineConfig } from "vite";

export default defineConfig({
    optimizeDeps: {
        esbuildOptions: {
            // esbuildåœ¨å¯¹ä¾èµ–è¿›è¡Œé¢„æ„å»ºçš„æ—¶å€™ï¼Œä¼šå°†å…¶ç¼–è¯‘ä¸ºES2015å…¼å®¹çš„ä»£ç 
            target: "es2015",
        },
    },
});
```

### 4. force

è®¾ç½®ä¸º true å¯ä»¥**å¼ºåˆ¶ä¾èµ–é¢„æ„å»º**ï¼Œè€Œå¿½ç•¥ä¹‹å‰å·²ç»ç¼“å­˜è¿‡çš„ã€å·²ç»ä¼˜åŒ–è¿‡çš„ä¾èµ–ã€‚
