# âœ¨ æ¨¡æ¿çš„æœ¬è´¨ ğŸ‘Œ

[[TOC]]

::: tip è¦ç‚¹é€Ÿè§ˆ

- æ¨¡æ¿æœ€ç»ˆä¼šè¢«ç¼–è¯‘ä¸ºâ€œæ¸²æŸ“å‡½æ•°â€ï¼Œæ¸²æŸ“å‡½æ•°è¿”å›è™šæ‹Ÿ DOMï¼ˆVNodeï¼‰ã€‚
- Vue è¿è¡Œæ—¶ä¸éœ€è¦æ¨¡æ¿æœ¬èº«ï¼›åªéœ€è¦æ¸²æŸ“å‡½æ•°æ¥æè¿° UI ç»“æ„ã€‚
- åŒä¸€è§†å›¾å¯ç”¨â€œæ¨¡æ¿â€æˆ–â€œçº¯ JS æ¸²æŸ“å‡½æ•°ï¼ˆhï¼‰/JSXâ€æ¥ä¹¦å†™ã€‚
- ç¼–è¯‘ç®¡çº¿ï¼šè§£æï¼ˆParseï¼‰â†’ è½¬æ¢ï¼ˆTransformï¼‰â†’ ç”Ÿæˆï¼ˆCodegenï¼‰ã€‚
- ç¼–è¯‘æ—¶æœºåˆ†ä¸ºè¿è¡Œæ—¶ç¼–è¯‘ï¼ˆCDN åœºæ™¯ï¼‰ä¸é¢„ç¼–è¯‘ï¼ˆå·¥ç¨‹åŒ–æ‰“åŒ…ï¼‰ã€‚
  :::

## å¿«é€Ÿä¸Šæ‰‹

ä¸‹é¢ç”¨ä¸€ä¸ªæœ€å°ç¤ºä¾‹ç›´è§‚ç†è§£â€œåŒä¸€è§†å›¾ç»“æ„â€ï¼Œåˆ†åˆ«ç”¨æ¨¡æ¿ä¸æ¸²æŸ“å‡½æ•°æ¥æè¿°ï¼š

```vue :collapsed-lines
<!-- æ¨¡æ¿æ–¹å¼ï¼šUserCard.vue -->
<template>
  <div class="user-card">
    <img :src="avatarUrl" alt="User avatar" class="avatar" />
    <div class="user-info">
      <h2>{{ name }}</h2>
      <p>{{ email }}</p>
    </div>
  </div>
</template>

<script setup>
defineProps({ name: String, email: String, avatarUrl: String });
</script>

<style scoped>
.user-card {
  display: flex;
  align-items: center;
  background-color: #f9f9f9;
  border: 1px solid #e0e0e0;
  border-radius: 10px;
  padding: 10px;
  margin: 10px 0;
}
.avatar {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  margin-right: 15px;
}
.user-info h2 {
  margin: 0;
  font-size: 20px;
  color: #333;
}
.user-info p {
  margin: 5px 0 0;
  font-size: 16px;
  color: #666;
}
</style>
```

```js
// çº¯ JS æ¸²æŸ“å‡½æ•°ï¼šç­‰ä»·è§†å›¾ï¼ˆh è¿”å› vnodeï¼‰
import { defineComponent, h } from "vue";
import styles from "./UserCard.module.css";

export default defineComponent({
  name: "UserCardRender",
  props: { name: String, email: String, avatarUrl: String },
  setup(props) {
    return () =>
      h("div", { class: styles.userCard }, [
        h("img", {
          class: styles.avatar,
          src: props.avatarUrl,
          alt: "User avatar",
        }),
        h("div", { class: styles.userInfo }, [
          h("h2", props.name),
          h("p", props.email),
        ]),
      ]);
  },
});
```

```css
/* UserCard.module.css */
.userCard {
  display: flex;
  align-items: center;
  background-color: #f9f9f9;
  border: 1px solid #e0e0e0;
  border-radius: 10px;
  padding: 10px;
  margin: 10px 0;
}
.avatar {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  margin-right: 15px;
}
.userInfo h2 {
  margin: 0;
  font-size: 20px;
  color: #333;
}
.userInfo p {
  margin: 5px 0 0;
  font-size: 16px;
  color: #666;
}
```

::: warning å…³é”®è®¤è¯†

- æ¸²æŸ“å‡½æ•° `h()` è¿”å›çš„æ˜¯è™šæ‹Ÿ DOMï¼ˆæ™®é€š JS å¯¹è±¡ï¼‰ï¼Œä¸æ˜¯ç›´æ¥åˆ›å»ºçœŸå® DOMã€‚
- æ¨¡æ¿åªæ˜¯æ›´æ˜“è¯»çš„â€œå£°æ˜å¼è¯­æ³•ç³–â€ï¼›æœ€ç»ˆéƒ½ä¼šå˜æˆæ¸²æŸ“å‡½æ•°ä¾›è¿è¡Œæ—¶è°ƒç”¨ã€‚
  :::

## æ ¸å¿ƒæ¦‚å¿µ

### æ¸²æŸ“å‡½æ•°ä¸ VNode

- æ¸²æŸ“å‡½æ•°æ˜¯â€œç”¨ JS æè¿° UI çš„å‡½æ•°â€ï¼Œè¿”å› vnodeï¼ˆè™šæ‹Ÿ DOMï¼‰ã€‚
- vnode æ˜¯æ™®é€šå¯¹è±¡ï¼ˆ`type/props/children` ç­‰ï¼‰ï¼Œæ¡†æ¶æ®æ­¤è®¡ç®—æ›´æ–°å¹¶æ‰“è¡¥ä¸åˆ°çœŸå® DOMã€‚

```js
import { h } from "vue";
const vnode = h("div", { class: "box" }, [h("span", null, "Hello")]);
console.log(vnode);
// { type: 'div', props: { class: 'box' }, children: [ { type: 'span', children: 'Hello' } ] }
```

### æ¨¡æ¿å¦‚ä½•è¢«ç¼–è¯‘

**å•æ–‡ä»¶ç»„ä»¶ä¸­çš„æ¨¡æ¿ï¼Œæœ¬è´¨æ˜¯å­—ç¬¦ä¸²ï¼Œç¼–è¯‘å™¨ä¼šæŠŠå®ƒç¼–è¯‘ä¸ºæ¸²æŸ“å‡½æ•°ã€‚**

æ¨¡æ¿ï¼š

```html
<template>
  <div>
    <h1 :id="someId">Hello</h1>
  </div>
</template>
```

ç¼–è¯‘å™¨è§†è§’ï¼šåªæ˜¯å­—ç¬¦ä¸²ï¼Œéœ€è¦ç¼–è¯‘ä¸ºå¯æ‰§è¡Œçš„æ¸²æŸ“å‡½æ•°ä»£ç ï¼š

```js
function render() {
  return h("div", [h("h1", { id: someId }, "Hello")]);
}
```

::: tip ç¼–è¯‘ç®¡çº¿ï¼ˆç®€ç‰ˆï¼‰
![](https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2023-11-13-015532.png)

- è§£æï¼ˆParserï¼‰ï¼šå°†æ¨¡æ¿å­—ç¬¦ä¸²è§£æä¸ºæ¨¡æ¿ ASTï¼ˆæŠ½è±¡è¯­æ³•æ ‘ï¼‰ã€‚
- è½¬æ¢ï¼ˆTransformï¼‰ï¼šå°†æ¨¡æ¿ AST è½¬æ¢ä¸º JS ASTã€‚
- ç”Ÿæˆï¼ˆCodegenï¼‰ï¼šå°† JS AST ç”Ÿæˆæœ€ç»ˆçš„æ¸²æŸ“å‡½æ•°ä»£ç ã€‚
  :::

ç¤ºä¾‹ï¼š

```html
<div>
  <p>Vue</p>
  <p>React</p>
</div>
```

è§£æå¾—åˆ°çš„ tokensï¼ˆç¤ºæ„ï¼‰ï¼š

```js
[
  { type: "tag", name: "div" },
  { type: "tag", name: "p" },
  { type: "text", content: "Vue" },
  { type: "tagEnd", name: "p" },
  { type: "tag", name: "p" },
  { type: "text", content: "React" },
  { type: "tagEnd", name: "p" },
  { type: "tagEnd", name: "div" },
];
```

è½¬æ¢å¾—åˆ°çš„ JS ASTï¼ˆç¤ºæ„ï¼‰ï¼š

```js
{
  type: "FunctionDecl",
  id: { type: "Identifier", name: "render" },
  params: [],
  body: [
    {
      type: "ReturnStatement",
      return: {
        type: "CallExpression",
        callee: { type: "Identifier", name: "h" },
        arguments: [
          { type: "StringLiteral", value: "div" },
          {
            type: "ArrayExpression",
            elements: [
              { type: "CallExpression", callee: { type: "Identifier", name: "h" }, arguments: [{ type: "StringLiteral", value: "p" }, { type: "StringLiteral", value: "Vue" }] },
              { type: "CallExpression", callee: { type: "Identifier", name: "h" }, arguments: [{ type: "StringLiteral", value: "p" }, { type: "StringLiteral", value: "React" }] },
            ],
          },
        ],
      },
    },
  ],
}
```

ç”Ÿæˆæœ€ç»ˆæ¸²æŸ“å‡½æ•°ï¼š

```js
function render() {
  return h("div", [h("p", "Vue"), h("p", "React")]);
}
```

ç¼–è¯‘å™¨æ•´ä½“ç»“æ„ï¼ˆç¤ºä¾‹ä¼ªç ï¼‰ï¼š

```js
function compile(template) {
  const ast = parse(template); // 1. è§£æå™¨
  transform(ast); // 2. è½¬æ¢å™¨ï¼šæ¨¡æ¿ AST â†’ JS AST
  const code = generate(ast); // 3. ç”Ÿæˆå™¨
  return code;
}
```

## æ¨¡æ¿ç¼–è¯‘çš„æ—¶æœº

æ•´ä½“åˆ†ä¸¤ç±»åœºæ™¯ï¼š

::: info è¿è¡Œæ—¶ç¼–è¯‘ï¼ˆCDN åœºæ™¯ï¼‰

- ç›´æ¥é€šè¿‡ CDN å¼•å…¥ Vueï¼Œç»„ä»¶çš„ `template` ä¼šåœ¨è¿è¡Œæ—¶è¢«ç¼–è¯‘ã€‚
- é€‚ç”¨äºå¿«é€ŸåŸå‹æˆ–åœ¨çº¿ç¤ºä¾‹ï¼Œçœå»æ„å»ºæ­¥éª¤ï¼Œä½†è¿è¡Œæ—¶ä½“ç§¯æ›´å¤§ã€æ€§èƒ½ç•¥æœ‰å¼€é”€ã€‚
  :::

ç¤ºä¾‹ï¼š

```html :collapsed-lines
<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Runtime Compile</title>
  </head>
  <body>
    <div id="app">
      <user-card :name="name" :email="email" :avatar-url="avatarUrl" />
    </div>

    <template id="user-card-template">
      <div class="user-card">
        <img :src="avatarUrl" alt="User avatar" class="avatar" />
        <div class="user-info">
          <h2>{{ name }}</h2>
          <p>{{ email }}</p>
        </div>
      </div>
    </template>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script>
      const { createApp } = Vue;
      const UserCard = {
        name: "UserCard",
        props: { name: String, email: String, avatarUrl: String },
        template: "#user-card-template",
      };

      createApp({
        components: { UserCard },
        data: () => ({
          name: "John",
          email: "john@example",
          avatarUrl: "./yinshi.jpg",
        }),
      }).mount("#app");
    </script>
  </body>
</html>
```

::: tip é¢„ç¼–è¯‘ï¼ˆå·¥ç¨‹åŒ–åœºæ™¯ï¼‰

- åœ¨æ„å»ºé˜¶æ®µï¼ˆå¦‚ Viteï¼‰ï¼Œæ¨¡æ¿ä¼šè¢«ç¼–è¯‘ä¸ºæ¸²æŸ“å‡½æ•°ï¼Œæµè§ˆå™¨æ‹¿åˆ°çš„äº§ç‰©ä¸­ä¸å†åŒ…å«æ¨¡æ¿ã€‚
- å¥½å¤„ï¼šæ›´å°çš„è¿è¡Œæ—¶ã€æ›´å¿«çš„åŠ è½½ã€æ›´å¥½çš„æ€§èƒ½ä¸å¯ä¼˜åŒ–ç©ºé—´ã€‚
  :::

è¾…åŠ©å·¥å…·ï¼ˆæŸ¥çœ‹ç¼–è¯‘ç»“æœï¼‰ï¼š

```js
// vite.config.ts / vite.config.js
import Inspect from "vite-plugin-inspect";
export default { plugins: [Inspect()] };
// è¿è¡Œåè®¿é—® http://localhost:5173/__inspect/ æŸ¥çœ‹æ¯ä¸ªç»„ä»¶çš„ç¼–è¯‘äº§ç‰©
```

## æ¨¡æ¿ vs æ¸²æŸ“å‡½æ•°ï¼šä½•æ—¶é€‰æ‹©ï¼Ÿ

::: warning é€‰æ‹©å»ºè®®

- æ—¥å¸¸ä¸šåŠ¡ç»„ä»¶ï¼šæ¨¡æ¿å¯è¯»æ€§æ›´å¥½ã€å›¢é˜Ÿå¿ƒæ™ºè´Ÿæ‹…æ›´ä½ï¼Œä¼˜å…ˆä½¿ç”¨æ¨¡æ¿ã€‚
- é«˜åº¦åŠ¨æ€çš„ç»“æ„æ‹¼è£…ã€å¯è§†åŒ–åº“/æ¸²æŸ“å™¨ã€æŒ‡ä»¤å¼åˆ›å»ºå¤æ‚æ ‘æ—¶ï¼šè€ƒè™‘ `h()`/JSXã€‚
- éœ€è¦ç²¾ç»†æ§åˆ¶ vnodeã€åŠ¨æ€ slot/props åˆæˆã€æŒ‰æ¡ä»¶æ‰¹é‡ç”ŸæˆèŠ‚ç‚¹ï¼š`h()`/JSX æ›´çµæ´»ã€‚
  :::

å¯¹æ¯”ç¤ºä¾‹ï¼ˆåŒä¸€ UIï¼Œæ¨¡æ¿æ›´æ˜“è¯»ï¼Œæ¸²æŸ“å‡½æ•°æ›´çµæ´»ï¼‰ï¼š

```vue :collapsed-lines
<template>
  <ul>
    <li v-for="item in items" :key="item.id">{{ item.label }}</li>
  </ul>
</template>

<script setup>
defineProps({ items: Array });
</script>
```

```js
import { h } from "vue";
export default {
  props: { items: Array },
  render() {
    return h(
      "ul",
      this.items.map((item) => h("li", { key: item.id }, item.label))
    );
  },
};
```

## å¸¸è§è¯¯åŒº

::: danger æ˜“é”™ç‚¹

- è¯¯ä»¥ä¸ºâ€œæµè§ˆå™¨ä¿ç•™æ¨¡æ¿å¹¶ç›´æ¥æ‰§è¡Œâ€ï¼šå®é™…ä¸Šè¿è¡Œæ—¶æ‰§è¡Œçš„æ˜¯æ¸²æŸ“å‡½æ•°ã€‚
- è¯¯æŠŠ `h()` å½“ä½œâ€œåˆ›å»ºçœŸå® DOMâ€ï¼šå®ƒè¿”å›çš„æ˜¯ vnodeï¼Œç”±æ¡†æ¶è´Ÿè´£è½åœ°åˆ°çœŸå® DOMã€‚
- è®¤ä¸ºâ€œæ¸²æŸ“å‡½æ•°ä¸€å®šæ›´å¿«â€ï¼šæ€§èƒ½å·®å¼‚å–å†³äºåœºæ™¯ä¸ç¼–è¯‘ä¼˜åŒ–ï¼Œæ¨¡æ¿ç»é¢„ç¼–è¯‘é€šå¸¸è¡¨ç°å¾ˆå¥½ã€‚
- å¿½è§†ç¼–è¯‘ç®¡çº¿ï¼šä¸äº†è§£ Parse/Transform/Codegen ä¼šå½±å“å¯¹ç¼–è¯‘ä¼˜åŒ–ä¸ä½“ç§¯çš„åˆ¤æ–­ã€‚
  :::

## å°ç»“ä¸åç»­

1. **æ¨¡æ¿æ˜¯å£°æ˜å¼è¯­æ³•ç³–ï¼Œæœ€ç»ˆéƒ½ä¼šç¼–è¯‘ä¸ºæ¸²æŸ“å‡½æ•°ï¼Œè¿”å› vnode ä»¥é©±åŠ¨æ›´æ–°ã€‚**
2. è¿è¡Œæ—¶ä¸éœ€è¦æ¨¡æ¿æœ¬èº«ï¼›é€‰æ‹©æ¨¡æ¿æˆ–æ¸²æŸ“å‡½æ•°åº”åŸºäºå›¢é˜Ÿå¯è¯»æ€§ä¸åœºæ™¯éœ€æ±‚ã€‚
3. å·¥ç¨‹åŒ–ä¸‹çš„é¢„ç¼–è¯‘è®©è¿è¡Œæ—¶æ›´è½»ã€æ›´å¿«ï¼Œå¯ç»“åˆ `vite-plugin-inspect` è§‚å¯Ÿäº§ç‰©ã€‚
