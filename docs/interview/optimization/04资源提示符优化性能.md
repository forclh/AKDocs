# 浏览器资源提示符优化性能

[[TOC]]

::: tip 要点速览

- 资源提示符分两类维度：服务场景（当前/未来）与操作深度（解析域名/建立连接/下载资源）。
- `dns-prefetch`（未来/浅）只解析域名；`preconnect`（当前/中）提前建好连接；
- `preload`（当前/深）强制下载关键资源但不执行；`prefetch`（未来/深）空闲时下载未来资源。
- 选择依据：先判“当前还是未来”，再判“提前到哪一步”，避免过度优化浪费连接与带宽。
  :::

## 快速上手

用最小 HTML 示例对比四种提示符的目的与时机：

```html :collapsed-lines
<!DOCTYPE html>
<html>
  <head>
    <!-- 仅提前解析域名：开销极小，适合未来可能使用的第三方域名 -->
    <link rel="dns-prefetch" href="//analytics.example.com" />

    <!-- 提前建立连接通道：DNS+TCP+TLS，适合当前页面快速访问的关键域名 -->
    <link rel="preconnect" href="https://cdn.example.com" crossorigin />

    <!-- 强制下载当前关键资源（不执行）：需正确设置 as，避免优先级错配 -->
    <link rel="preload" href="/assets/hero.jpg" as="image" />
    <link
      rel="preload"
      href="/fonts/inter.woff2"
      as="font"
      type="font/woff2"
      crossorigin
    />

    <!-- 空闲时下载未来可能用到的资源：最低优先级，不影响当前页面 -->
    <link rel="prefetch" href="/next/page.chunk.js" as="script" />
  </head>
  <body>
    <h1>资源提示符示例</h1>
  </body>
</html>
```

::: warning 正确心智模型

- 不要把四种提示符混用或“全加”：它们服务不同场景、不同深度；过度使用会浪费连接数与带宽。
- `preload` 仅下载不执行；真正使用仍需对应的 `<script src>`、`<img src>` 或 CSS/JS 引用触发。
- 对第三方域名建议先 `dns-prefetch`，明确且临近使用再 `preconnect`；当前页面的关键资源用 `preload`。
  :::

## 二、面试考察重点与常见误区

### （一）核心考察点

浏览器资源提示符（DNSPREFETCH、Preconnect、PRELOAD、PREFETCH）是前端性能优化面试必考题，面试官并非考察“是否背诵定义”，而是关注两点：

1. 对**浏览器资源加载生命周期**的理解；
2. 在**复杂业务场景中权衡性能的能力**（即“该用哪个、为什么用”）。

### （二）常见误区

- 误区 1：将四种提示符混为一谈，仅知道“都用 link 标签优化加载”，无法区分差异；
- 误区 2：只熟悉 PRELOAD，忽略其他三种提示符的适用场景，导致优化方案单一。

## 三、理解资源提示符的两个核心维度

区分四种提示符的关键，在于从“时机”和“深度”两个维度判断，这是选择优化方案的底层逻辑：
| 维度 | 核心问题 | 作用 |
| ---- | ---- | ---- |
| **时机** | 资源是为「当前页面」服务，还是为「未来可能访问的页面」服务？ | 决定优化的“目标场景”（解决当下问题还是提前铺垫） |
| **深度** | 希望浏览器提前完成的操作到哪一步？（仅解析域名 → 建立连接 → 下载资源） | 决定优化的“操作程度”（避免资源浪费，平衡性能收益） |

## 四、四种资源提示符详解（附对比）

四种提示符均通过`<link>`标签实现，但定位、作用、场景完全不同，具体如下：

### 1. DNSPREFETCH：提前解析域名（浅度优化，服务未来）

- **核心作用**：仅提前完成指定域名的 DNS 解析（将域名转换为 IP 地址），不进行后续连接或下载，操作开销极小。
- **适用场景**：页面需用到「非关键第三方域名」，且该域名的请求可能在后续触发（服务未来），例如：
  - 数据分析脚本域名（如埋点工具域名）；
  - 社交插件域名（如分享按钮对应的域名）。
- **使用示例**：
  ```html
  <link rel="dns-prefetch" href="//example.com" />
  ```
- **关键特点**：操作最浅、开销最小，仅针对“未来可能用到的域名”。

### 2. Preconnect：提前建立连接（中度优化，服务当前）

- **核心作用**：比 DNSPREFETCH 更进一步，完成“DNS 解析 → TCP 握手 → TLS 协商”全流程，建立完整的安全连接通道。后续请求该域名资源时，可直接发送请求，省去几百毫秒连接时间。
- **适用场景**：确定「很快会用到且对当前页面关键的第三方域名」，例如：
  - 字体库核心 API 域名（如 Google Fonts 域名）；
  - 核心资源 CDN 域名（如页面主图、关键 JS 的 CDN 域名）。
- **使用示例**：
  ```html
  <link rel="preconnect" href="//cdn.example.com" />
  ```
- **关键提醒**：建立连接有资源开销（占用 TCP 连接数），不可滥用，仅针对“当前页面必须用的关键域名”。

### 3. PRELOAD：强制预加载当前关键资源（深度优化，服务当前）

- **核心作用**：强制性告知浏览器“该资源对当前页面至关重要”，以**最高优先级**立即下载，但下载后暂不执行/解析，等待后续需要时使用。
- **解决的问题**：针对“隐藏较深但关键的资源”（浏览器默认不会提前发现），例如：
  - CSS 中通过`@font-face`引入的字体文件（浏览器解析 CSS 后才会触发下载，用 PRELOAD 可提前到 HTML 解析时下载）；
  - LCP（最大内容绘制）元素对应的大图（如首页 Banner 图，提前下载可优化 LCP 指标）。
- **使用要求**：必须设置`as`属性，告知浏览器资源类型（如`as="font"`、`as="image"`），帮助浏览器正确设置请求优先级，避免资源错配。
- **使用示例**：
  ```html
  <link
    rel="preload"
    href="critical-font.woff2"
    as="font"
    type="font/woff2"
    crossorigin
  />
  ```
- **关键特点**：强制下载、高优先级，仅用于“当前页面必须的关键资源”，不执行仅缓存。

### 4. PREFETCH：空闲时预加载未来资源（深度优化，服务未来）

- **核心作用**：告知浏览器“当前页面用不上，但用户可能访问下一个页面时用到”，浏览器会在**空闲时间**以**最低优先级**下载资源并缓存，提升下一页加载速度。
- **适用场景**：可预判用户行为，提前加载“未来页面资源”，例如：
  - 列表页第一页预加载第二页的图片/JS（用户大概率会点击“下一页”）；
  - 单页应用中，用户鼠标悬停在导航链接时，预加载对应路由的组件 JS。
- **使用示例**：
  ```html
  <link rel="prefetch" href="next-page-script.js" as="script" />
  ```
- **关键特点**：空闲下载、低优先级，不影响当前页面性能，仅针对“未来可能用到的资源”。

### 四种提示符核心差异对比表

| 提示符      | 核心操作                       | 服务场景 | 优先级 | 关键特点                 | 典型使用场景               |
| ----------- | ------------------------------ | -------- | ------ | ------------------------ | -------------------------- |
| DNSPREFETCH | DNS 解析                       | 未来页面 | 低     | 操作浅、开销小           | 非关键第三方域名（如统计） |
| Preconnect  | DNS 解析 + TCP 握手 + TLS 协商 | 当前页面 | 中     | 建立连接、省连接时间     | 关键 CDN/字体域名          |
| PRELOAD     | 下载关键资源（不执行）         | 当前页面 | 高     | 强制下载、必须设 as 属性 | LCP 大图、CSS 中的字体     |
| PREFETCH    | 下载未来资源（空闲时）         | 未来页面 | 最低   | 不影响当前性能           | 列表页下一页资源           |

::: tip 场景选型建议（速查）

- 当前页面：
  - 域名会立即用到 → `preconnect`（关键 CDN/字体域名，注意 `crossorigin`）。
  - 关键资源浏览器难以提前发现 → `preload`（LCP 大图、CSS 内字体）。
- 未来页面：
  - 仅需降低未来解析延迟 → `dns-prefetch`（非关键第三方域名）。
  - 希望提升下一页加载速度 → `prefetch`（路由组件、下一页图片）。
    :::

## 五、选择逻辑与面试回答框架

## 五、选择逻辑与面试回答框架

### （一）选择逻辑（两步法）

1. **第一步：判断服务场景**

   - 若资源为「当前页面必须用」→ 进入“当前页面优化”（Preconnect/PRELOAD）；
   - 若资源为「未来页面可能用」→ 进入“未来页面优化”（DNSPREFETCH/PREFETCH）。

2. **第二步：判断操作深度**
   - 服务当前页面：
     - 仅需“提前连接域名”→ 用 Preconnect；
     - 需“提前下载资源”→ 用 PRELOAD；
   - 服务未来页面：
     - 仅需“提前解析域名”→ 用 DNSPREFETCH；
     - 需“提前下载资源”→ 用 PREFETCH。

### （二）面试回答示例（以“如何选择资源提示符”为例）

当面试官问“DNSPREFETCH、Preconnect、PRELOAD、PREFETCH 怎么区分使用？”时，可按以下框架回答：

“我会从‘服务场景’和‘操作深度’两个维度判断：  
首先看资源是给当前页面用，还是未来页面用。如果是当前页面的关键资源，需要快速加载：如果只是需要提前建立域名连接，就用 Preconnect（比如核心 CDN 域名）；如果需要提前下载具体资源（比如 LCP 大图），就用 PRELOAD，且必须加 as 属性保证优先级。  
如果是未来页面可能用到的资源，就避免影响当前性能：如果只是提前解析域名，用 DNSPREFETCH（比如分享插件域名）；如果需要提前下载资源，就用 PREFETCH，让浏览器在空闲时低优先级下载（比如列表页下一页的资源）。  
核心是平衡‘性能收益’和‘资源开销’，不盲目使用高深度优化。”

## 六、实践建议

1. **优先优化核心指标**：用 PRELOAD 优化 LCP 相关资源（如大图），用 Preconnect 优化关键 CDN 域名，直接提升核心 Web 指标分数；
2. **避免滥用 Preconnect**：浏览器对同一域名的 Preconnect 有数量限制，且占用 TCP 连接数，仅针对“当前页面必须用的 1-2 个关键域名”；
3. **PREFETCH 结合用户行为**：不要盲目预加载未来资源，可通过“用户悬停链接”“滚动到列表底部”等行为触发 PREFETCH，提升预判准确性；
4. **验证优化效果**：使用 Chrome DevTools 的“Network”面板查看资源加载时机，或用 Lighthouse 检测是否存在“未优化的关键资源”，验证提示符是否生效。

::: info 实战：路由悬停预取（SPA）

在单页应用中，可根据用户“悬停导航链接”或“滚动到列表底部”触发 `prefetch`，提升下一页体验：

```html
<a href="/products" id="nav-products">产品页</a>
<script type="module">
    const link = document.getElementById('nav-products');
    let prefetched = false;
    link.addEventListener('mouseover', () => {
      if (prefetched) return;
      const el = document.createElement('link');
      el.rel = 'prefetch';
      el.href = '/route-products.chunk.js';
      el.as = 'script';
      document.head.appendChild(el);
      prefetched = true;
    });
  }
</script>
```

- 验证：在 Network 面板观察该 chunk 以最低优先级在空闲时下载，并在进入路由时命中缓存。
  :::

::: danger 常见误区补充

- `preconnect` 滥用会占用过多 TCP 连接；仅针对十分确定且临近使用的关键域名。
- `preload` 缺失 `as` 会导致优先级错配；类型与 `crossorigin` 应与实际请求一致。
- `prefetch` 不是“提前执行”，它只是下载到缓存；进入下一页仍需正常引入与执行。
  :::

---

## 小结与后续

- 先判“服务当前还是未来”，再选“提前到哪一步”，四种提示符各司其职；避免“全加”导致资源浪费。
- 当前页面优化：`preconnect` + `preload` 直击核心指标（连接时延、LCP）；未来页面优化：`dns-prefetch` + `prefetch` 平衡体验与开销。
- 建议结合 DevTools/Lighthouse 验证优化是否生效，并持续观察指标（如 LCP、TTFB、CLS）。
