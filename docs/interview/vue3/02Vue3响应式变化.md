# âœ¨ Vue3 å“åº”å¼å˜åŒ– ğŸ‘Œ

> é¢è¯•é¢˜ï¼šè¯´ä¸€è¯´ Vue3 å“åº”å¼ç›¸è¾ƒäº Vue2 æ˜¯å¦æœ‰æ”¹å˜ï¼Ÿå¦‚æœæœ‰ï¼Œé‚£ä¹ˆè¯´ä¸€ä¸‹å…·ä½“æœ‰å“ªäº›æ”¹å˜ï¼Ÿ

## **1. å˜åŒ–ä¸€**

é¦–å½“å…¶å†²çš„å°±æ˜¯æ•°æ®æ‹¦æˆªçš„å˜åŒ–ï¼š

-   Vue2: ä½¿ç”¨ Object.defineProperty è¿›è¡Œæ‹¦æˆª
-   Vue3: ä½¿ç”¨ Proxy + Object.defineProperty è¿›è¡Œæ‹¦æˆª

**ä¸¤è€…çš„å…±åŒç‚¹**

-   éƒ½å¯ä»¥é’ˆå¯¹å¯¹è±¡æˆå‘˜æ‹¦æˆª
-   éƒ½å¯ä»¥å®ç°æ·±åº¦æ‹¦æˆª

**ä¸¤è€…çš„å·®å¼‚ç‚¹**

-   æ‹¦æˆªçš„å¹¿åº¦
    -   Object.defineProperty æ˜¯é’ˆå¯¹å¯¹è±¡ç‰¹å®š**å±æ€§**çš„**è¯»å†™**æ“ä½œè¿›è¡Œæ‹¦æˆªï¼Œè¿™æ„å‘³ç€ä¹‹åæ–°å¢åŠ /åˆ é™¤çš„å±æ€§æ˜¯ä¾¦æµ‹ä¸åˆ°çš„
    -   Proxy åˆ™æ˜¯é’ˆå¯¹**ä¸€æ•´ä¸ªå¯¹è±¡**çš„å¤šç§æ“ä½œï¼ŒåŒ…æ‹¬å±æ€§çš„è¯»å–ã€èµ‹å€¼ã€å±æ€§çš„åˆ é™¤ã€å±æ€§æè¿°ç¬¦çš„è·å–å’Œè®¾ç½®ã€åŸå‹çš„æŸ¥çœ‹ã€å‡½æ•°è°ƒç”¨ç­‰è¡Œä¸ºèƒ½å¤Ÿè¿›è¡Œæ‹¦æˆªã€‚
-   æ€§èƒ½ä¸Šçš„åŒºåˆ«ï¼šåœ¨å¤§å¤šæ•°åœºæ™¯ä¸‹ï¼ŒProxy æ¯” Object.defineProperty æ•ˆç‡æ›´é«˜ï¼Œæ‹¦æˆªæ–¹å¼æ›´åŠ çµæ´»ã€‚

## **2. å˜åŒ–äºŒ**

åˆ›å»ºå“åº”å¼æ•°æ®ä¸Šé¢çš„å˜åŒ–ï¼š

-   Vue2: é€šè¿‡ data æ¥åˆ›å»ºå“åº”å¼æ•°æ®
-   Vue3: é€šè¿‡ refã€reactvie ç­‰æ–¹æ³•æ¥åˆ›å»ºå“åº”å¼æ•°æ®
    -   refï¼šä½¿ç”¨ Object.defineProperty + Proxy æ–¹å¼
    -   reactiveï¼šä½¿ç”¨ Proxy æ–¹å¼

**å¯¹åº”æºç **

```js
class RefImpl<T> {
  private _value: T
  private _rawValue: T

  public dep?: Dep = undefined
  public readonly __v_isRef = true

  constructor(
    value: T,
    public readonly __v_isShallow: boolean,
  ) {
    this._rawValue = __v_isShallow ? value : toRaw(value)
    // æœ‰å¯èƒ½æ˜¯åŸå§‹å€¼ï¼Œæœ‰å¯èƒ½æ˜¯ reactive è¿”å›çš„ proxy
    this._value = __v_isShallow ? value : toReactive(value)
  }

  get value() {
    // æ”¶é›†ä¾èµ– ç•¥
    return this._value
  }

  set value(newVal) {
    // ç•¥
  }
}

// åˆ¤æ–­æ˜¯å¦æ˜¯å¯¹è±¡ï¼Œæ˜¯å¯¹è±¡å°±ç”¨ reactive æ¥å¤„ç†ï¼Œå¦åˆ™è¿”å›åŸå§‹å€¼
export const toReactive = <T extends unknown>(value: T): T =>
  isObject(value) ? reactive(value) : value
```

```js
function createReactiveObject(
    target: Target,
    isReadonly: boolean,
    baseHandlers: ProxyHandler<any>,
    collectionHandlers: ProxyHandler<any>,
    proxyMap: WeakMap<Target, any>
) {
    // ...

    // åˆ›å»º Proxy ä»£ç†å¯¹è±¡
    const proxy = new Proxy(
        target,
        targetType === TargetType.COLLECTION ? collectionHandlers : baseHandlers
    );
    proxyMap.set(target, proxy);
    return proxy;
}

export function reactive(target: object) {
    // ...

    return createReactiveObject(
        target,
        false,
        mutableHandlers,
        mutableCollectionHandlers,
        reactiveMap
    );
}
```

## **3. å˜åŒ–ä¸‰**

ä¾èµ–æ”¶é›†ä¸Šé¢çš„å˜åŒ–ï¼š

-   Vue2ï¼šWatcher + Dep

    -   æ¯ä¸ª**å“åº”å¼å±æ€§**éƒ½æœ‰ä¸€ä¸ª Dep å®ä¾‹ï¼Œç”¨äºåšä¾èµ–æ”¶é›†ï¼Œå†…éƒ¨åŒ…å«äº†ä¸€ä¸ªæ•°ç»„ï¼Œå­˜å‚¨ä¾èµ–è¿™ä¸ªå±æ€§çš„æ‰€æœ‰ watcher
    -   å½“å±æ€§å€¼å‘ç”Ÿå˜åŒ–ï¼Œdep å°±ä¼šé€šçŸ¥æ‰€æœ‰çš„ watcher å»åšæ›´æ–°æ“ä½œ

-   Vue3ï¼šWeakMap + Map + Set
    -   Vue3 çš„ä¾èµ–æ”¶é›†ç²’åº¦æ›´ç»†
    -   **WeakMap é”®å¯¹åº”çš„æ˜¯å“åº”å¼å¯¹è±¡ï¼Œå€¼æ˜¯ä¸€ä¸ª Mapï¼Œè¿™ä¸ª Map çš„é”®æ˜¯è¯¥å¯¹è±¡çš„å±æ€§ï¼Œå€¼æ˜¯ä¸€ä¸ª Setï¼ŒSet é‡Œé¢å­˜å‚¨äº†æ‰€æœ‰ä¾èµ–äºè¿™ä¸ªå±æ€§çš„ effect å‡½æ•°**

æ€»ç»“èµ·æ¥ï¼ŒVue3 ç›¸æ¯” Vue2 çš„ä¾èµ–è¿½è¸ªç²’åº¦æ›´ç»†ï¼ŒVue2 ä¾èµ–æ”¶é›†æ”¶é›†çš„æ˜¯å…·ä½“çš„ Watcherï¼ˆç»„ä»¶ï¼‰ï¼ŒVue3 ä¾èµ–æ”¶é›†æ”¶é›†çš„æ˜¯å¯¹åº”çš„å‰¯ä½œç”¨å‡½æ•°ã€‚

## é¢è¯•é¢˜

è¯´ä¸€è¯´ Vue3 å“åº”å¼ç›¸è¾ƒäº Vue2 æ˜¯å¦æœ‰æ”¹å˜ï¼Ÿå¦‚æœæœ‰ï¼Œé‚£ä¹ˆè¯´ä¸€ä¸‹å…·ä½“æœ‰å“ªäº›æ”¹å˜ï¼Ÿ

å‚è€ƒç­”æ¡ˆï¼š

ç›¸æ¯”è¾ƒ Vue2ï¼ŒVue3 åœ¨å“åº”å¼çš„å®ç°æ–¹é¢æœ‰è¿™ä¹ˆä¸€äº›æ–¹é¢çš„æ”¹å˜ï¼š

1.  æ•°æ®æ‹¦æˆªä» Object.defineProperty æ”¹ä¸ºäº† Proxy + Object.defineProperty çš„æ‹¦æˆªæ–¹å¼ï¼Œå…¶ä¸­
    -   refï¼šä½¿ç”¨ ObjectdefineProperty + Proxy æ–¹å¼
    -   reactiveï¼šä½¿ç”¨ Proxy æ–¹å¼
2.  åˆ›å»ºå“åº”å¼æ•°æ®åœ¨è¯­æ³•å±‚é¢æœ‰äº†å˜åŒ–ï¼š
    -   Vue2: é€šè¿‡ data æ¥åˆ›å»ºå“åº”å¼æ•°æ®
    -   Vue3: é€šè¿‡ refã€reactvie ç­‰æ–¹æ³•æ¥åˆ›å»ºå“åº”å¼æ•°æ®
3.  ä¾èµ–æ”¶é›†ä¸Šé¢çš„å˜åŒ–
    -   Vue2ï¼šWatcher + Dep
    -   Vue3ï¼šWeakMap + Map + Set
    -   è¿™ç§å®ç°æ–¹å¼å¯ä»¥å®ç°æ›´ç»†ç²’åº¦çš„ä¾èµ–è¿½è¸ªå’Œæ›´æ–°æ§åˆ¶
