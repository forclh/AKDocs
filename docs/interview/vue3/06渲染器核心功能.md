# æ¸²æŸ“å™¨æ ¸å¿ƒåŠŸèƒ½

>é¢è¯•é¢˜ï¼šè¯´ä¸€è¯´æ¸²æŸ“å™¨çš„æ ¸å¿ƒåŠŸèƒ½æ˜¯ä»€ä¹ˆï¼Ÿ

æ¸²æŸ“å™¨çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œæ˜¯æ ¹æ®æ‹¿åˆ°çš„ vnodeï¼Œè¿›è¡ŒèŠ‚ç‚¹çš„**æŒ‚è½½**ä¸**æ›´æ–°**ã€‚

**æŒ‚è½½å±æ€§**

vnodeï¼š

```js
const vnode = {
  type: 'div',
  // props å¯¹åº”çš„å°±æ˜¯èŠ‚ç‚¹çš„å±æ€§
  props: {
    id: 'foo'
  },
  children: [
    type: 'p',
    children: 'hello'
  ]
}
```

æ¸²æŸ“å™¨å†…éƒ¨æœ‰ä¸€ä¸ª mountElement æ–¹æ³•ï¼š

```js
function mountElement(vnode, container){
  // æ ¹æ®èŠ‚ç‚¹ç±»å‹åˆ›å»ºå¯¹åº”çš„DOMèŠ‚ç‚¹
  const el = document.createElement(vnode.type);
  
  // çœç•¥childrençš„å¤„ç†
  
  // å¯¹å±æ€§çš„å¤„ç†
  if(vnode.props){
    for(const key in vnode.props){
      el.setAttribute(key, vnode.props[key])
    }
  }
  
  insert(el, container);
}
```

é™¤äº†ä½¿ç”¨setAttributeæ–¹æ³•æ¥è®¾ç½®å±æ€§ä»¥å¤–ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨DOMå¯¹è±¡çš„æ–¹å¼ï¼š

```js
if(vnode.props){
  for(const key in vnode.props){
    // el.setAttribute(key, vnode.props[key])
    el[key] = vnode.props[key];
  }
}
```

æ€è€ƒğŸ¤”ï¼šå“ªç§è®¾ç½®æ–¹æ³•å¥½ï¼Ÿä¸¤ç§è®¾ç½®æ–¹æ³•æœ‰åŒºåˆ«å—ï¼Ÿåº”è¯¥ä½¿ç”¨å“ªç§æ¥è®¾ç½®ï¼Ÿ

**HTML Attributes**

Attributes æ˜¯å…ƒç´ çš„**åˆå§‹**å±æ€§å€¼ï¼Œåœ¨ HTML æ ‡ç­¾ä¸­å®šä¹‰ï¼Œç”¨äº**æè¿°å…ƒç´ çš„åˆå§‹çŠ¶æ€**ã€‚

- åœ¨å…ƒç´ è¢«è§£æçš„æ—¶å€™ï¼Œåªä¼šåˆå§‹åŒ–ä¸€æ¬¡
- **åªèƒ½æ˜¯å­—ç¬¦ä¸²å€¼**ï¼Œè€Œä¸”è¿™ä¸ªå€¼ä»…ä»£è¡¨åˆå§‹çš„çŠ¶æ€ï¼Œæ— æ³•ååº”è¿è¡Œæ—¶çš„å˜åŒ–

```vue
<input type="text" id="username" value="John">
```

**DOM Properties**

Properties æ˜¯ JavaScript å¯¹è±¡ä¸Šçš„å±æ€§ï¼Œä»£è¡¨äº† DOM å…ƒç´ åœ¨ **å†…å­˜ä¸­** çš„å®é™…çŠ¶æ€ã€‚

- ååº”çš„æ˜¯ DOM å…ƒç´ çš„å½“å‰çŠ¶æ€
- å±æ€§ç±»å‹å¯ä»¥æ˜¯å­—ç¬¦ä¸²ã€æ•°å­—ã€å¸ƒå°”å€¼ã€å¯¹è±¡ä¹‹ç±»çš„

å¾ˆå¤š HTML attributes åœ¨ DOM å¯¹è±¡ä¸Šæœ‰ä¸ä¹‹ç›¸åŒçš„ DOM Propertiesï¼Œä¾‹å¦‚ï¼š

| HTML attributes | DOM properties |
| --------------- | -------------- |
| id="username"   | el.id          |
| type="text"     | el.type        |
| value="John"    | el.value       |

ä½†æ˜¯ï¼Œä¸¤è€…å¹¶ä¸æ€»æ˜¯ç›¸ç­‰çš„ï¼Œä¾‹å¦‚ï¼š

| HTML attributes | DOM properties |
| --------------- | -------------- |
| class="foo"     | el.className   |

è¿˜æœ‰å¾ˆå¤šå…¶ä»–çš„æƒ…å†µï¼š

- HTML attributes æœ‰ä½†æ˜¯ DOM properties æ²¡æœ‰çš„å±æ€§ï¼šä¾‹å¦‚ aria-* ä¹‹ç±»çš„HTML Attributes
- DOM properties æœ‰ä½†æ˜¯ HTML attributes æ²¡æœ‰çš„å±æ€§ï¼šä¾‹å¦‚ el.textContent
- ä¸€ä¸ª HTML attributes å…³è”å¤šä¸ª DOM properties çš„æƒ…å†µ:ä¾‹å¦‚ value="xxx" å’Œ el.value ä»¥åŠ el.defaultValue éƒ½æœ‰å…³è”

å¦å¤–ï¼Œåœ¨è®¾ç½®çš„æ—¶å€™ï¼Œä¸æ˜¯å•çº¯çš„ç”¨æŸä¸€ç§æ–¹å¼ï¼Œè€Œæ˜¯ä¸¤ç§æ–¹å¼ç»“åˆä½¿ç”¨ã€‚å› ä¸ºéœ€è¦è€ƒè™‘å¾ˆå¤šç‰¹æ®Šæƒ…å†µï¼š

1. disabled
2. åªè¯»å±æ€§

**1. disabled**

æ¨¡æ¿ï¼šæˆ‘ä»¬æƒ³è¦æ¸²æŸ“çš„æŒ‰é’®æ˜¯éç¦ç”¨çŠ¶æ€

```vue
<button :disabled="false">Button</button>
```

vnode:

```js
const vnode = {
  type: 'button',
  props: {
    disable: false
  }
}
```

é€šè¿‡ el.setAttribute æ–¹æ³•æ¥è¿›è¡Œè®¾ç½®ä¼šé‡åˆ°çš„é—®é¢˜ï¼šæœ€ç»ˆæ¸²æŸ“å‡ºæ¥çš„æŒ‰é’®å°±æ˜¯ç¦ç”¨çŠ¶æ€

```js
 el.setAttribute('disabled', 'false')
```

è§£å†³æ–¹æ¡ˆï¼šä¼˜å…ˆè®¾ç½® DOM Properties

é‡åˆ°æ–°çš„é—®é¢˜ï¼šæœ¬æ„æ˜¯è¦ç¦ç”¨æŒ‰é’®

```vue
<button disabled>Button</button>
```

```js
const vnode = {
  type: 'button',
  props: {
    disable: ''
  }
}
```

```js
el.disabled = ''
```

åœ¨å¯¹ DOM çš„ disabled å±æ€§è®¾ç½®å€¼çš„æ—¶å€™ï¼Œä»»ä½•éå¸ƒå°”ç±»å‹çš„å€¼éƒ½ä¼šè¢«è½¬ä¸ºå¸ƒå°”ç±»å‹ï¼š

```js
el.disabled = false
```

æœ€ç»ˆæ¸²æŸ“å‡ºæ¥çš„æŒ‰é’®æ˜¯éç¦ç”¨çŠ¶æ€ã€‚

**æ¸²æŸ“å™¨å†…éƒ¨çš„å®ç°ï¼Œä¸æ˜¯å•ç‹¬ç”¨ HTML Attribute æˆ–è€… DOM Propertiesï¼Œè€Œæ˜¯ä¸¤è€…ç»“åˆèµ·æ¥ä½¿ç”¨ï¼Œå¹¶ä¸”è¿˜ä¼šè€ƒè™‘å¾ˆå¤šçš„ç»†èŠ‚ä»¥åŠç‰¹æ®Šæƒ…å†µï¼Œé’ˆå¯¹ç‰¹æ®Šæƒ…å†µåšç‰¹æ®Šå¤„ç†**ã€‚

```js
function mountElement(vnode, container) {
  const el = createElement(vnode.type);
  // çœç•¥ children çš„å¤„ç†

  if (vnode.props) {
    for (const key in vnode.props) {
      // ç”¨ in æ“ä½œç¬¦åˆ¤æ–­ key æ˜¯å¦å­˜åœ¨å¯¹åº”çš„ DOM Properties
      if (key in el) {
        // è·å–è¯¥ DOM Properties çš„ç±»å‹
        const type = typeof el[key];
        const value = vnode.props[key];
        // å¦‚æœæ˜¯å¸ƒå°”ç±»å‹ï¼Œå¹¶ä¸” value æ˜¯ç©ºå­—ç¬¦ä¸²ï¼Œåˆ™å°†å€¼çŸ«æ­£ä¸º true
        if (type === "boolean" && value === "") {
          el[key] = true;
        } else {
          el[key] = value;
        }
      } else {
        // å¦‚æœè¦è®¾ç½®çš„å±æ€§æ²¡æœ‰å¯¹åº”çš„ DOM Propertiesï¼Œåˆ™ä½¿ç”¨ setAttribute å‡½æ•°è®¾ç½®å±æ€§
        el.setAttribute(key, vnode.props[key]);
      }
    }
  }
  insert(el, container);
}
```

**2. åªè¯»å±æ€§**

```vue
<input form="form1"/>
```

ä¾‹å¦‚ el.formï¼Œä½†æ˜¯è¿™ä¸ªå±æ€§æ˜¯åªè¯»çš„ï¼Œæ‰€ä»¥è¿™ç§æƒ…å†µï¼Œåˆåªèƒ½ä½¿ç”¨ setAttribute æ–¹æ³•æ¥è®¾ç½®

```js
function shouldSetAsProps(el, key, value) {
  // ç‰¹æ®Šå¤„ç†
  // é‡åˆ°å…¶ä»–ç‰¹æ®Šæƒ…å†µå†è¿›è¡Œé‡æ„
  if (key === "form" && el.tagName === "INPUT") return false;
  // å…œåº•
  return key in el;
}

function mountElement(vnode, container) {
  const el = createElement(vnode.type);
  // çœç•¥ children çš„å¤„ç†

  if (vnode.props) {
    for (const key in vnode.props) {
      const value = vnode.props[key];

      if (shouldSetAsProps(el, key, value)) {
        const type = typeof el[key];
        if (type === "boolean" && value === "") {
          el[key] = true;
        } else {
          el[key] = value;
        }
      } else {
        el.setAttribute(key, value);
      }
    }
  }
  insert(el, container);
}
```

shouldSetAsProps è¿™ä¸ªæ–¹æ³•è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œç”±å¸ƒå°”å€¼æ¥å†³å®šæ˜¯å¦ä½¿ç”¨ DOM Properties æ¥è®¾ç½®ã€‚

è¿˜å¯ä»¥è¿›ä¸€æ­¥ä¼˜åŒ–ï¼Œå°†å±æ€§çš„è®¾ç½®æå–å‡ºæ¥ï¼š

```js
function shouldSetAsProps(el, key, value) {
  // ç‰¹æ®Šå¤„ç†
  if (key === "form" && el.tagName === "INPUT") return false;
  // å…œåº•
  return key in el;
}

/**
 *
 * @param {*} el å…ƒç´ 
 * @param {*} key å±æ€§
 * @param {*} prevValue æ—§å€¼
 * @param {*} nextValue æ–°å€¼
 */
function patchProps(el, key, prevValue, nextValue) {
  if (shouldSetAsProps(el, key, nextValue)) {
    const type = typeof el[key];
    if (type === "boolean" && nextValue === "") {
      el[key] = true;
    } else {
      el[key] = nextValue;
    }
  } else {
    el.setAttribute(key, nextValue);
  }
}

function mountElement(vnode, container) {
  const el = createElement(vnode.type);
  // çœç•¥ children çš„å¤„ç†

  if (vnode.props) {
    for (const key in vnode.props) {
      // è°ƒç”¨ patchProps å‡½æ•°å³å¯
      patchProps(el, key, null, vnode.props[key]);
    }
  }
  insert(el, container);
}
```

**classå¤„ç†**

class æœ¬è´¨ä¸Šä¹Ÿæ˜¯å±æ€§çš„ä¸€ç§ï¼Œä½†æ˜¯åœ¨ Vue ä¸­é’ˆå¯¹ class åšäº†å¢å¼ºï¼Œå› æ­¤ Vue æ¨¡æ¿ä¸­çš„ class çš„å€¼å¯èƒ½ä¼šæœ‰è¿™ä¹ˆä¸€äº›æƒ…å†µï¼š

æƒ…å†µä¸€ï¼šå­—ç¬¦ä¸²å€¼

```vue
<template>
	<p class="foo bar"></p>
</template>
```

```js
const vnode = {
  type: "p",
  props: {
    class: "foo bar",
  },
};
```

æƒ…å†µäºŒï¼šå¯¹è±¡å€¼

```vue
<template>
	<p :class="cls"></p>
</template>
<script setup>
import { ref } from 'vue'
const cls = ref({
  foo: true,
  bar: false
})
</script>
```

```js
const vnode = {
  type: "p",
  props: {
    class: { foo: true, bar: false },
  },
};
```

æƒ…å†µä¸‰ï¼šæ•°ç»„å€¼

```vue
<template>
	<p :class="arr"></p>
</template>
<script setup>
import { ref } from 'vue'
const arr = ref([
  'foo bar',
  {
    baz: true
  }
])
</script>
```

```js
const vnode = {
  type: "p",
  props: {
    class: ["foo bar", { baz: true }],
  },
};
```

è¿™é‡Œé¦–å…ˆç¬¬ä¸€æ­¥å°±æ˜¯éœ€è¦åš**å‚æ•°å½’ä¸€åŒ–**ï¼Œç»Ÿä¸€æˆå­—ç¬¦ä¸²ç±»å‹ã€‚Vueå†…éƒ¨æœ‰ä¸€ä¸ªæ–¹æ³• normalizeClass å°±æ˜¯åš class çš„å‚æ•°å½’ä¸€åŒ–çš„ã€‚

```js
function isString(value) {
  return typeof value === "string";
}

function isArray(value) {
  return Array.isArray(value);
}

function isObject(value) {
  return value !== null && typeof value === "object";
}

function normalizeClass(value) {
  let res = "";
  if (isString(value)) {
    res = value;
  } else if (isArray(value)) {
    // å¦‚æœæ˜¯æ•°ç»„ï¼Œé€’å½’è°ƒç”¨ normalizeClass
    for (let i = 0; i < value.length; i++) {
      const normalized = normalizeClass(value[i]);
      if (normalized) {
        res += (res ? " " : "") + normalized;
      }
    }
  } else if (isObject(value)) {
    // å¦‚æœæ˜¯å¯¹è±¡ï¼Œåˆ™æ£€æŸ¥æ¯ä¸ª key æ˜¯å¦ä¸ºçœŸå€¼
    for (const name in value) {
      if (value[name]) {
        res += (res ? " " : "") + name;
      }
    }
  }
  return res;
}

console.log(normalizeClass("foo")); // 'foo'
console.log(normalizeClass(["foo", "bar"])); // 'foo bar'
console.log(normalizeClass({ foo: true, bar: false })); // 'foo'
console.log(normalizeClass(["foo", { bar: true }])); // 'foo bar'
console.log(normalizeClass(["foo", ["bar", "baz"]])); // 'foo bar baz'
```

```js
const vnode = {
  type: "p",
  props: {
    class: normalizeClass(["foo bar", { baz: true }]),
  },
};
```

```js
const vnode = {
  type: "p",
  props: {
    class: 'foo bar baz',
  },
};
```

è®¾ç½®classçš„æ—¶å€™ï¼Œè®¾ç½®æ–¹æ³•ä¹Ÿæœ‰å¤šç§ï¼š

1. setAttribute
2. el.classNameï¼šè¿™ç§æ–¹å¼æ•ˆç‡æ˜¯æœ€é«˜çš„
3. el.classList

```js
function patchProps(el, key, prevValue, nextValue) {
  // å¯¹ class è¿›è¡Œç‰¹æ®Šå¤„ç†
  if (key === "class") {
    el.className = nextValue || "";
  } else if (shouldSetAsProps(el, key, nextValue)) {
    const type = typeof el[key];
    if (type === "boolean" && nextValue === "") {
      el[key] = true;
    } else {
      el[key] = nextValue;
    }
  } else {
    el.setAttribute(key, nextValue);
  }
}
```


**å­èŠ‚ç‚¹çš„æŒ‚è½½**

é™¤äº†å¯¹è‡ªèº«èŠ‚ç‚¹çš„å¤„ç†ï¼Œè¿˜éœ€è¦å¯¹å­èŠ‚ç‚¹è¿›è¡Œå¤„ç†ï¼Œä¸è¿‡å¤„ç†å­èŠ‚ç‚¹æ—¶æ¶‰åŠåˆ° diff è®¡ç®—ã€‚

```js
function mountElement(vnode, container) {
  const el = createElement(vnode.type);
  
  // é’ˆå¯¹å­èŠ‚ç‚¹è¿›è¡Œå¤„ç†
  if (typeof vnode.children === "string") {
    // å¦‚æœ children æ˜¯å­—ç¬¦ä¸²ï¼Œåˆ™ç›´æ¥å°†å­—ç¬¦ä¸²æ’å…¥åˆ°å…ƒç´ ä¸­
    setElementText(el, vnode.children);
  } else if (Array.isArray(vnode.children)) {
    // å¦‚æœ children æ˜¯æ•°ç»„ï¼Œåˆ™éå†æ¯ä¸€ä¸ªå­èŠ‚ç‚¹ï¼Œå¹¶è°ƒç”¨ patch å‡½æ•°æŒ‚è½½å®ƒä»¬
    vnode.children.forEach((child) => {
      patch(null, child, el); // patchå‡½æ•°ç”¨äºè¿›è¡Œdiffè®¡ç®—
    });
  }
  insert(el, container);
}
```



>é¢è¯•é¢˜ï¼šè¯´ä¸€è¯´æ¸²æŸ“å™¨çš„æ ¸å¿ƒåŠŸèƒ½æ˜¯ä»€ä¹ˆï¼Ÿ
>
>å‚è€ƒç­”æ¡ˆï¼š
>
>æ¸²æŸ“å™¨æœ€æœ€æ ¸å¿ƒçš„åŠŸèƒ½æ˜¯å¤„ç†**ä»è™šæ‹Ÿ DOM åˆ°çœŸå® DOM çš„æ¸²æŸ“è¿‡ç¨‹**ï¼Œè¿™ä¸ªè¿‡ç¨‹åŒ…å«å‡ ä¸ªé˜¶æ®µï¼š
>
>1. **æŒ‚è½½**ï¼šåˆæ¬¡æ¸²æŸ“æ—¶ï¼Œæ¸²æŸ“å™¨ä¼šå°†è™šæ‹Ÿ DOM è½¬åŒ–ä¸ºçœŸå® DOM å¹¶æ’å…¥é¡µé¢ã€‚å®ƒä¼š**æ ¹æ®è™šæ‹ŸèŠ‚ç‚¹æ ‘é€’å½’åˆ›å»º DOM å…ƒç´ å¹¶è®¾ç½®ç›¸å…³å±æ€§**ã€‚
>2. **æ›´æ–°**ï¼šå½“ç»„ä»¶çš„çŠ¶æ€æˆ–å±æ€§å˜åŒ–æ—¶ï¼Œæ¸²æŸ“å™¨ä¼š**è®¡ç®—æ–°æ—§è™šæ‹Ÿ DOM çš„å·®å¼‚ï¼Œå¹¶é€šè¿‡ Patch è¿‡ç¨‹æœ€å°åŒ–æ›´æ–°çœŸå® DOM**ã€‚
>3. **å¸è½½**ï¼šå½“ç»„ä»¶è¢«é”€æ¯æ—¶ï¼Œæ¸²æŸ“å™¨éœ€è¦å°†å…¶ä» DOM ä¸­ç§»é™¤ï¼Œå¹¶è¿›è¡Œå¿…è¦çš„æ¸…ç†å·¥ä½œã€‚
>
>æ¯ä¸€ä¸ªæ­¥éª¤éƒ½æœ‰å¤§é‡éœ€è¦è€ƒè™‘çš„ç»†èŠ‚ï¼Œå°±æ‹¿æŒ‚è½½æ¥è®²ï¼Œå…‰æ˜¯å¤„ç†å…ƒç´ å±æ€§å¦‚ä½•æŒ‚è½½å°±æœ‰å¾ˆå¤šéœ€è¦è€ƒè™‘çš„é—®é¢˜ï¼Œæ¯”å¦‚ï¼š
>
>1. æœ€ç»ˆè®¾ç½®å±æ€§çš„æ—¶å€™æ˜¯ç”¨ setAttribute æ–¹æ³•æ¥è®¾ç½®ï¼Œè¿˜æ˜¯ç”¨ç»™ DOM å¯¹è±¡å±æ€§èµ‹å€¼çš„æ–¹å¼æ¥è®¾ç½®
>2. é‡åˆ°åƒ disabled è¿™æ ·çš„ç‰¹æ®Šå±æ€§è¯¥å¦‚ä½•å¤„ç†
>3. classã€style è¿™æ ·çš„å¤šå€¼ç±»å‹ï¼Œè¯¥å¦‚ä½•åšå‚æ•°çš„å½’ä¸€åŒ–ï¼Œå½’ä¸€ä¸ºå“ªç§å½¢å¼
>4. åƒ class è¿™æ ·çš„å±æ€§ï¼Œè®¾ç½®çš„æ–¹å¼æœ‰å“ªç§ï¼Œå“ªä¸€ç§æ•ˆç‡é«˜
>
>å¦å¤–ï¼Œæ¸²æŸ“å™¨å’Œå“åº”å¼ç³»ç»Ÿæ˜¯ç´§å¯†ç»“åˆåœ¨ä¸€æ¬¡çš„ï¼Œå½“ç»„ä»¶é¦–æ¬¡æ¸²æŸ“çš„æ—¶å€™ï¼Œç»„ä»¶é‡Œé¢çš„å“åº”å¼æ•°æ®ä¼šå’Œæ¸²æŸ“å‡½æ•°å»ºç«‹ä¾èµ–å…³ç³»ï¼Œå½“å“åº”å¼æ•°æ®å‘ç”Ÿå˜åŒ–åï¼Œæ¸²æŸ“å‡½æ•°ä¼šé‡æ–°æ‰§è¡Œï¼Œç”Ÿæˆæ–°çš„è™šæ‹Ÿ DOM æ ‘ï¼Œæ¸²æŸ“å™¨éšå³è¿›å…¥æ›´æ–°é˜¶æ®µï¼Œæ ¹æ®æ–°æ—§ä¸¤é¢—è™šæ‹Ÿ DOM æ ‘å¯¹æ¯”æ¥æœ€å°åŒ–æ›´æ–°çœŸå® DOMï¼Œè¿™æ¶‰åŠåˆ°äº† Vue ä¸­çš„ diff ç®—æ³•ã€‚diff ç®—æ³•è¿™ä¸€å—å„¿ï¼ŒVue2 é‡‡ç”¨çš„æ˜¯åŒç«¯ diffï¼ŒVue3 åˆ™æ˜¯åšäº†è¿›ä¸€æ­¥çš„ä¼˜åŒ–ï¼Œé‡‡ç”¨çš„æ˜¯å¿«é€Ÿ diff ç®—æ³•ã€‚diff è¿™ä¸€å—å„¿éœ€è¦æˆ‘å±•å¼€è¯´ä¸€ä¸‹ä¹ˆï¼Ÿ

---

-EOF-