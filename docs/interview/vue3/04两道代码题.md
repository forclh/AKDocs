# ä¸¤é“ä»£ç é¢˜ ğŸ‘Œ

## é¢è¯•é¢˜ 1

å®Œæˆ Component ç±»ä»£ç çš„ä¹¦å†™ï¼Œè¦æ±‚ï¼š

1. ä¿®æ”¹æ•°æ®æ—¶èƒ½å¤Ÿè§¦å‘ render æ–¹æ³•çš„æ‰§è¡Œ
2. åŒæ­¥å˜æ›´æ—¶éœ€è¦åˆå¹¶ï¼Œä»…è§¦å‘ä¸€æ¬¡ render æ–¹æ³•

```js
class Component {
    data = {
        name: "",
    };
    constructor() {}
    render() {
        console.log(`render - name: ${this.data.name}`);
    }
}

const com = new Component();
// è¦æ±‚ä»¥ä¸‹ä»£ç éœ€è¦è§¦å‘ render æ–¹æ³•ï¼Œå¹¶ä¸”åŒæ­¥å˜æ›´éœ€è¦åˆå¹¶
com.data.name = "å¼ ä¸‰";
com.data.name = "æå››";
com.data.name = "ç‹äº”";

setTimeout(() => {
    com.data.name = "AK";
}, 0);
```

ç­”æ¡ˆï¼š

é¦–å…ˆé€šè¿‡ `Proxy` ä»£ç†ä½¿å¾—å±æ€§å€¼çš„æ›´æ”¹å¯ä»¥è¢«ç›‘å¬åˆ°ï¼Œä»è€Œå¯ä»¥åŒæ­¥çš„è§¦å‘ render å‡½æ•°ã€‚

```js
class Component {
    // å®ä¾‹å±æ€§ï¼Œæ¯ä¸ªå®ä¾‹éƒ½æœ‰è‡ªå·±çš„å‰¯æœ¬
    // ç­‰åŒäºåœ¨constructorä¸­å†™ this.data = { name: "" }
    _data = {
        name: "",
    };
    constructor() {
        this.data = new Proxy(this._data, {
            set: (target, key, value) => {
                // 1. è®¾ç½®å€¼
                this._data[key] = value;
                // 2.è§¦å‘æ›´æ–°
                this.render();
            },
        });
    }
    // åŸå‹æ–¹æ³•ï¼Œæ‰€æœ‰å®ä¾‹å…±äº«
    render() {
        console.log(`render - name: ${this.data.name}`);
    }
}
```

ç”±äºåŒæ­¥ä»£ç çš„å˜æ›´å¼•èµ·çš„ render å‡½æ•°éœ€è¦åˆå¹¶ï¼Œå› æ­¤ rener å‡½æ•°çš„è§¦å‘éœ€è¦åœ¨æ‰€æœ‰åŒæ­¥çš„å±æ€§å€¼è®¾ç½®åè§¦å‘ï¼Œæ‰€ä»¥å¯ä»¥å€Ÿç”¨ `nextTick` çš„æ€æƒ³å¯ä»¥é€šè¿‡å°†æ›´æ–°æ“ä½œæ”¾åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­å¹¶é€šè¿‡å¼€å…³æ¥æ§åˆ¶å¾®ä»»åŠ¡çš„ä¸ªæ•°ï¼Œä»è€Œå®ç°å¼‚æ­¥çš„è§¦å‘æ›´æ–°æ“ä½œã€‚

```js
class Component {
    // å®ä¾‹å±æ€§ï¼Œæ¯ä¸ªå®ä¾‹éƒ½æœ‰è‡ªå·±çš„å‰¯æœ¬
    // ç­‰åŒäºåœ¨constructorä¸­å†™ this.data = { name: "" }
    _data = {
        name: "",
    };
    pending = false; // å¼€å…³
    constructor() {
        this.data = new Proxy(this._data, {
            set: (target, key, value) => {
                // 1. è®¾ç½®å€¼
                this._data[key] = value;
                // 2. å¼‚æ­¥è§¦å‘æ›´æ–°
                if (!this.pending) {
                    this.pending = true;
                    // å€Ÿç”¨ nextTick çš„æ€æƒ³ï¼Œå°†æ›´æ–°æ“ä½œæ”¾åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­
                    Promise.resolve().then(() => {
                        // è§¦å‘æ›´æ–°
                        this.render();
                        this.pending = false;
                    });
                }
            },
        });
    }
    // åŸå‹æ–¹æ³•ï¼Œæ‰€æœ‰å®ä¾‹å…±äº«
    render() {
        console.log(`render - name: ${this.data.name}`);
    }
}

const com = new Component();
// è¦æ±‚ä»¥ä¸‹ä»£ç éœ€è¦è§¦å‘ render æ–¹æ³•ï¼Œå¹¶ä¸”åŒæ­¥å˜æ›´éœ€è¦åˆå¹¶
com.data.name = "å¼ ä¸‰";
com.data.name = "æå››";
com.data.name = "ç‹äº”";

setTimeout(() => {
    com.data.name = "AK";
}, 0);
```

## é¢è¯•é¢˜ 2

ä»¥ä¸‹ä¸¤æ®µä»£ç åœ¨ Vue ä¸­åˆ†åˆ«æ¸²æŸ“å‡ æ¬¡ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ

ä»£ç ä¸€ï¼š

```vue
<template>
    <div>{{ rCount }}</div>
</template>
<script setup>
import { ref } from "vue";
const count = 0;
const rCount = ref(count);
for (let i = 1; i <= 5; ++i) {
    rCount.value = i;
}
</script>
```

ä»£ç äºŒï¼š

```vue
<template>
    <div>{{ rCount }}</div>
</template>
<script setup>
import { ref } from "vue";
const count = 0;
const rCount = ref(count);
for (let i = 1; i <= 5; ++i) {
    setTimeout(() => {
        rCount.value = i;
    }, 0);
}
</script>
```

-   ä»£ç ä¸€ï¼š2 æ¬¡ï¼Œåˆå§‹åŒ–æ¸²æŸ“ 1 æ¬¡ï¼Œä¹‹åè™½ç„¶åœ¨ for å¾ªç¯ä¸­ä¿®æ”¹äº† 5 æ¬¡å“åº”å¼æ•°æ®ï¼Œä½†æ˜¯ä¼šè¢«åˆå¹¶ï¼Œå› æ­¤ä¹‹ååªä¼šæ¸²æŸ“ 1 æ¬¡ã€‚
-   ä»£ç äºŒï¼š6 æ¬¡ï¼Œåˆå§‹åŒ–æ¸²æŸ“ 1 æ¬¡ï¼Œä¹‹åæ¯ä¸€ä¸ª setTimeout ä¸­ä¿®æ”¹ä¸€æ¬¡å“åº”å¼æ•°æ®å°±ä¼šæ¸²æŸ“ 1 æ¬¡ã€‚

> å‚è€ƒç­”æ¡ˆï¼š
>
> **ä»£ç ä¸€ï¼ˆåŒæ­¥èµ‹å€¼ï¼‰**
>
> ä¼šæ¸²æŸ“ä¸¤æ¬¡ï¼š
>
> 1.  åˆå§‹åŒ–æ¸²æŸ“ä¸€æ¬¡ï¼šåœ¨ç»„ä»¶æŒ‚è½½æ—¶ï¼ŒVue ä¼šè¿›è¡Œä¸€æ¬¡åˆå§‹æ¸²æŸ“ï¼Œå°† rCount çš„åˆå§‹å€¼ 0 æ¸²æŸ“åˆ° DOM ä¸­ã€‚
>
> 2.  å“åº”å¼æ•°æ®æ›´æ–°å’Œæ‰¹å¤„ç†ï¼š
>
> -   åœ¨ for å¾ªç¯ä¸­ï¼ŒrCount.value è¢«ä¾æ¬¡èµ‹å€¼ä¸º 1, 2, 3, 4, 5. æ¯æ¬¡èµ‹å€¼æ—¶ï¼ŒVue çš„å“åº”å¼ç³»ç»Ÿä¼šæ£€æµ‹åˆ°æ•°æ®çš„å˜åŒ–ã€‚
> -   ç„¶è€Œï¼Œè¿™äº›å˜åŒ–å‘ç”Ÿåœ¨åŒä¸€ä¸ªåŒæ­¥ä»£ç å—å†…ï¼ŒVue ä¼šå°†è¿™äº›å˜åŒ–æ¨å…¥å¼‚æ­¥æ›´æ–°é˜Ÿåˆ—ä¸­ã€‚å› ä¸ºè¿™äº›èµ‹å€¼æ“ä½œæ˜¯åŒæ­¥æ‰§è¡Œçš„ï¼ŒVue ä¼šåœ¨å½“å‰äº‹ä»¶å¾ªç¯ç»“æŸæ—¶å¯¹è¿™äº›å˜åŒ–è¿›è¡Œæ‰¹å¤„ç†ï¼ˆbatchingï¼‰
> -   Vue çš„æ‰¹å¤„ç†æœºåˆ¶ä¼šå°†è¿™äº›åŒæ­¥çš„æ›´æ”¹**åˆå¹¶ä¸ºä¸€æ¬¡æ›´æ–°**ï¼Œå› æ­¤ï¼Œæ— è®ºæœ‰å¤šå°‘æ¬¡å¯¹ rCount.value çš„èµ‹å€¼ï¼Œæœ€ç»ˆåªä¼šåœ¨å¼‚æ­¥é˜Ÿåˆ—ä¸­è§¦å‘ä¸€æ¬¡æ¸²æŸ“æ›´æ–°ã€‚
>
> 3.  æœ€ç»ˆæ¸²æŸ“ä¸€æ¬¡ï¼šç”±äº Vue çš„æ‰¹å¤„ç†æœºåˆ¶ï¼Œè¿™æ®µä»£ç æœ€ç»ˆåªä¼šè§¦å‘ ä¸€æ¬¡ DOM æ›´æ–°ï¼Œæ¸²æŸ“å‡º rCount çš„æœ€ç»ˆå€¼ 5.
>
> æ€»è®¡æ¸²æŸ“æ¬¡æ•°ï¼š2 æ¬¡ï¼ˆåˆå§‹åŒ–æ¸²æŸ“ 1 æ¬¡ + æ‰¹å¤„ç†æ¸²æŸ“ 1 æ¬¡ï¼‰
>
> **ä»£ç äºŒï¼ˆå¼‚æ­¥èµ‹å€¼ï¼‰**
>
> ä¼šæ¸²æŸ“å…­æ¬¡ï¼š
>
> 1.  åˆå§‹åŒ–æ¸²æŸ“ä¸€æ¬¡ï¼šåŒæ ·ï¼Œç»„ä»¶æŒ‚è½½æ—¶ä¼šè¿›è¡Œä¸€æ¬¡åˆå§‹æ¸²æŸ“ï¼Œå°† rCount çš„åˆå§‹å€¼ 0 æ¸²æŸ“åˆ° DOM ä¸­ã€‚
>
> 2.  å¼‚æ­¥æ›´æ–°æ¸²æŸ“ï¼š
>
> -   åœ¨ for å¾ªç¯ä¸­ï¼Œæ¯æ¬¡è¿­ä»£éƒ½ä¼šåˆ›å»ºä¸€ä¸ª setTimeoutï¼Œæ¯ä¸ª setTimeout ä¼šåœ¨ 0 æ¯«ç§’åå¼‚æ­¥æ‰§è¡Œã€‚åœ¨æ¯ä¸ª setTimeout çš„å›è°ƒä¸­ï¼ŒrCount.value è¢«ä¾æ¬¡èµ‹å€¼ä¸º 1, 2, 3, 4, 5
> -   ç”±äºæ¯æ¬¡èµ‹å€¼éƒ½å‘ç”Ÿåœ¨ä¸€ä¸ªç‹¬ç«‹çš„å¼‚æ­¥å›è°ƒä¸­ï¼ŒVue çš„å“åº”å¼ç³»ç»Ÿä¼šåœ¨æ¯ä¸ªå¼‚æ­¥å›è°ƒæ‰§è¡Œåï¼Œç«‹å³è§¦å‘ç›¸åº”çš„æ›´æ–°æµç¨‹ã€‚æ¯æ¬¡ setTimeout å›è°ƒéƒ½ä¼šä½¿ rCount.value å‘ç”Ÿå˜åŒ–ï¼Œå› æ­¤æ¯æ¬¡éƒ½éœ€è¦è¿›è¡Œä¸€æ¬¡æ¸²æŸ“æ›´æ–°ã€‚
>
> 3.  æ¯ä¸ªå¼‚æ­¥å›è°ƒå¯¼è‡´ä¸€æ¬¡æ¸²æŸ“ï¼šå› æ­¤ï¼Œè¿™æ®µä»£ç ä¼šè§¦å‘ 5 æ¬¡ DOM æ›´æ–°ï¼Œæ¯æ¬¡å°† rCount æ¸²æŸ“ä¸º 1 åˆ° 5.
>
> æ€»è®¡æ¸²æŸ“æ¬¡æ•°ï¼š6 æ¬¡ï¼ˆåˆå§‹åŒ–æ¸²æŸ“ 1 æ¬¡ + 5 æ¬¡å¼‚æ­¥æ›´æ–°æ¸²æŸ“ï¼‰
