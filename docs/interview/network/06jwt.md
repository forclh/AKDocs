# JWT âœ¨

[[TOC]]

::: tip è¦ç‚¹é€Ÿè§ˆ

- JWT æ˜¯ä¸€ç§ä»¤ç‰Œæ ¼å¼ï¼Œä¸é™å®šå­˜å‚¨ä¸ä¼ è¾“ä½ç½®ï¼›å¸¸ç”¨ `Authorization: Bearer <token>`ã€‚
- ä»¤ç‰Œç»“æ„ï¼š`header.payload.signature`ï¼Œ`header/payload` ä¸º base64url ç¼–ç çš„ JSONï¼Œ`signature` ç”¨æŒ‡å®šç®—æ³•ç­¾åã€‚
- å®‰å…¨æœ¬è´¨ï¼š`signature` ä¿è¯ä¸å¯ä¼ªé€ ä¸ç¯¡æ”¹ï¼›`payload` éåŠ å¯†ï¼Œå±äºå¯è¯»å†…å®¹ã€‚
- ç®—æ³•é€‰æ‹©ï¼š`HS256`ï¼ˆå¯¹ç§°å¯†é’¥ï¼‰ä¸ `RS256`ï¼ˆéå¯¹ç§°å¯†é’¥ï¼‰ï¼›æœåŠ¡ç«¯éœ€å®‰å…¨ç®¡ç†å¯†é’¥ã€‚
- è¿‡æœŸä¸æ ¡éªŒï¼šæœåŠ¡å™¨è‡ªè¡ŒéªŒè¯ç­¾åã€`exp/nbf/iat/aud/iss` ç­‰å£°æ˜ï¼›åº“ä»…æä¾›åŸºç¡€èƒ½åŠ›ï¼Œç­–ç•¥ç”±ä¸šåŠ¡æ§åˆ¶ã€‚
  :::

## æ¦‚è¿°

å›é¡¾ç™»å½•çš„æµç¨‹ï¼š

![](http://mdrs.yuanjin.tech/img/image-20200417161950450.png)

æ¥ä¸‹æ¥çš„é—®é¢˜æ˜¯ï¼šè¿™ä¸ªå‡ºå…¥è¯ï¼ˆä»¤ç‰Œï¼‰é‡Œé¢åˆ°åº•å­˜å•¥ï¼Ÿ

ä¸€ç§æ¯”è¾ƒç®€å•çš„åŠæ³•å°±æ˜¯ç›´æ¥å­˜å‚¨ç”¨æˆ·ä¿¡æ¯çš„ JSON ä¸²ï¼Œè¿™ä¼šé€ æˆä¸‹é¢çš„å‡ ä¸ªé—®é¢˜ï¼š

- éæµè§ˆå™¨ç¯å¢ƒï¼Œå¦‚ä½•åœ¨ä»¤ç‰Œä¸­è®°å½•è¿‡æœŸæ—¶é—´
- å¦‚ä½•é˜²æ­¢ä»¤ç‰Œè¢«ä¼ªé€ 

JWT å°±æ˜¯ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜å‡ºç°çš„ã€‚

JWT å…¨ç§°`Json Web Token`ï¼Œæœ¬è´¨å°±æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²

å®ƒè¦è§£å†³çš„é—®é¢˜ï¼Œå°±æ˜¯åœ¨äº’è”ç½‘ç¯å¢ƒä¸­ï¼Œæä¾›**ç»Ÿä¸€çš„ã€å®‰å…¨çš„**ä»¤ç‰Œæ ¼å¼

å› æ­¤ï¼Œ**JWT åªæ˜¯ä¸€ä¸ªä»¤ç‰Œæ ¼å¼è€Œå·²ï¼Œä½ å¯ä»¥æŠŠå®ƒå­˜å‚¨åˆ° cookieï¼Œä¹Ÿå¯ä»¥å­˜å‚¨åˆ° localstorageï¼Œæ²¡æœ‰ä»»ä½•é™åˆ¶ï¼**

åŒæ ·çš„ï¼Œå¯¹äºä¼ è¾“ï¼Œä½ å¯ä»¥ä½¿ç”¨ä»»ä½•ä¼ è¾“æ–¹å¼æ¥ä¼ è¾“ JWTï¼Œä¸€èˆ¬æ¥è¯´ï¼Œ**æˆ‘ä»¬ä¼šä½¿ç”¨æ¶ˆæ¯å¤´æ¥ä¼ è¾“å®ƒ**

æ¯”å¦‚ï¼Œå½“ç™»å½•æˆåŠŸåï¼ŒæœåŠ¡å™¨å¯ä»¥ç»™å®¢æˆ·ç«¯å“åº”ä¸€ä¸ª JWTï¼š

```
HTTP/1.1 200 OK
Set-Cookie: token=JWTä»¤ç‰Œ
Authorization: Bearer JWTä»¤ç‰Œ
Content-Type: application/json

{ "token": "JWTä»¤ç‰Œ" }
```

å¯ä»¥çœ‹åˆ°ï¼Œ**JWT ä»¤ç‰Œå¯ä»¥å‡ºç°åœ¨å“åº”çš„ä»»ä½•ä¸€ä¸ªåœ°æ–¹ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨è‡ªè¡Œçº¦å®šå³å¯**ã€‚

> å½“ç„¶ï¼Œå®ƒä¹Ÿå¯ä»¥å‡ºç°åœ¨å“åº”çš„å¤šä¸ªåœ°æ–¹ï¼Œæ¯”å¦‚ä¸ºäº†å……åˆ†åˆ©ç”¨æµè§ˆå™¨çš„ cookieï¼ŒåŒæ—¶ä¸ºäº†ç…§é¡¾å…¶ä»–è®¾å¤‡ï¼Œä¹Ÿå¯ä»¥è®© JWT å‡ºç°åœ¨ set-cookie å’Œ authorization æˆ– body ä¸­ï¼Œå°½ç®¡è¿™ä¼šå¢åŠ é¢å¤–çš„ä¼ è¾“é‡ã€‚

å½“å®¢æˆ·ç«¯æ‹¿åˆ°ä»¤ç‰Œåï¼Œå®ƒè¦åšçš„åªæœ‰ä¸€ä»¶äº‹ï¼šå­˜å‚¨å®ƒã€‚

ä½ å¯ä»¥å­˜å‚¨åˆ°ä»»ä½•ä½ç½®ï¼Œæ¯”å¦‚æ‰‹æœºæ–‡ä»¶ã€PC æ–‡ä»¶ã€localstorageã€cookie

å½“åç»­è¯·æ±‚å‘ç”Ÿæ—¶ï¼Œä½ åªéœ€è¦å°†å®ƒä½œä¸ºè¯·æ±‚çš„ä¸€éƒ¨åˆ†å‘é€åˆ°æœåŠ¡å™¨å³å¯ã€‚

**è™½ç„¶ JWT æ²¡æœ‰æ˜ç¡®è¦æ±‚åº”è¯¥å¦‚ä½•é™„å¸¦åˆ°è¯·æ±‚ä¸­ï¼Œä½†é€šå¸¸æˆ‘ä»¬ä¼šä½¿ç”¨å¦‚ä¸‹çš„æ ¼å¼**ï¼š

```
GET /api/resources HTTP/1.1
Authorization: Bearer JWTä»¤ç‰Œ
```

è¿™æ ·ä¸€æ¥ï¼ŒæœåŠ¡å™¨å°±èƒ½å¤Ÿæ”¶åˆ°è¿™ä¸ªä»¤ç‰Œäº†ï¼Œé€šè¿‡å¯¹ä»¤ç‰Œçš„éªŒè¯ï¼Œå³å¯çŸ¥é“è¯¥ä»¤ç‰Œæ˜¯å¦æœ‰æ•ˆã€‚

å®ƒä»¬çš„å®Œæ•´äº¤äº’æµç¨‹æ˜¯éå¸¸ç®€å•æ¸…æ™°çš„

![](http://mdrs.yuanjin.tech/img/image-20200422172837190.png)

## ä»¤ç‰Œçš„ç»„æˆ

ä¸ºäº†ä¿è¯ä»¤ç‰Œçš„å®‰å…¨æ€§ï¼ŒJWT ä»¤ç‰Œç”±ä¸‰ä¸ªéƒ¨åˆ†ç»„æˆï¼Œåˆ†åˆ«æ˜¯ï¼š

1. headerï¼šä»¤ç‰Œå¤´éƒ¨ï¼Œ**è®°å½•äº†æ•´ä¸ªä»¤ç‰Œçš„ç±»å‹å’Œç­¾åç®—æ³•**
2. payloadï¼šä»¤ç‰Œè´Ÿè·ï¼Œè®°å½•äº†**ä¿å­˜çš„ä¸»ä½“ä¿¡æ¯**ï¼Œæ¯”å¦‚ä½ è¦ä¿å­˜çš„ç”¨æˆ·ä¿¡æ¯å°±å¯ä»¥æ”¾åˆ°è¿™é‡Œ
3. signatureï¼šä»¤ç‰Œç­¾åï¼ŒæŒ‰ç…§**å¤´éƒ¨å›ºå®šçš„ç­¾åç®—æ³•å¯¹æ•´ä¸ªä»¤ç‰Œè¿›è¡Œç­¾å**ï¼Œè¯¥ç­¾åçš„ä½œç”¨æ˜¯ï¼šä¿è¯ä»¤ç‰Œä¸è¢«ä¼ªé€ å’Œç¯¡æ”¹

å®ƒä»¬ç»„åˆè€Œæˆçš„å®Œæ•´æ ¼å¼æ˜¯ï¼š`header.payload.signature`

æ¯”å¦‚ï¼Œä¸€ä¸ªå®Œæ•´çš„ JWT ä»¤ç‰Œå¦‚ä¸‹ï¼š

```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJmb28iOiJiYXIiLCJpYXQiOjE1ODc1NDgyMTV9.BCwUy3jnUQ_E6TqCayc7rCHkx-vxxdagUwPOWqwYCFc
```

å®ƒå„ä¸ªéƒ¨åˆ†çš„å€¼åˆ†åˆ«æ˜¯ï¼š

- `headerï¼šeyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9`
- `payloadï¼šeyJmb28iOiJiYXIiLCJpYXQiOjE1ODc1NDgyMTV9`
- `signature: BCwUy3jnUQ_E6TqCayc7rCHkx-vxxdagUwPOWqwYCFc`

ä¸‹é¢åˆ†åˆ«å¯¹æ¯ä¸ªéƒ¨åˆ†è¿›è¡Œè¯´æ˜

### header

å®ƒæ˜¯ä»¤ç‰Œå¤´éƒ¨ï¼Œè®°å½•äº†æ•´ä¸ª**ä»¤ç‰Œçš„ç±»å‹å’Œç­¾åç®—æ³•**

**å®ƒçš„æ ¼å¼æ˜¯ä¸€ä¸ª JSON å¯¹è±¡**ï¼Œå¦‚ä¸‹ï¼š

```json
{ "alg": "HS256", "typ": "JWT" }
```

è¯¥å¯¹è±¡è®°å½•äº†ï¼š

- algï¼šsignature éƒ¨åˆ†ä½¿ç”¨çš„ç­¾åç®—æ³•ï¼Œé€šå¸¸å¯ä»¥å–ä¸¤ä¸ªå€¼
  - **HS256ï¼šä¸€ç§å¯¹ç§°åŠ å¯†ç®—æ³•ï¼Œä½¿ç”¨åŒä¸€ä¸ªç§˜é’¥å¯¹ signature åŠ å¯†è§£å¯†**
  - **RS256ï¼šä¸€ç§éå¯¹ç§°åŠ å¯†ç®—æ³•ï¼Œä½¿ç”¨ç§é’¥ç­¾åï¼Œå…¬é’¥éªŒè¯**
- typï¼šæ•´ä¸ªä»¤ç‰Œçš„ç±»å‹ï¼Œå›ºå®šå†™`JWT`å³å¯

è®¾ç½®å¥½äº† `header` ä¹‹åï¼Œå°±å¯ä»¥ç”Ÿæˆ `header` éƒ¨åˆ†äº†

å…·ä½“çš„ç”Ÿæˆæ–¹å¼åŠå…¶ç®€å•ï¼Œ**å°±æ˜¯æŠŠ`header`éƒ¨åˆ†ä½¿ç”¨`base64 url`ç¼–ç **å³å¯

> base64url ä¸æ˜¯ä¸€ä¸ªåŠ å¯†ç®—æ³•ï¼Œè€Œæ˜¯ä¸€ç§ç¼–ç æ–¹å¼ï¼Œå®ƒæ˜¯åœ¨ base64 ç®—æ³•çš„åŸºç¡€ä¸Šå¯¹ +ã€=ã€/ ä¸‰ä¸ªå­—ç¬¦åšå‡ºç‰¹æ®Šå¤„ç†çš„ç®—æ³•
>
> è€Œ`base64`æ˜¯ä½¿ç”¨ 64 ä¸ªå¯æ‰“å°å­—ç¬¦æ¥è¡¨ç¤ºä¸€ä¸ªäºŒè¿›åˆ¶æ•°æ®ï¼Œå…·ä½“çš„åšæ³•å‚è€ƒ[ç™¾åº¦ç™¾ç§‘](https://baike.baidu.com/item/base64/8545775?fr=aladdin)

æµè§ˆå™¨æä¾›äº† `btoa` å‡½æ•°ï¼Œå¯ä»¥å®Œæˆè¿™ä¸ªæ“ä½œï¼š

```js
window.btoa(
  JSON.stringify({
    alg: "HS256",
    typ: "JWT",
  })
);
// å¾—åˆ°å­—ç¬¦ä¸²ï¼šeyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9
```

åŒæ ·çš„ï¼Œæµè§ˆå™¨ä¹Ÿæä¾›äº† `atob` å‡½æ•°ï¼Œå¯ä»¥å¯¹å…¶è¿›è¡Œè§£ç ï¼š

```js
window.atob("eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9");
// å¾—åˆ°å­—ç¬¦ä¸²ï¼š{"alg":"HS256","typ":"JWT"}
```

> nodejs ä¸­æ²¡æœ‰æä¾›è¿™ä¸¤ä¸ªå‡½æ•°ï¼Œå¯ä»¥å®‰è£…ç¬¬ä¸‰æ–¹åº“æˆ–ä½¿ç”¨ Buffer å®ç°ã€‚

### payload

**è¿™éƒ¨åˆ†æ˜¯ JWT çš„ä¸»ä½“ä¿¡æ¯ï¼Œå®ƒä»ç„¶æ˜¯ä¸€ä¸ª JSON å¯¹è±¡**ï¼Œå®ƒå¯ä»¥åŒ…å«ä»¥ä¸‹å†…å®¹ï¼š

```json
{
  "ss"ï¼š"å‘è¡Œè€…",
  "iat"ï¼š"å‘å¸ƒæ—¶é—´",
  "exp"ï¼š"åˆ°æœŸæ—¶é—´",
  "sub"ï¼š"ä¸»é¢˜",
  "aud"ï¼š"å¬ä¼—",
  "nbf"ï¼š"åœ¨æ­¤ä¹‹å‰ä¸å¯ç”¨",
  "jti"ï¼š"JWT ID"
}
```

ä»¥ä¸Šå±æ€§å¯ä»¥å…¨å†™ï¼Œä¹Ÿå¯ä»¥ä¸€ä¸ªéƒ½ä¸å†™ï¼Œå®ƒåªæ˜¯ä¸€ä¸ªè§„èŒƒï¼Œå°±ç®—å†™äº†ï¼Œä¹Ÿéœ€è¦ä½ åœ¨å°†æ¥éªŒè¯è¿™ä¸ª JWT ä»¤ç‰Œæ—¶æ‰‹åŠ¨å¤„ç†æ‰èƒ½å‘æŒ¥ä½œç”¨

ä¸Šè¿°å±æ€§è¡¨è¾¾çš„å«ä¹‰åˆ†åˆ«æ˜¯ï¼š

- ssï¼šå‘è¡Œè¯¥ JWT çš„æ˜¯è°ï¼Œå¯ä»¥å†™å…¬å¸åå­—ï¼Œä¹Ÿå¯ä»¥å†™æœåŠ¡åç§°
- iatï¼šè¯¥ JWT çš„å‘æ”¾æ—¶é—´ï¼Œé€šå¸¸å†™å½“å‰æ—¶é—´çš„æ—¶é—´æˆ³
- expï¼šè¯¥ JWT çš„**åˆ°æœŸæ—¶é—´**ï¼Œé€šå¸¸å†™æ—¶é—´æˆ³
- subï¼šè¯¥ JWT æ˜¯ç”¨äºå¹²å˜›çš„
- audï¼šè¯¥ JWT æ˜¯å‘æ”¾ç»™å“ªä¸ªç»ˆç«¯çš„ï¼Œå¯ä»¥æ˜¯ç»ˆç«¯ç±»å‹ï¼Œä¹Ÿå¯ä»¥æ˜¯ç”¨æˆ·åç§°ï¼Œéšæ„ä¸€ç‚¹
- nbfï¼šä¸€ä¸ªæ—¶é—´ç‚¹ï¼Œåœ¨è¯¥æ—¶é—´ç‚¹åˆ°è¾¾ä¹‹å‰ï¼Œè¿™ä¸ªä»¤ç‰Œæ˜¯ä¸å¯ç”¨çš„
- jtiï¼šJWT çš„å”¯ä¸€ç¼–å·ï¼Œè®¾ç½®æ­¤é¡¹çš„ç›®çš„ï¼Œä¸»è¦æ˜¯ä¸ºäº†é˜²æ­¢é‡æ”¾æ”»å‡»ï¼ˆé‡æ”¾æ”»å‡»æ˜¯åœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œç”¨æˆ·ä½¿ç”¨ä¹‹å‰çš„ä»¤ç‰Œå‘é€åˆ°æœåŠ¡å™¨ï¼Œè¢«æœåŠ¡å™¨æ­£ç¡®çš„è¯†åˆ«ï¼Œä»è€Œå¯¼è‡´ä¸å¯é¢„æœŸçš„è¡Œä¸ºå‘ç”Ÿï¼‰

å¯æ˜¯åˆ°ç°åœ¨ï¼Œçœ‹äº†åŠå¤©ï¼Œæ²¡æœ‰å‡ºç°æˆ‘æƒ³è¦å†™å…¥çš„æ•°æ®å•Š ğŸ˜‚

å½“ç”¨æˆ·ç™»é™†æˆåŠŸä¹‹åï¼Œæˆ‘å¯èƒ½éœ€è¦æŠŠç”¨æˆ·çš„ä¸€äº›ä¿¡æ¯å†™å…¥åˆ° JWT ä»¤ç‰Œä¸­ï¼Œæ¯”å¦‚ç”¨æˆ· idã€è´¦å·ç­‰ç­‰ï¼ˆå¯†ç å°±ç®—äº† ğŸ˜³ï¼‰

å…¶å®å¾ˆç®€å•ï¼Œ**payload è¿™ä¸€éƒ¨åˆ†åªæ˜¯ä¸€ä¸ª json å¯¹è±¡è€Œå·²ï¼Œä½ å¯ä»¥å‘å¯¹è±¡ä¸­åŠ å…¥ä»»ä½•æƒ³è¦åŠ å…¥çš„ä¿¡æ¯**

æ¯”å¦‚ï¼Œä¸‹é¢çš„ json å¯¹è±¡ä»ç„¶æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ payload

```json
{
  "foo": "bar",
  "iat": 1587548215
}
```

`foo: bar`æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„ä¿¡æ¯ï¼Œ`iat: 1587548215`æ˜¯ JWT è§„èŒƒä¸­çš„ä¿¡æ¯

æœ€ç»ˆï¼Œpayload éƒ¨åˆ†å’Œ header ä¸€æ ·ï¼Œ**éœ€è¦é€šè¿‡ base64url ç¼–ç å¾—åˆ°**ï¼š

```js
window.btoa(
  JSON.stringify({
    foo: "bar",
    iat: 1587548215,
  })
);
// å¾—åˆ°å­—ç¬¦ä¸²ï¼šeyJmb28iOiJiYXIiLCJpYXQiOjE1ODc1NDgyMTV9
```

### signature

è¿™ä¸€éƒ¨åˆ†æ˜¯ JWT çš„ç­¾åï¼Œæ­£æ˜¯å®ƒçš„å­˜åœ¨ï¼Œä¿è¯äº†æ•´ä¸ª JWT ä¸è¢«ç¯¡æ”¹

è¿™éƒ¨åˆ†çš„ç”Ÿæˆï¼Œæ˜¯å¯¹**å‰é¢ä¸¤ä¸ªéƒ¨åˆ†çš„ç¼–ç ç»“æœï¼ŒæŒ‰ç…§å¤´éƒ¨æŒ‡å®šçš„æ–¹å¼è¿›è¡Œç­¾å**

æ¯”å¦‚ï¼šå¤´éƒ¨æŒ‡å®šçš„åŠ å¯†æ–¹æ³•æ˜¯`HS256`ï¼Œå‰é¢ä¸¤éƒ¨åˆ†çš„ç¼–ç ç»“æœæ˜¯`eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJmb28iOiJiYXIiLCJpYXQiOjE1ODc1NDgyMTV9`

åˆ™ç¬¬ä¸‰éƒ¨åˆ†å°±æ˜¯ç”¨å¯¹ç§°ç®—æ³• `HS256` å¯¹å­—ç¬¦ä¸²è¿›è¡Œç­¾åï¼ˆHMAC-SHA256ï¼‰ï¼Œéœ€æŒ‡å®šä¸€ä¸ªå¯†é’¥ã€‚

```js
HS256(
  `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJmb28iOiJiYXIiLCJpYXQiOjE1ODc1NDgyMTV9`,
  "shhhhh"
);
// å¾—åˆ°ï¼šBCwUy3jnUQ_E6TqCayc7rCHkx-vxxdagUwPOWqwYCFc
```

æœ€ç»ˆï¼Œå°†ä¸‰éƒ¨åˆ†ç»„åˆåœ¨ä¸€èµ·ï¼Œå°±å¾—åˆ°äº†å®Œæ•´çš„ JWT

```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJmb28iOiJiYXIiLCJpYXQiOjE1ODc1NDgyMTV9.BCwUy3jnUQ_E6TqCayc7rCHkx-vxxdagUwPOWqwYCFc
```

ç”±äº**ç­¾åä½¿ç”¨çš„å¯†é’¥ä¿å­˜åœ¨æœåŠ¡å™¨ï¼Œè¿™æ ·ä¸€æ¥ï¼Œå®¢æˆ·ç«¯å°±æ— æ³•ä¼ªé€ å‡ºç­¾åï¼Œå› ä¸ºå®ƒæ‹¿ä¸åˆ°å¯†é’¥ã€‚**

æ¢å¥è¯è¯´ï¼Œä¹‹æ‰€ä»¥è¯´æ— æ³•ä¼ªé€  JWTï¼Œå°±æ˜¯å› ä¸ºç¬¬ä¸‰éƒ¨åˆ†çš„å­˜åœ¨ã€‚

è€Œ**å‰é¢ä¸¤éƒ¨åˆ†å¹¶æ²¡æœ‰åŠ å¯†ï¼Œåªæ˜¯ä¸€ä¸ªç¼–ç ç»“æœè€Œå·²ï¼Œå¯ä»¥è®¤ä¸ºå‡ ä¹æ˜¯æ˜æ–‡ä¼ è¾“**

> è¿™ä¸ä¼šé€ æˆå¤ªå¤§çš„é—®é¢˜ï¼Œå› ä¸ºæ—¢ç„¶ç”¨æˆ·ç™»é™†æˆåŠŸäº†ï¼Œå®ƒå½“ç„¶æœ‰æƒåŠ›æŸ¥çœ‹è‡ªå·±çš„ç”¨æˆ·ä¿¡æ¯
>
> ç”šè‡³åœ¨æŸäº›ç½‘ç«™ï¼Œç”¨æˆ·çš„åŸºæœ¬ä¿¡æ¯å¯ä»¥è¢«ä»»ä½•äººæŸ¥çœ‹
>
> ä½ è¦ä¿è¯çš„ï¼Œæ˜¯ä¸è¦**æŠŠæ•æ„Ÿçš„ä¿¡æ¯å­˜æ”¾åˆ° JWT ä¸­ï¼Œæ¯”å¦‚å¯†ç **

JWT çš„`signature`å¯ä»¥ä¿è¯ä»¤ç‰Œä¸è¢«ä¼ªé€ ï¼Œé‚£å¦‚ä½•ä¿è¯ä»¤ç‰Œä¸è¢«ç¯¡æ”¹å‘¢ï¼Ÿ

æ¯”å¦‚ï¼ŒæŸä¸ªç”¨æˆ·ç™»é™†æˆåŠŸäº†ï¼Œè·å¾—äº† JWTï¼Œä½†ä»–äººä¸ºçš„ç¯¡æ”¹äº†`payload`ï¼Œæ¯”å¦‚æŠŠè‡ªå·±çš„è´¦æˆ·ä½™é¢ä¿®æ”¹ä¸ºåŸæ¥çš„ä¸¤å€ï¼Œç„¶åé‡æ–°ç¼–ç å‡º`payload`å‘é€åˆ°æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨å¦‚ä½•å¾—çŸ¥è¿™äº›ä¿¡æ¯è¢«ç¯¡æ”¹è¿‡äº†å‘¢ï¼Ÿ

è¿™å°±è¦è¯´åˆ°ä»¤ç‰Œçš„éªŒè¯äº†

## ç”Ÿæˆä¸éªŒè¯ç¤ºä¾‹ï¼ˆNode.jsï¼‰

```js
const crypto = require("crypto");

function base64url(input) {
  return Buffer.from(input)
    .toString("base64")
    .replace(/=/g, "")
    .replace(/\+/g, "-")
    .replace(/\//g, "_");
}

function signHS256(data, secret) {
  return crypto
    .createHmac("sha256", secret)
    .update(data)
    .digest("base64")
    .replace(/=/g, "")
    .replace(/\+/g, "-")
    .replace(/\//g, "_");
}

function createToken(payload, secret) {
  const header = { alg: "HS256", typ: "JWT" };
  const h = base64url(JSON.stringify(header));
  const p = base64url(JSON.stringify(payload));
  const s = signHS256(`${h}.${p}`, secret);
  return `${h}.${p}.${s}`;
}

function verifyToken(token, secret) {
  const [h, p, s] = token.split(".");
  if (!h || !p || !s) return { ok: false, reason: "format" };
  const expect = signHS256(`${h}.${p}`, secret);
  if (expect !== s) return { ok: false, reason: "signature" };
  const payload = JSON.parse(
    Buffer.from(p.replace(/-/g, "+").replace(/_/g, "/"), "base64").toString(
      "utf8"
    )
  );
  const now = Math.floor(Date.now() / 1000);
  if (payload.nbf && now < payload.nbf) return { ok: false, reason: "nbf" };
  if (payload.exp && now >= payload.exp) return { ok: false, reason: "exp" };
  return { ok: true, payload };
}

const secret = "shhhhh";
const payload = {
  sub: "user:123",
  iat: Math.floor(Date.now() / 1000),
  exp: Math.floor(Date.now() / 1000) + 3600,
};
const token = createToken(payload, secret);
const res = verifyToken(token, secret);
```

::: warning ç®—æ³•ä¸ç¯å¢ƒ

- æµè§ˆå™¨ç¯å¢ƒå¯ä½¿ç”¨ Web Crypto API å®ç° HMAC/RSASSA-PKCS1-v1_5ï¼›ç¤ºä¾‹åŸºäº Node.js æ ‡å‡†åº“ã€‚
- `RS256` éœ€ç®¡ç†ç§é’¥/å…¬é’¥ï¼Œæ”¯æŒæ’¤é”€ä¸è½®æ¢ï¼›`HS256` å¯†é’¥å…±äº«ï¼Œé€‚åˆå•æœåŠ¡æˆ–é›†ä¸­å¯†é’¥ç®¡ç†ã€‚
  :::

## ä»¤ç‰Œçš„éªŒè¯

![](http://mdrs.yuanjin.tech/img/image-20200422172837190.png)

ä»¤ç‰Œåœ¨æœåŠ¡å™¨ç»„è£…å®Œæˆåï¼Œä¼šä»¥ä»»æ„çš„æ–¹å¼å‘é€åˆ°å®¢æˆ·ç«¯

å®¢æˆ·ç«¯ä¼šæŠŠä»¤ç‰Œä¿å­˜èµ·æ¥ï¼Œåç»­çš„è¯·æ±‚ä¼šå°†ä»¤ç‰Œå‘é€ç»™æœåŠ¡å™¨

è€ŒæœåŠ¡å™¨éœ€è¦éªŒè¯ä»¤ç‰Œæ˜¯å¦æ­£ç¡®ï¼Œå¦‚ä½•éªŒè¯å‘¢ï¼Ÿ

é¦–å…ˆï¼ŒæœåŠ¡å™¨è¦éªŒè¯è¿™ä¸ªä»¤ç‰Œæ˜¯å¦è¢«ç¯¡æ”¹è¿‡ï¼ŒéªŒè¯æ–¹å¼éå¸¸ç®€å•ï¼Œ**å°±æ˜¯å¯¹`header+payload`ç”¨åŒæ ·çš„ç§˜é’¥å’ŒåŠ å¯†ç®—æ³•è¿›è¡Œé‡æ–°åŠ å¯†**

**ç„¶åæŠŠåŠ å¯†çš„ç»“æœå’Œä¼ å…¥ JWT çš„`signature`è¿›è¡Œå¯¹æ¯”**ï¼Œå¦‚æœå®Œå…¨ç›¸åŒï¼Œåˆ™è¡¨ç¤ºå‰é¢ä¸¤éƒ¨åˆ†æ²¡æœ‰åŠ¨è¿‡ï¼Œå°±æ˜¯è‡ªå·±é¢å‘çš„ï¼Œå¦‚æœä¸åŒï¼Œè‚¯å®šæ˜¯è¢«ç¯¡æ”¹è¿‡äº†ã€‚

```
ä¼ å…¥çš„header.ä¼ å…¥çš„payload.ä¼ å…¥çš„signature
æ–°çš„signature = headerä¸­çš„åŠ å¯†ç®—æ³•(ä¼ å…¥çš„header.ä¼ å…¥çš„payload, ç§˜é’¥)
éªŒè¯ï¼šæ–°çš„signature == ä¼ å…¥çš„signature
```

å½“ä»¤ç‰ŒéªŒè¯ä¸ºæ²¡æœ‰è¢«ç¯¡æ”¹åï¼ŒæœåŠ¡å™¨å¯ä»¥è¿›è¡Œå…¶ä»–éªŒè¯ï¼šæ¯”å¦‚æ˜¯å¦è¿‡æœŸã€å¬ä¼—æ˜¯å¦æ»¡è¶³è¦æ±‚ç­‰ç­‰ï¼Œè¿™äº›å°±è§†æƒ…å†µè€Œå®šäº†

æ³¨æ„ï¼šè¿™äº›éªŒè¯éƒ½éœ€è¦æœåŠ¡å™¨æ‰‹åŠ¨å®Œæˆï¼›ç¬¬ä¸‰æ–¹åº“ï¼ˆå¦‚ `jsonwebtoken`ï¼‰æä¾›ç­¾åä¸åŸºç¡€æ ¡éªŒï¼Œå…·ä½“ç­–ç•¥ç”±ä¸šåŠ¡æ§åˆ¶ã€‚

::: tip å¸¸ç”¨å£°æ˜ä¸ä½œç”¨

- `iss` å‘è¡Œè€…ã€`aud` å¬ä¼—ï¼šé™å®šä»¤ç‰Œæ¥æºä¸ä½¿ç”¨æ–¹ã€‚
- `exp` è¿‡æœŸæ—¶é—´ã€`nbf` ç”Ÿæ•ˆæ—¶é—´ã€`iat` ç­¾å‘æ—¶é—´ï¼šæ§åˆ¶æ—¶æ•ˆæ€§ä¸é˜²é‡æ”¾çª—å£ã€‚
- `jti` å”¯ä¸€ IDï¼šç»“åˆæœåŠ¡ç«¯é»‘åå•/æ’¤é”€åˆ—è¡¨å®ç°å¤±æ•ˆä¸è¸¢å‡ºã€‚
  :::

::: danger å®‰å…¨æ³¨æ„

- ä¸åœ¨ `payload` å­˜æ”¾æ•æ„Ÿæ•°æ®ï¼›`payload` éåŠ å¯†ã€‚
- HTTPS ä¼ è¾“ï¼Œé˜²æ­¢ä¸­é—´äººçªƒå¬ä¸ç¯¡æ”¹ã€‚
- å¦¥å–„ç®¡ç†å¯†é’¥ï¼Œæ”¯æŒè½®æ¢ä¸æ’¤é”€ï¼›åŒºåˆ†æµ‹è¯•ä¸ç”Ÿäº§å¯†é’¥ã€‚
- ä¸ Cookie ç»“åˆæ—¶ï¼Œå»ºè®®ä½¿ç”¨ `HttpOnly/Secure/SameSite`ï¼›é˜²èŒƒ XSS/CSRFã€‚
  :::

## æ€»ç»“

æœ€åï¼Œæ€»ç»“ä¸€ä¸‹ JWT çš„ç‰¹ç‚¹ï¼š

- **JWT æœ¬è´¨ä¸Šæ˜¯ä¸€ç§ä»¤ç‰Œæ ¼å¼**ã€‚å®ƒå’Œç»ˆç«¯è®¾å¤‡æ— å…³ï¼ŒåŒæ ·å’ŒæœåŠ¡å™¨æ— å…³ï¼Œç”šè‡³ä¸å¦‚ä½•ä¼ è¾“æ— å…³ï¼Œå®ƒåªæ˜¯è§„èŒƒäº†ä»¤ç‰Œçš„æ ¼å¼è€Œå·²
- JWT ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼šheaderã€payloadã€signatureã€‚ä¸»ä½“ä¿¡æ¯åœ¨ payload
- JWT éš¾ä»¥è¢«ç¯¡æ”¹å’Œä¼ªé€ ã€‚è¿™æ˜¯å› ä¸ºæœ‰ç¬¬ä¸‰éƒ¨åˆ†çš„ç­¾åå­˜åœ¨ã€‚

::: details é€‚ç”¨åœºæ™¯ä¸æ›¿ä»£

- é€‚åˆè·¨ç«¯ä¸åˆ†å¸ƒå¼åœºæ™¯çš„æ— çŠ¶æ€é‰´æƒï¼›æºå¸¦åŸºç¡€èº«ä»½/æƒé™ä¿¡æ¯ã€‚
- ç»“åˆçŸ­æœŸä»¤ç‰Œä¸åˆ·æ–°ä»¤ç‰Œæœºåˆ¶ï¼Œé™ä½æ³„éœ²é£é™©ä¸æå‡ç»­æœŸä½“éªŒã€‚
- å¯¹äºéœ€è¦å¯æ’¤é”€ã€ç»†ç²’åº¦ä¼šè¯æ§åˆ¶çš„åœºæ™¯ï¼Œå¯ç»“åˆæœåŠ¡ç«¯ä¼šè¯è¡¨ã€Token é»‘åå•æˆ–é‡‡ç”¨æœåŠ¡å™¨å­˜å‚¨ä¼šè¯çš„æ–¹æ¡ˆã€‚
  :::

## é¢è¯•é¢˜

è¯·é˜è¿° JWT çš„ä»¤ç‰Œæ ¼å¼

> å‚è€ƒç­”æ¡ˆï¼š
>
> token åˆ†ä¸ºä¸‰æ®µï¼Œåˆ†åˆ«æ˜¯ headerã€payloadã€signature
>
> å…¶ä¸­ï¼Œheader æ ‡è¯†ç­¾åç®—æ³•å’Œä»¤ç‰Œç±»å‹ï¼›payload æ ‡è¯†ä¸»ä½“ä¿¡æ¯ï¼ŒåŒ…å«**ä»¤ç‰Œè¿‡æœŸæ—¶é—´**ã€å‘å¸ƒæ—¶é—´ã€å‘è¡Œè€…ã€**ä¸»ä½“å†…å®¹**ç­‰ï¼›signature æ˜¯ä½¿ç”¨ç‰¹å®šçš„ç®—æ³•å¯¹å‰é¢ä¸¤éƒ¨åˆ†è¿›è¡ŒåŠ å¯†ï¼Œå¾—åˆ°çš„åŠ å¯†ç»“æœã€‚
>
> token æœ‰é˜²ç¯¡æ”¹çš„ç‰¹ç‚¹ï¼Œå¦‚æœ**æ”»å‡»è€…æ”¹åŠ¨äº†å‰é¢ä¸¤ä¸ªéƒ¨åˆ†ï¼Œå°±ä¼šå¯¼è‡´å’Œç¬¬ä¸‰éƒ¨åˆ†å¯¹åº”ä¸ä¸Šï¼Œä½¿å¾— token å¤±æ•ˆã€‚è€Œæ”»å‡»è€…ä¸çŸ¥é“åŠ å¯†ç§˜é’¥ï¼Œå› æ­¤åˆæ— æ³•ä¿®æ”¹ç¬¬ä¸‰éƒ¨åˆ†çš„å€¼ã€‚**
>
> æ‰€ä»¥ï¼Œåœ¨ç§˜é’¥ä¸è¢«æ³„éœ²çš„å‰æä¸‹ï¼Œä¸€ä¸ªéªŒè¯é€šè¿‡çš„ token æ˜¯å€¼å¾—è¢«ä¿¡ä»»çš„ã€‚
