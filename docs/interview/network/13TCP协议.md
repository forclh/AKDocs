# ✨ TCP

![](http://mdrs.yuanjin.tech/img/20211008163417.png)

![](http://mdrs.yuanjin.tech/img/20211008163458.png)

## TCP 收发数据流程

![](http://mdrs.yuanjin.tech/img/20211021122224.png)

## TCP 如何收发数据

### 分段发送

![](http://mdrs.yuanjin.tech/img/20211021123315.png)

### 可靠传输

在 TCP 协议中，任何时候、任何一方都可以主动发送数据给另一方

为了解决**数据报丢失、数据报错乱**等问题，TCP 协议要求：**接收方收到数据报后，必须对数据报进行确认！**

![](http://mdrs.yuanjin.tech/img/20211021124852.png)

-   seq：表示**这次数据报的序号**
-   ACK：表示**这次数据报是一个确认数据报**（ACK=1 表示确认）
-   ack：表示**期望下一次接收的数据报序号**

发送方如果长时间没有收到确认数据报（ACK=1），则会判定丢失或者是错误，然后重发

## 连接的建立（三次握手）

**TCP 协议要实现数据的收发，必须要先建立连接**

连接的本质其实就是双方各自开辟的一块儿内存空间，空间中主要是数据缓冲区和一些变量

![](http://mdrs.yuanjin.tech/img/20211021125708.png)

**连接建立的过程需要经过三次数据报传输，因此称之为三次握手**

> 开始
>
> 客户端：我说话能听见吗？
>
> 服务器：能听见，我说话能听见吗？
>
> 客户端：能听见
>
> 结束

![](http://mdrs.yuanjin.tech/img/20211021131710.png)

对于 TCP 来说，**发起连接的叫做客户端，服务器是接受连接的**，建立连接之后，双方就可以互相发送，此时没有客户端和服务器的概念。

## 连接的销毁（四次挥手）

> 开始
>
> 客户端：我说完了，挂了？
>
> 服务器：我明白你说完了，但别忙挂，我还有话要说。
>
> 服务器继续说……
>
> 服务器：我也说完了，挂了？
>
> 客户端：好的！
>
> 结束

![](http://mdrs.yuanjin.tech/img/20211021143028.png)

为什么客户端最后要等待 2MSL（数据一个来回的时间）的时间才关闭连接？

为了**防止最后服务器没有收到客户端给服务器发送的确认服务器终止连接的消息**，而一直重发（此时的客户端已经关闭）

## HTTP 和 TCP 的关系

![](http://mdrs.yuanjin.tech/img/20211021134242.png)

**HTTP 协议是对内容格式的规定**，它**使用**了 TCP 协议完成消息的可靠传输

在具体使用 TCP 协议时：

1. 客户端发消息给服务器叫做请求，服务器发消息给客户端叫做响应
2. **使用 HTTP 协议的服务器不会主动发消息给客户端（尽管 TCP 可以），只对请求进行响应**
3. **每一个 HTTP 请求-响应**，都要先建立 TCP 连接（三次握手），然后完成请求-响应后，再销毁连接（四次挥手）。这就导致**每次请求-响应都是相互独立的，无法保持状态**（HTTP 是无状态的协议）。

为什么每次请求都要重新建立连接，而不是建立一次连接后，后续就不断开呢？：为了节约服务器资源，因为每一个连接，服务器都需要开辟一块内存空间进行存储，如果有很多的客户端，那这个资源的开销是很大的。（时间换空间）。

为什么 HTTP 协议是无状态的协议？

因为**HTTP 是倚靠 TCP 协议进行数据传输**的，HTTP 只规定数据的格式，而再每一次的请求中 TCP 协议都需要经过三次握手，数据传输、四次挥手的过程，使得**每一次的传输都是独立的**，因此无法保持状态。

## 面试题

1. 简述 TCP 连接的过程（淘系）

    > 参考答案：
    >
    > TCP 协议通过三次握手建立可靠的点对点连接，具体过程是：
    >
    > 首先服务器进入监听状态，然后即可处理连接
    >
    > 第一次握手：建立连接时，**客户端发送 syn 包到服务器**，并进入 SYN_SENT 状态，等待服务器确认。在发送的包中还会包含一个初始序列号 seq。此次握手的含义是**客户端希望与服务器建立连接**。
    >
    > 第二次握手：服务器收到 syn 包，然后**回应给客户端一个 SYN+ACK 包**，此时服务器进入 SYN_RCVD 状态。此次握手的含义是**服务端回应客户端，表示已收到并同意客户端的连接请求**。
    >
    > 第三次握手：客户端收到**服务器的 SYN 包后，向服务器再次发送 ACK 包**，并进入 ESTAB_LISHED 状态。
    >
    > 最后，服务端收到客户端的 ACK 包，于是也进入 ESTAB_LISHED 状态，至此，连接建立完成

2. 谈谈你对 TCP 三次握手和四次挥手的理解

    > TCP 协议通过三次握手建立可靠的点对点连接，具体过程是：
    >
    > 首先服务器进入监听状态，然后即可处理连接
    >
    > 第一次握手：建立连接时，客户端发送 syn 包到服务器，并进入 SYN_SENT 状态，等待服务器确认。在发送的包中还会包含一个初始序列号 seq。此次握手的含义是客户端希望与服务器建立连接。
    >
    > 第二次握手：服务器收到 syn 包，然后回应给客户端一个 SYN+ACK 包，此时服务器进入 SYN_RCVD 状态。此次握手的含义是服务端回应客户端，表示已收到并同意客户端的连接请求。
    >
    > 第三次握手：客户端收到服务器的 SYN 包后，向服务器再次发送 ACK 包，并进入 ESTAB_LISHED 状态。
    >
    > 最后，服务端收到客户端的 ACK 包，于是也进入 ESTAB_LISHED 状态，至此，连接建立完成
    >
    > 当需要关闭连接时，需要进行四次挥手才能关闭
    >
    > 1. **Client 向 Server 发送 FIN 包，表示 Client 主动要关闭连接**，然后进入 FIN_WAIT_1 状态，**等待 Server 返回 ACK 包**。此后 Client 不能再向 Server 发送数据，但能读取数据。
    > 2. **Server 收到 FIN 包后向 Client 发送 ACK 包**，然后进入 CLOSE_WAIT 状态，此后 Server 不能再读取数据，但可以继续向 Client 发送数据。
    > 3. Client 收到 Server 返回的 ACK 包后进入 FIN_WAIT_2 状态，等待 Server 发送 FIN 包。
    > 4. Server 完成数据的发送后，将 FIN 包发送给 Client，然后进入 LAST_ACK 状态，等待 Client 返回 ACK 包，此后 Server 既不能读取数据，也不能发送数据。
    > 5. Client 收到 FIN 包后向 Server 发送 ACK 包，然后进入 TIME_WAIT 状态，接着等待足够长的时间（2MSL）以确保 Server 接收到 ACK 包，最后回到 CLOSED 状态，释放网络资源。
    > 6. Server 收到 Client 返回的 ACK 包后便回到 CLOSED 状态，释放网络资源。
