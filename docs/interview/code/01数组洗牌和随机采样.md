# âœ¨ æ•°ç»„æ´—ç‰Œä¸éšæœºé‡‡æ · ğŸ‘Œ

[[TOC]]

::: tip è¦ç‚¹é€Ÿè§ˆ

- å…¬å¹³æ´—ç‰Œé¦–é€‰ Fisherâ€“Yatesï¼šæ—¶é—´ `O(n)`ã€ç©ºé—´ `O(1)`ã€åŸåœ°äº¤æ¢ï¼Œæ¦‚ç‡å‡åŒ€ã€‚
- è¯¯åŒºï¼š`array.sort(() => Math.random() - 0.5)` ä¸å…¬å¹³ä¸”æ—¶é—´å¤æ‚åº¦ä¸º `O(n log n)`ã€‚
- éšæœºé‡‡æ · K ä¸ªä¸é‡å¤å…ƒç´ ï¼šæ‰§è¡Œæ´—ç‰Œçš„å‰ K æ¬¡è¿­ä»£æˆ–ç”¨è“„æ°´æ± é‡‡æ ·ï¼ˆæµå¼åœºæ™¯ï¼‰ã€‚
- å®æˆ˜å»ºè®®ï¼šå°è£… `shuffle` ä¸ `sampleK`ï¼Œæä¾›å¯é€‰ `rng` ä¸ç§å­ï¼Œä¾¿äºæµ‹è¯•ä¸å›æ”¾ã€‚
  :::

## å¿«é€Ÿä¸Šæ‰‹

æœ€å°å¯ç”¨å®ç°ä¸ç”¨æ³•ç¤ºä¾‹ï¼š

```js
// Fisherâ€“Yates æ´—ç‰Œï¼ˆåŸåœ°æ“ä½œï¼‰
export function shuffle(array, rng = Math.random) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(rng() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}

// é‡‡æ · K ä¸ªä¸é‡å¤å…ƒç´ ï¼ˆæ‹·è´ + å‰ K æ¬¡è¿­ä»£ï¼‰
export function sampleK(arr, k, rng = Math.random) {
  const copy = [...arr];
  const n = copy.length;
  if (k > n) throw new Error("k ä¸èƒ½å¤§äºæ•°ç»„é•¿åº¦");
  for (let i = 0; i < k; i++) {
    const j = Math.floor(rng() * (n - i)) + i; // [i, n-1]
    [copy[i], copy[j]] = [copy[j], copy[i]];
  }
  return copy.slice(0, k);
}

// ä½¿ç”¨ç¤ºä¾‹
console.log(shuffle([1, 2, 3, 4, 5]));
console.log(sampleK(["A", "B", "C", "D", "E"], 3));
```

::: warning æ­£ç¡®å¿ƒæ™ºæ¨¡å‹

- â€œå…¬å¹³â€æŒ‡ç®—æ³•å¯¹æ¯ä¸ªæ’åˆ—/ä½ç½®çš„æ¦‚ç‡ä¸€è‡´ï¼Œå‰ææ˜¯ RNG è¿‘ä¼¼å‡åŒ€ï¼ˆMath.random éåŠ å¯†ä½†è¶³å¤Ÿé¢è¯•ï¼‰ã€‚
- é‡‡æ ·çš„å‰ K æ¬¡è¿­ä»£ç­‰ä»·äºâ€œæŠŠéšæœºå…ƒç´ æ”¾åˆ°å‰é¢â€ï¼Œæ— éœ€å…¨é‡æ´—ç‰Œï¼Œå¤æ‚åº¦ O(k)ã€‚
  :::

## é¢è¯•æ ¸å¿ƒé—®é¢˜ï¼šå¦‚ä½•å®ç°å…¬å¹³çš„æ•°ç»„æ´—ç‰Œç®—æ³•

### å¸¸è§é”™è¯¯è§£æ³•åŠç¼ºé™·

- **é”™è¯¯è§£æ³•**ï¼šä½¿ç”¨æ•°ç»„`sort`æ–¹æ³•ç»“åˆ`Math.random()`å®ç°æ´—ç‰Œ
- **ä¸¤å¤§è‡´å‘½ç¼ºé™·**
  1. **æ¦‚ç‡ä¸å…¬å¹³**ï¼šæ•°å­¦ä¸Šæ— æ³•ä¿è¯æ¯ä¸ªå…ƒç´ å‡ºç°åœ¨ä»»æ„ä½ç½®çš„æ¦‚ç‡ç›¸ç­‰ï¼ˆå›  V8 å¼•æ“éšæœºæ€§å­˜åœ¨åå‘ï¼‰
  2. **æ€§èƒ½è¾ƒå·®**ï¼šæ’åºç®—æ³•æ—¶é—´å¤æ‚åº¦é€šå¸¸ä¸º`O(n log n)`ï¼Œä¸ç¬¦åˆé«˜æ•ˆè¦æ±‚

### é¢è¯•å®˜æ ¸å¿ƒè€ƒå¯Ÿç‚¹

| è€ƒå¯Ÿç»´åº¦   | å…·ä½“è¦æ±‚                                                                                            |
| ---------- | --------------------------------------------------------------------------------------------------- |
| æ¦‚ç‡å…¬å¹³   | æ´—ç‰Œåæ•°ç»„æ¯ä¸ªå…ƒç´ å‡ºç°åœ¨ä»»æ„ä½ç½®çš„æ¦‚ç‡å¿…é¡»ä¸º`1/N`ï¼ˆN ä¸ºæ•°ç»„é•¿åº¦ï¼‰ï¼Œæ— éšæœºæ€§åå·®ï¼Œæœ€å¥½èƒ½æä¾›æ•°å­¦è¯æ˜ |
| æ—¶ç©ºå¤æ‚åº¦ | æ—¶é—´å¤æ‚åº¦éœ€ä¸ºçº¿æ€§`O(n)`ï¼Œä¸”ä¸ºåŸåœ°æ“ä½œï¼ˆç©ºé—´å¤æ‚åº¦`O(1)`ï¼‰ï¼Œæ— éœ€åˆ›å»ºæ–°æ•°ç»„æµªè´¹å†…å­˜                  |

## æ»¡åˆ†è§£æ³•ï¼šè´¹é›ªè€¶å…¹ï¼ˆFisherâ€“Yatesï¼‰æ´—ç‰Œ

### ç®—æ³•æ ¸å¿ƒé€»è¾‘

- **æ ¸å¿ƒæ€æƒ³**ï¼šå€’åºéå† + éšæœºäº¤æ¢
- **å››æ­¥æ‰§è¡Œæµç¨‹**
  1. ä»æ•°ç»„æœ€åä¸€ä¸ªå…ƒç´ ï¼ˆç´¢å¼•`array.length - 1`ï¼‰å¼€å§‹å‘å‰éå†
  2. åœ¨`[0, I]`åŒºé—´ï¼ˆåŒ…å«å½“å‰éå†ç´¢å¼•`I`ï¼‰å†…éšæœºç”Ÿæˆä¸€ä¸ªç´¢å¼•`J`
  3. äº¤æ¢æ•°ç»„ä¸­ç¬¬`I`ä¸ªå…ƒç´ ä¸ç¬¬`J`ä¸ªå…ƒç´ 
  4. ç´¢å¼•`I`å‡ 1ï¼Œé‡å¤ä¸Šè¿°æ­¥éª¤ï¼Œç›´è‡³éå†å®Œæ•´ä¸ªæ•°ç»„

### ä»£ç å®ç°

```javascript
function shuffleArray(array) {
  // 1. å€’åºéå†ï¼šä»æ•°ç»„æœ«å°¾å¼€å§‹ï¼Œéå†è‡³ç´¢å¼•1ï¼ˆI > 0ï¼‰
  for (let i = array.length - 1; i > 0; i--) {
    // 2. ç”Ÿæˆéšæœºç´¢å¼•Jï¼šèŒƒå›´[0, i]ï¼Œä¹˜ä»¥i+1ç¡®ä¿åŒ…å«iï¼ŒMath.floorå‘ä¸‹å–æ•´
    const j = Math.floor(Math.random() * (i + 1));
    // 3. ES6è§£æ„èµ‹å€¼äº¤æ¢å…ƒç´ ï¼Œå®ç°åŸåœ°æ“ä½œ
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}
```

### å…¬å¹³æ€§æ•°å­¦è¯æ˜ï¼ˆæ•°å­¦å½’çº³æ³•ï¼‰

- **æ­¥éª¤ 1ï¼šè¯æ˜æœ€åä¸€ä¸ªä½ç½®ï¼ˆç´¢å¼• N-1ï¼‰**  
  éå†åˆ°æœ€åä¸€ä¸ªå…ƒç´ æ—¶ï¼Œè¯¥å…ƒç´ ä¼šä¸`[0, N-1]`åŒºé—´å†…ä»»æ„å…ƒç´ äº¤æ¢ï¼Œä»»æ„å…ƒç´ ç•™åœ¨è¯¥ä½ç½®çš„æ¦‚ç‡ä¸º`1/N`ã€‚
- **æ­¥éª¤ 2ï¼šè¯æ˜å€’æ•°ç¬¬äºŒä¸ªä½ç½®ï¼ˆç´¢å¼• N-2ï¼‰**  
  å…ƒç´ è¦ç•™åœ¨è¯¥ä½ç½®ï¼Œéœ€æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ï¼š
  1. ä¸Šä¸€è½®ï¼ˆå¤„ç†æœ€åä¸€ä¸ªå…ƒç´ æ—¶ï¼‰æœªè¢«é€‰ä¸­äº¤æ¢ï¼Œæ¦‚ç‡ä¸º`(N-1)/N`ï¼›
  2. æœ¬è½®ï¼ˆå¤„ç†å€’æ•°ç¬¬äºŒä¸ªå…ƒç´ æ—¶ï¼‰ä»å‰©ä½™`N-1`ä¸ªå…ƒç´ ä¸­è¢«é€‰ä¸­ï¼Œæ¦‚ç‡ä¸º`1/(N-1)`ï¼›
  3. æ€»æ¦‚ç‡ï¼š`(N-1)/N * 1/(N-1) = 1/N`ã€‚
- **æ­¥éª¤ 3ï¼šå½’çº³æ¨å¹¿**  
  ä»¥æ­¤ç±»æ¨ï¼Œä»»æ„å…ƒç´ å‡ºç°åœ¨ä»»æ„ä½ç½®çš„æ¦‚ç‡å‡ä¸º`1/N`ï¼Œç®—æ³•æ»¡è¶³å…¬å¹³æ€§è¦æ±‚ã€‚

::: info å¯å¤ç°å®éªŒä¸æ ¡éªŒï¼ˆé¢è¯•åŠ åˆ†ï¼‰

- é¢‘æ¬¡ç»Ÿè®¡ï¼šå¯¹é•¿åº¦ä¸º 4 çš„æ•°ç»„æ‰§è¡Œ 10000 æ¬¡æ´—ç‰Œï¼Œç»Ÿè®¡æ¯ä¸ªå…ƒç´ å‡ºç°åœ¨æ¯ä¸ªä½ç½®çš„æ¬¡æ•°åº”è¿‘ä¼¼ç›¸ç­‰ã€‚
- ç®€æ˜“å®ç°ï¼š

```js
const N = 4;
const RUNS = 10000;
// åˆå§‹åŒ–ä½ç½®ç»Ÿè®¡æ•°ç»„ï¼Œpos[i][j]è¡¨ç¤ºå…ƒç´ iå‡ºç°åœ¨ä½ç½®jçš„æ¬¡æ•°
const pos = Array.from({ length: N }, () => Array(N).fill(0));
for (let r = 0; r < RUNS; r++) {
  const a = shuffle([0, 1, 2, 3]);
  for (let i = 0; i < N; i++) pos[a[i]][i]++;
}
// æ¯ä¸ªå…ƒç´ åœ¨æ¯ä¸ªä½ç½®å‡ºç°çš„æ¬¡æ•°åº”æ¥è¿‘ RUNS/N
console.table(pos);
```

:::

## ç®—æ³•è¿›é˜¶åº”ç”¨ï¼šéšæœºæŠ½å– K ä¸ªä¸é‡å¤å…ƒç´ 

### åº”ç”¨åœºæ™¯

å¦‚â€œä» 100 ä¸ªç”¨æˆ·ä¸­éšæœºæŠ½å– 3 ä¸ªä¸­å¥–è€…â€ï¼Œæœ¬è´¨æ˜¯æ´—ç‰Œç®—æ³•çš„ç®€åŒ–ç‰ˆã€‚

### å®ç°é€»è¾‘ä¸ä»£ç 

- **æ ¸å¿ƒæ€è·¯**ï¼šä»…æ‰§è¡Œè´¹é›ªè€¶å…¹æ´—ç‰Œç®—æ³•çš„å‰`K`æ¬¡è¿­ä»£ï¼Œæ•°ç»„å‰`K`ä¸ªå…ƒç´ å³ä¸ºç»“æœã€‚
- **ä»£ç å®ç°**

```javascript
function randomSample(array, k) {
  // æ‹·è´æ–°æ•°ç»„ï¼Œé¿å…ä¿®æ”¹åŸæ•°ç»„
  const copy = [...array];
  const n = copy.length;
  // ä»…æ‰§è¡Œå‰Kæ¬¡è¿­ä»£ï¼ˆéå†0åˆ°k-1ï¼‰
  for (let i = 0; i < k; i++) {
    // ä»[i, n-1]åŒºé—´éšæœºé€‰ç´¢å¼•ï¼ˆèŒƒå›´éšè¿­ä»£ç¼©å°ï¼‰
    const j = Math.floor(Math.random() * (n - i)) + i;
    // äº¤æ¢å½“å‰iä½ç½®ä¸éšæœºjä½ç½®çš„å…ƒç´ 
    [copy[i], copy[j]] = [copy[j], copy[i]];
  }
  // æˆªå–å‰Kä¸ªå…ƒç´ ä½œä¸ºé‡‡æ ·ç»“æœ
  return copy.slice(0, k);
}
```

::: tip è¿›é˜¶ï¼šè“„æ°´æ± é‡‡æ ·ï¼ˆæœªçŸ¥ N çš„æµå¼åœºæ™¯ï¼‰

å½“å…ƒç´ æ€»æ•° N æœªçŸ¥æˆ–æ•°æ®ä»¥æµå½¢å¼åˆ°è¾¾æ—¶ï¼Œå¯ä½¿ç”¨è“„æ°´æ± é‡‡æ ·ï¼ˆReservoir Samplingï¼‰ï¼š

```js
/**
 * è“„æ°´æ± é‡‡æ ·
 * ä»æœªçŸ¥é•¿åº¦/æµå¼æ•°æ®ä¸­å‡åŒ€é‡‡æ · k ä¸ªå…ƒç´ ã€‚
 * - ç›®æ ‡ï¼šä¿è¯æ¯ä¸ªå…ƒç´ è¢«é€‰ä¸­çš„æ¦‚ç‡å‡ä¸º k / Nï¼ˆN ä¸ºæ€»å…ƒç´ æ•°ï¼‰ã€‚
 * - é€‚ç”¨ï¼šN å¾ˆå¤§æˆ–æ— æ³•ä¸€æ¬¡æ€§åŠ è½½çš„æ•°æ®æºï¼ˆè¿­ä»£å™¨ã€ç”Ÿæˆå™¨ã€æµï¼‰ã€‚
 * å‚æ•°ï¼š
 * - iterableï¼šå¯è¿­ä»£çš„æ•°æ®æº
 * - kï¼šéœ€è¦é‡‡æ ·çš„å…ƒç´ ä¸ªæ•°ï¼ˆk â‰¥ 0ï¼‰
 * - rngï¼šéšæœºæ•°å‡½æ•°ï¼Œè¿”å› [0, 1) çš„è¿‘ä¼¼å‡åŒ€éšæœºæ•°ï¼Œé»˜è®¤ Math.random
 * å¤æ‚åº¦ï¼šæ—¶é—´ O(N)ï¼Œç©ºé—´ O(k)
 */
function reservoirSample(iterable, k, rng = Math.random) {
  const res = [];
  let i = 0; // å·²å¤„ç†çš„å…ƒç´ ä¸ªæ•°ï¼ˆä» 0 å¼€å§‹è®¡æ•°ï¼‰
  for (const item of iterable) {
    if (i < k) {
      // å‰ k ä¸ªå…ƒç´ ç›´æ¥æ”¾å…¥è“„æ°´æ± 
      res[i] = item;
    } else {
      // ç¬¬ i ä¸ªå…ƒç´ ä»¥ k/(i+1) çš„æ¦‚ç‡è¿›å…¥è“„æ°´æ± ï¼š
      // åœ¨ [0, i] å‡åŒ€é€‰ jï¼Œè‹¥ j < k åˆ™æ›¿æ¢è“„æ°´æ± ä¸­ç¬¬ j ä¸ªå…ƒç´ ã€‚
      // è¯¥è®¾è®¡ä¿è¯æ¯ä¸ªå…ƒç´ æœ€ç»ˆç­‰æ¦‚ç‡è¢«ä¿ç•™åœ¨è“„æ°´æ± ä¸­ã€‚
      const j = Math.floor(rng() * (i + 1)); // j âˆˆ [0, i]
      if (j < k) res[j] = item;
    }
    i++;
  }
  return res;
}
```

- æ€æƒ³ï¼šå‰ K ä¸ªç›´æ¥å…¥æ± ï¼›ç¬¬ i ä¸ªå…ƒç´ ä»¥ k/(i+1) çš„æ¦‚ç‡æ›¿æ¢æ± ä¸­æŸå…ƒç´ ï¼Œä¿è¯æ¯ä¸ªå…ƒç´ ç­‰æ¦‚ç‡è¢«é€‰ä¸­ã€‚
  :::

## é¢è¯•ç­”é¢˜æ€»ç»“

1. **ç®—æ³•æ ¸å¿ƒ**ï¼šæ˜ç¡®è´¹é›ªè€¶å…¹ç®—æ³•çš„æ ¸å¿ƒæ˜¯â€œå€’åºéå†â€ï¼›
2. **å…³é”®æ“ä½œ**ï¼šå¼ºè°ƒâ€œåœ¨`[0, I]`åŒºé—´å†…éšæœºé€‰æ‹©å…ƒç´ å¹¶äº¤æ¢â€ï¼›
3. **æ—¶ç©ºå¤æ‚åº¦**ï¼šè¯´æ˜ç®—æ³•æ˜¯â€œåŸåœ°æ“ä½œâ€ï¼Œæ—¶é—´å¤æ‚åº¦`O(n)`ã€ç©ºé—´å¤æ‚åº¦`O(1)`ï¼›
4. **æ‰©å±•åŠ åˆ†**ï¼šå¯ä¸»åŠ¨æåŠç®—æ³•çš„è¿›é˜¶åº”ç”¨â€”â€”éšæœºé‡‡æ ·ï¼ˆæ‰§è¡Œå‰`K`æ¬¡è¿­ä»£ï¼‰ï¼Œä½“ç°å¯¹ç®—æ³•çš„æ·±åº¦ç†è§£ã€‚
