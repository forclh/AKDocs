# âœ¨ å“åº”å¼æ•°æ®çš„æœ¬è´¨ ğŸ‘Œ

[[TOC]]

::: tip è¦ç‚¹é€Ÿè§ˆ

- â€œå“åº”å¼â€æœ¬è´¨æ˜¯â€œå¯¹æ•°æ®æ“ä½œçš„æ‹¦æˆªâ€ï¼Œåœ¨æ‹¦æˆªé‡Œæ‰§è¡Œæˆ‘ä»¬çš„ä¸šåŠ¡é€»è¾‘ï¼ˆä¾èµ–æ”¶é›†ã€è°ƒåº¦æ›´æ–°ç­‰ï¼‰ã€‚
- `ref` ç”¨â€œè®¿é—®å™¨å±æ€§â€çš„ `get/set` æ‹¦æˆªå¯¹ `value` çš„è¯»å†™ï¼›`reactive` ç”¨ `Proxy` æ‹¦æˆªå¯¹è±¡æˆå‘˜çš„è¯»å†™ã€æšä¸¾ã€åˆ é™¤ã€åŸå‹ç­‰æ“ä½œã€‚
- æ˜¯å¦ä¼šæ‹¦æˆªçš„æ ¸å¿ƒåˆ¤æ–­ï¼šæ“ä½œæ˜¯å¦å‘ç”Ÿåœ¨â€œè¢«æ‹¦æˆªå¯¹è±¡çš„æˆå‘˜ä¸Šâ€ã€‚éæˆå‘˜æ“ä½œï¼ˆå¦‚å˜é‡é‡æ–°èµ‹å€¼ï¼‰ä¸ä¼šè§¦å‘æ‹¦æˆªã€‚
- åŒä¸€æ•°æ®ä¸Šçš„ä¸åŒæ“ä½œè§¦å‘çš„æ˜¯â€œä¸åŒçš„æ‹¦æˆªé€»è¾‘â€ï¼Œä¸è¦æœŸå¾…ä¸€ä¸ªç»Ÿä¸€æ‹¦æˆªèƒ½æå®šå…¨éƒ¨è¡Œä¸ºã€‚
  :::

::: info å­¦ä¹ ç›®æ ‡

- çœ‹æ‡‚ `ref` ä¸ `reactive` çš„æ‹¦æˆªç‚¹ä¸è§¦å‘æ¡ä»¶ã€‚
- ä¼šåˆ¤æ–­æŸä¸ªæ“ä½œæ˜¯å¦â€œå‘ç”Ÿåœ¨æˆå‘˜ä¸Šâ€ï¼Œä»è€Œæ˜¯å¦ä¼šè§¦å‘æ‹¦æˆªé€»è¾‘ã€‚
- èƒ½åŒºåˆ†ï¼šåœ¨ `ref` åŒ…è£¹å¯¹è±¡ä¸Šæ”¹â€œå¯¹è±¡æˆå‘˜â€ï¼Œè¿™æ˜¯ `reactive` çš„æ‹¦æˆªï¼Œä¸æ˜¯ `ref` çš„æ‹¦æˆªã€‚
  :::

## ä»€ä¹ˆæ˜¯å“åº”å¼æ•°æ®ï¼Ÿ

- èƒ½æ‹¦æˆªæˆ‘ä»¬å¯¹æ•°æ®çš„æ“ä½œï¼ˆè¯»ã€å†™ã€åˆ ã€æšä¸¾ç­‰ï¼‰ï¼Œå¹¶åœ¨æ‹¦æˆªé€»è¾‘é‡Œæ‰§è¡Œæˆ‘ä»¬å†™å¥½çš„å¤„ç†ï¼Œå³å¯ç§°ä¸ºâ€œå“åº”å¼æ•°æ®â€ã€‚
- Vue ä»¥ `ref` ä¸ `reactive` ä¸¤æ¡è·¯å¾„äº§å‡ºâ€œå¯æ‹¦æˆªçš„å¯¹è±¡â€ï¼Œä»è€Œå…·å¤‡å“åº”èƒ½åŠ›ã€‚

::: warning ä¸ºä»€ä¹ˆè¦å­¦ä¼šåˆ¤æ–­â€œæ˜¯å¦ä¼šæ‹¦æˆªâ€ï¼Ÿ

- æ‹¦æˆªé€»è¾‘æ˜¯åˆ†æ•£åœ¨ä¸åŒæ“ä½œä¸Šçš„ï¼Œä¸æ˜¯å•ä¸€å…¥å£ï¼›ä¸åŒæ“ä½œè§¦å‘ä¸åŒæ‹¦æˆªä»£ç ã€‚
- å¹¶éæ‰€æœ‰æ“ä½œéƒ½èƒ½æ‹¦æˆªï¼šä¾‹å¦‚å˜é‡é‡æ–°èµ‹å€¼ã€å¯¹ä¸å¯æ‹¦æˆªç±»å‹çš„â€œæˆå‘˜æ“ä½œâ€ç­‰ã€‚
- å­¦ä¼šåˆ¤æ–­èƒ½é¿å…â€œä»¥ä¸ºä¼šæ›´æ–°ã€ç»“æœæ²¡è§¦å‘â€çš„å°´å°¬ï¼Œç”¨æ­£ç¡®æ–¹å¼é©±åŠ¨æ›´æ–°ã€‚
  :::

## ref çš„æ‹¦æˆªåŸç†ï¼ˆè®¿é—®å™¨å±æ€§ï¼‰

è¿™æ˜¯ä¸€ä¸ªç®€åŒ–ç‰ˆçš„ `ref` å®ç°æ€è·¯ï¼šé€šè¿‡â€œè®¿é—®å™¨æˆå‘˜ `value` çš„ get ä¸ setâ€æ‹¦æˆªå¯¹ `value` çš„è¯»å†™ã€‚

```js :collapsed-lines
class RefImpl {
  constructor(value) {
    // ç®€åŒ–ï¼šå¯¹è±¡åˆ™äº¤ç»™ reactive å¤„ç†ï¼›åŸå§‹å€¼ç›´æ¥ä¿å­˜
    this._value =
      typeof value === "object" && value !== null ? reactive(value) : value;
    this.__v_isRef = true;
  }
  get value() {
    console.log("getter value", this._value);
    // è¯»å–æ—¶å¯è¿›è¡Œä¾èµ–æ”¶é›†ï¼ˆæ­¤å¤„æ¼”ç¤ºç•¥ï¼‰
    return this._value;
  }
  set value(newVal) {
    console.log("setter newVal", newVal);
    // å†™å…¥æ—¶å¯åšå˜æ›´åˆ¤æ–­ä¸æ´¾å‘æ›´æ–°ï¼ˆæ­¤å¤„æ¼”ç¤ºç•¥ï¼‰
    this._value = newVal;
  }
}

function ref(value) {
  return new RefImpl(value);
}
```

::: tip ç»“è®º

- `ref` çš„æ‹¦æˆªå‘ç”Ÿåœ¨å¯¹â€œ`refObj.value` çš„è¯»å†™â€è¿™ä¸€æˆå‘˜æ“ä½œä¸Šã€‚
- å†™å…¥æ—¶å¯åšâ€œå˜æ›´åˆ¤æ–­â€ä»¥é¿å…ä¸å¿…è¦çš„æ›´æ–°ï¼›è¯»å–æ—¶å¯åšâ€œä¾èµ–æ”¶é›†â€ã€‚
  :::

### refï¼šæ˜¯å¦è§¦å‘æ‹¦æˆªçš„æ¼”ç¤º

```js :collapsed-lines
// åˆ›å»ºæ‹¦æˆªå¯¹è±¡
let state = ref({ name: "zhangsan" });

// å˜é‡é‡æ–°èµ‹å€¼ï¼šä¸æ˜¯æˆå‘˜æ“ä½œï¼Œä¸è§¦å‘ ref çš„æ‹¦æˆª
state = { name: "lisi" };

// æˆå‘˜å†™å…¥ï¼šå‘ç”Ÿåœ¨ ref å¯¹è±¡çš„æˆå‘˜ä¸Šï¼Œè§¦å‘æ‹¦æˆª
state.value = { name: "lisi" };

// å¯¹ valueï¼ˆå¯¹è±¡ï¼‰çš„æˆå‘˜å†™å…¥ï¼šè¿™æ˜¯ reactive çš„æ‹¦æˆªï¼Œä¸æ˜¯ ref çš„æ‹¦æˆª
state.value.name = "wangwu";

// å†™å…¥å­—ç¬¦ä¸²ï¼šåªè§¦å‘ ref çš„ setï¼›å­—ç¬¦ä¸²çš„â€œæˆå‘˜æ‹¦æˆªâ€ä¸å­˜åœ¨
state.value = "abc";
```

## reactive çš„æ‹¦æˆªåŸç†ï¼ˆProxyï¼‰

ä½¿ç”¨ `Proxy` å¯¹å¯¹è±¡è¿›è¡Œæ‹¦æˆªï¼Œå¸¸è§æ˜¯ `get` ä¸ `set` ä¸¤ä¸ªæˆå‘˜æ“ä½œçš„å…¥å£ï¼š

```js :collapsed-lines
const state = { name: "Bob" };

const proxyCache = new WeakMap();

function reactive(target) {
  if (typeof target !== "object" || target === null) {
    return target;
  }

  if (proxyCache.has(target)) {
    return proxyCache.get(target);
  }

  const handler = {
    // è¯»å–æˆå‘˜æ‹¦æˆª
    get(obj, key, receiver) {
      const v = Reflect.get(obj, key, receiver);
      console.log("get æ‹¦æˆªé€»è¾‘", key, v);
      return typeof v === "object" && v !== null ? reactive(v) : v;
    },
    // å†™å…¥æˆå‘˜æ‹¦æˆª
    set(obj, key, val, receiver) {
      const prev = Reflect.get(obj, key, receiver);
      const ok = Reflect.set(obj, key, val, receiver);
      if (ok && prev !== val) {
        console.log("set æ‹¦æˆªé€»è¾‘æˆåŠŸ");
      }
      return ok;
    },
    deleteProperty(obj, key) {
      const ok = Reflect.deleteProperty(obj, key);
      if (ok) {
        console.log("delete æ‹¦æˆªé€»è¾‘æˆåŠŸ");
      }
      return ok;
    },
    // ...
  };

  const proxy = new Proxy(target, handler);
  proxyCache.set(target, proxy);
  return proxy;
}

const proxyState = reactive(state);

console.log(proxyState.name); // è§¦å‘ get
proxyState.name = "Alice"; // è§¦å‘ set
```

::: info è¿›ä¸€æ­¥æ‹¦æˆªç‚¹

- é™¤ `get/set` å¤–ï¼ŒVue åœ¨ `reactive` ä¸­è¿˜ä¼šæ‹¦æˆªï¼š`has`ã€`deleteProperty`ã€`ownKeys`ã€`getOwnPropertyDescriptor` ç­‰ï¼Œä»¥ä¿è¯ä¸åŸå¯¹è±¡çš„è¡Œä¸ºä¸€è‡´å¹¶ç»´æŠ¤ä¸å˜å¼ã€‚
- æšä¸¾ç›¸å…³å»ºè®®ä½¿ç”¨ `Reflect.ownKeys` ä¿æŒ string ä¸ Symbol é”®çš„ä¸€è‡´æ€§ã€‚
  :::

## å¦‚ä½•åˆ¤æ–­â€œæ˜¯å¦ä¼šæ‹¦æˆªâ€ï¼Ÿ

æ ¸å¿ƒæ ‡å‡†ï¼šæ“ä½œæ˜¯å¦å‘ç”Ÿåœ¨â€œæ‹¦æˆªå¯¹è±¡çš„æˆå‘˜ä¸Šâ€ã€‚ä¸‹é¢ç”¨ä¸€ç»„ç¤ºä¾‹æ¥ç›´è§‚åˆ¤æ–­ï¼š

```jsx:collapsed-lines
// ç¤ºä¾‹ 1ï¼šå¯¹è±¡æˆå‘˜è¯»å†™ â†’ è§¦å‘ reactive çš„ get/set
const proxy = new Proxy({ name: 'Ak' }, {
  get(t, k) { console.log('get', k); return t[k] },
  set(t, k, v) { console.log('set', k, v); t[k] = v; return true }
})
console.log(proxy.name)   // get
proxy.name = 'Sky'        // set

// ç¤ºä¾‹ 2ï¼šref çš„æˆå‘˜å†™å…¥ â†’ è§¦å‘ ref çš„ set
const count = ref(0)
count.value = 1

// ç¤ºä¾‹ 3ï¼šref åŒ…è£¹å¯¹è±¡æˆå‘˜å†™å…¥ â†’ è§¦å‘ reactive çš„ setï¼ˆä¸æ˜¯ ref çš„æ‹¦æˆªï¼‰
const user = ref({ name: 'A' })
user.value.name = 'B'

// ç¤ºä¾‹ 4ï¼šå­—ç¬¦ä¸²æˆå‘˜ä¸å¯æ‹¦æˆª â†’ ä»…è§¦å‘ ref çš„ set
const title = ref('hello')
title.value = 'world'

// ç¤ºä¾‹ 5ï¼šæ•°ç»„æ“ä½œï¼ˆpushï¼‰â†’ å†…éƒ¨ä¼šè§¦å‘è‹¥å¹² setï¼ˆç´¢å¼•ä¸ lengthï¼‰
const list = new Proxy([], {
  set(t, k, v) { console.log('array set', k, v); t[k] = v; return true }
})
list.push(4)
```

::: warning å­¦ä¼šåˆ¤æ–­æ‹¦æˆª

- å˜é‡é‡æ–°èµ‹å€¼ä¸æ˜¯æˆå‘˜æ“ä½œï¼Œä¸ä¼šè§¦å‘æ‹¦æˆªã€‚
- åœ¨ `ref` åŒ…è£¹çš„å¯¹è±¡ä¸Šæ”¹â€œå¯¹è±¡æˆå‘˜â€ï¼Œè§¦å‘çš„æ˜¯ `reactive` çš„æ‹¦æˆªã€‚
- åŸºæœ¬ç±»å‹çš„â€œæˆå‘˜æ“ä½œâ€ä¸å¯æ‹¦æˆªï¼ˆå­—ç¬¦ä¸²ã€æ•°å­—ã€å¸ƒå°”ï¼‰ã€‚

:::

## å¸¸è§å‘ä½

::: danger æ˜“é”™ç‚¹

- æŠŠâ€œéæˆå‘˜æ“ä½œâ€è¯¯è®¤ä¸ºä¼šè§¦å‘æ‹¦æˆªï¼Œå¯¼è‡´æ›´æ–°é€»è¾‘æ²¡æœ‰æ‰§è¡Œã€‚
- åœ¨ `ref` åŒ…è£¹å¯¹è±¡ä¸Šåšæˆå‘˜å†™å…¥ï¼Œå´ä»¥ä¸ºæ˜¯ `ref` çš„æ‹¦æˆªï¼›å®é™…æ˜¯ `reactive` çš„æ‹¦æˆªè·¯å¾„ã€‚
- å¿˜è®°é€šè¿‡ `state.value` è®¿é—® `ref` çš„å€¼ï¼Œç›´æ¥ `state = ...` å¯¼è‡´ä¸ä¼šè§¦å‘æ‹¦æˆªã€‚
- æšä¸¾å¯¹è±¡é”®æ—¶ç”¨ `Object.keys`ï¼Œå¿½ç•¥äº† `Symbol` é”®ä¸ä¸å¯æšä¸¾é”®ï¼›å»ºè®® `Reflect.ownKeys`ï¼ˆé…åˆ Proxy çš„ `ownKeys` ï¼‰ã€‚

:::

::: details æšä¸¾å¯¹è±¡é”®çš„åŒºåˆ«

```js
Object.keys() - åªæšä¸¾å¯æšä¸¾çš„å­—ç¬¦ä¸²é”®ï¼Œä¸åŒ…æ‹¬ Symbol
Object.getOwnPropertyNames() - æšä¸¾æ‰€æœ‰å­—ç¬¦ä¸²é”®ï¼ˆåŒ…æ‹¬ä¸å¯æšä¸¾ï¼‰ï¼Œä¸åŒ…æ‹¬ Symbol
Object.getOwnPropertySymbols() - ä¸“é—¨æšä¸¾ Symbol é”®
Reflect.ownKeys() - æšä¸¾æ‰€æœ‰é”®ï¼ˆå­—ç¬¦ä¸² + Symbolï¼‰
```

:::

## ä½¿ç”¨å»ºè®®

- ä¼˜å…ˆç”¨ `reactive` ç®¡å¯¹è±¡/æ•°ç»„çš„æˆå‘˜æ“ä½œï¼Œç”¨ `ref` ç®¡æ ‡é‡æˆ–éœ€è¦â€œå¼•ç”¨è¯­ä¹‰â€çš„åœºæ™¯ã€‚
- åˆ¤æ–­æ‹¦æˆªä»â€œæ˜¯å¦å‘ç”Ÿåœ¨æˆå‘˜ä¸Šâ€å…¥æ‰‹ï¼Œå†ç»“åˆå¯¹è±¡æ˜¯å¦è¢«ä»£ç†ã€æˆå‘˜ç±»å‹æ˜¯å¦å¯æ‹¦æˆªã€‚
- ä¸æ¸²æŸ“æ›´æ–°é…åˆæ—¶ï¼Œå»ºè®®ä½¿ç”¨â€œå¾®ä»»åŠ¡åˆå¹¶ + è°ƒåº¦â€çš„æ¨¡å¼ï¼Œé¿å…å¤šæ¬¡åŒæ­¥æ›´æ–°å¯¼è‡´æŠ–åŠ¨ã€‚

## å°ç»“

- å“åº”å¼çš„æœ¬è´¨æ˜¯â€œæ‹¦æˆªæ•°æ®æ“ä½œå¹¶åœ¨æ‹¦æˆªé‡Œæ‰§è¡Œå¤„ç†â€ã€‚
- `ref` ä¸ `reactive` çš„æ‹¦æˆªç‚¹ä¸åŒï¼šåˆ†åˆ«æ‹¦æˆª `value` çš„è¯»å†™ä¸å¯¹è±¡æˆå‘˜çš„è¯»å†™/æšä¸¾ç­‰ã€‚
- æ˜¯å¦ä¼šæ‹¦æˆªï¼Œå–å†³äºæ“ä½œæ˜¯å¦å‘ç”Ÿåœ¨â€œæ‹¦æˆªå¯¹è±¡çš„æˆå‘˜ä¸Šâ€ã€‚å­¦ä¼šæ­£ç¡®åˆ¤æ–­ï¼Œæ‰èƒ½ç¨³å®šé©±åŠ¨æ›´æ–°ä¸è¡Œä¸ºã€‚
