# ã€åå°„ä¸ä»£ç†ã€‘è§‚å¯Ÿè€…æ¨¡å¼ ğŸ‘Œ

[[TOC]]

::: tip è¦ç‚¹é€Ÿè§ˆ

- è§‚å¯Ÿè€…æ¨¡å¼ï¼šå½“è¢«è§‚å¯Ÿå¯¹è±¡çš„æ•°æ®å˜åŒ–æ—¶ï¼Œè§¦å‘é€šçŸ¥/æ¸²æŸ“ç­‰å‰¯ä½œç”¨ã€‚
- `Object.defineProperty` å¯å®ç°åŸºæœ¬è§‚å¯Ÿï¼Œä½†åªé’ˆå¯¹â€œå·²å­˜åœ¨å±æ€§â€ï¼Œå¯¹æ•°ç»„/æ–°å¢å±æ€§æ”¯æŒå¼±ã€‚
- `Proxy` å¤©ç„¶æ”¯æŒæ–°å¢/åˆ é™¤/æ•°ç»„æ–¹æ³•ç­‰ï¼Œç»“åˆ `Reflect` å¯ä¿æŒä¸å˜å¼ä¸ä¸€è‡´è¯­ä¹‰ã€‚
- å®æˆ˜ä¸­å»ºè®®â€œæ‰¹é‡è°ƒåº¦æ¸²æŸ“â€ï¼ˆå¾®ä»»åŠ¡åˆå¹¶ï¼‰ï¼Œé¿å…æ¯æ¬¡å˜æ›´éƒ½ç«‹å³é‡æ¸²æŸ“ã€‚
  :::

## `defineProperty` å®ç°

```js :collapsed-lines
// åˆ›å»ºä¸€ä¸ªè§‚å¯Ÿè€…ï¼ˆä»…èƒ½è§‚å¯Ÿå¯¹è±¡å½“å‰å·²å­˜åœ¨çš„å±æ€§ï¼‰
function observer(target) {
  const div = document.getElementById("container");
  const ob = {};
  const props = Object.keys(target);
  for (const prop of props) {
    // ä¸ºâ€œå·²çŸ¥å±æ€§â€å®šä¹‰è®¿é—®å™¨æ‹¦æˆªï¼šè¯»å–è½¬å‘ï¼Œå†™å…¥è§¦å‘æ¸²æŸ“è°ƒåº¦
    Object.defineProperty(ob, prop, {
      get() {
        // è¯»å–æ—¶ç›´æ¥è¿”å›åº•å±‚å€¼ï¼ˆä»…æ‹¦æˆª ob è‡ªèº«çš„å±æ€§ï¼‰
        return target[prop];
      },
      set(val) {
        // å†™å…¥åº•å±‚å¯¹è±¡ï¼Œå¹¶è°ƒåº¦ä¸€æ¬¡æ¸²æŸ“ï¼ˆé‡‡ç”¨å¾®ä»»åŠ¡åˆå¹¶ï¼‰
        target[prop] = val;
        scheduleRender();
      },
      enumerable: true,
      configurable: true,
    });
  }

  // æ¸²æŸ“è°ƒåº¦æ ‡è®°ï¼šåŒä¸€äº‹ä»¶å¾ªç¯å†…çš„å¤šæ¬¡ä¿®æ”¹åªè§¦å‘ä¸€æ¬¡æ¸²æŸ“
  let scheduled = false;
  function scheduleRender() {
    if (scheduled) return; // å·²å®‰æ’åˆ™è·³è¿‡ï¼Œé¿å…é‡å¤
    scheduled = true;
    // ä½¿ç”¨å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼ˆPromise.thenï¼‰åœ¨å½“å‰å®ä»»åŠ¡ç»“æŸåå†ç»Ÿä¸€æ¸²æŸ“
    Promise.resolve().then(() => {
      render();
      scheduled = false; // é‡ç½®æ ‡è®°ï¼Œå…è®¸ä¸‹æ¬¡è°ƒåº¦
    });
  }

  // å®é™…æ¸²æŸ“ï¼šæ ¹æ® ob çš„å½“å‰å¯æšä¸¾é”®ç”Ÿæˆå†…å®¹
  function render() {
    let html = "";
    for (const prop of Object.keys(ob)) {
      html += `<p><span>${prop}ï¼š</span><span>${ob[prop]}</span></p>`;
    }
    div.innerHTML = html;
  }

  // åˆå§‹æ¸²æŸ“
  render();
  return ob;
}

// ä½¿ç”¨ç¤ºä¾‹
const target = { a: 1, b: 2 };
const obj = observer(target);
obj.a = 10; // è§¦å‘æ¸²æŸ“ï¼ˆå¾®ä»»åŠ¡åˆå¹¶ï¼‰
```

::: info å¾®ä»»åŠ¡åˆå¹¶è¯¦è§£

- èƒŒæ™¯ï¼šå¦‚æœæ¯æ¬¡ `set` éƒ½ç«‹å³æ¸²æŸ“ï¼ŒçŸ­æ—¶é—´å†…å¤šæ¬¡å†™å…¥å°†å¯¼è‡´é¢‘ç¹ DOM æ›´æ–°ï¼Œæ€§èƒ½è¾ƒå·®ã€‚
- æ–¹æ¡ˆï¼šç”¨å¾®ä»»åŠ¡é˜Ÿåˆ—åˆå¹¶åŒä¸€äº‹ä»¶å¾ªç¯å†…çš„å¤šæ¬¡ä¿®æ”¹ï¼Œä»…è¿›è¡Œâ€œä¸€æ¬¡æ‰¹é‡æ¸²æŸ“â€ã€‚
- å®ç°ï¼šé€šè¿‡ `scheduled` æ ‡è®° + `Promise.resolve().then(render)`ã€‚
  - é¦–æ¬¡å†™å…¥æ—¶å°† `scheduled` ç½®ä¸º `true` å¹¶æ³¨å†Œä¸€ä¸ªå¾®ä»»åŠ¡ï¼›åç»­å†™å…¥æ£€æµ‹åˆ°æ ‡è®°ï¼Œç›´æ¥è¿”å›ã€‚
  - å½“å‰å®ä»»åŠ¡ï¼ˆä¾‹å¦‚ç‚¹å‡»ã€è¾“å…¥ã€å®šæ—¶å™¨å›è°ƒï¼‰ç»“æŸåï¼Œå¾®ä»»åŠ¡ç»Ÿä¸€æ‰§è¡Œ `render()`ã€‚
- ä¸å…¶ä»–æ–¹å¼æ¯”è¾ƒï¼š
  - `queueMicrotask(render)`ï¼šè¯­ä¹‰æ›´ç›´æ¥ï¼Œæ•ˆæœä¸ `Promise.resolve().then(render)` ç­‰ä»·ã€‚
  - `setTimeout(render, 0)`ï¼šå±äºå®ä»»åŠ¡ï¼Œå»¶è¿Ÿåˆ°ä¸‹ä¸€ä¸ªäº‹ä»¶å¾ªç¯ï¼Œåˆå¹¶åŠ›åº¦æ›´å¼ºä½†å“åº”ç¨æ™šã€‚
- é€‚ç”¨æ€§ï¼šå…¼å®¹ `await`/`then` é“¾ã€æ‰¹é‡åŒæ­¥èµ‹å€¼ç­‰åœºæ™¯ï¼›èƒ½æœ‰æ•ˆé™ä½æ¸²æŸ“å¼€é”€ã€‚
  :::

::: warning å±€é™æ€§

- åªèƒ½è§‚å¯Ÿå·²æœ‰å±æ€§ï¼›æ–°å¢å±æ€§ä¸ä¼šè¢«æ‹¦æˆªï¼ˆéœ€é¢å¤–è°ƒç”¨ `defineProperty` æ‰©å±•ï¼‰ã€‚
- å¯¹æ•°ç»„æ”¯æŒå¼±ï¼šä¸‹æ ‡æ–°å¢ã€`length` å˜åŒ–ä¸å˜æ›´æ–¹æ³•ï¼ˆ`push` ç­‰ï¼‰å¾ˆéš¾è¦†ç›–ã€‚
  - ä¸‹æ ‡æ–°å¢ï¼šå¦‚ `arr[2] = 123` æ˜¯åœ¨æ•°ç»„æœ¬ä½“ä¸Šæ–°å¢ç´¢å¼•ï¼Œè‹¥æœªä¸ºè¯¥ç´¢å¼•é¢„å®šä¹‰è®¿é—®å™¨åˆ™ä¸ä¼šè§¦å‘æ‹¦æˆªã€‚
  - `length` ç‰¹æ®Šï¼šæ•°ç»„çš„ `length` æ˜¯ä¸å¯é…ç½®çš„å†…å»ºæ•°æ®å±æ€§ï¼Œä¸èƒ½æ”¹é€ æˆè®¿é—®å™¨ï¼Œå› æ­¤ `arr.length = 0` æ— æ³•é€šè¿‡ `defineProperty` æ•è·ã€‚
  - å˜æ›´æ–¹æ³•ï¼š`push/pop/splice/sort/reverse` ç­‰æ–¹æ³•å†…éƒ¨ç›´æ¥æ”¹åŠ¨å…ƒç´ å’Œ `length`ï¼Œä¸ä¼šè§¦å‘â€œé¡¶å±‚å±æ€§â€çš„ setterã€‚
  - ç»´æŠ¤æˆæœ¬ï¼šè¦è¦†ç›–æ•°ç»„å˜åŒ–éœ€ä¸ºæ‰€æœ‰ç°æœ‰ç´¢å¼•é¢„å®šä¹‰è®¿é—®å™¨ï¼Œå¹¶åœ¨æ–°å¢/åˆ é™¤/ä½ç§»æ—¶åŠ¨æ€å¢åˆ è®¿é—®å™¨ï¼Œå¤æ‚ä¸”æ˜“æ¼ã€‚
- æ·±å±‚å¯¹è±¡éœ€è¦é¢„éå†é€’å½’ï¼Œæˆæœ¬é«˜ä¸”ç»´æŠ¤å¤æ‚ã€‚
  :::

```js
// ç¤ºä¾‹ï¼šé¡¶å±‚ defineProperty çš„ setter æ— æ³•æ•è·æ•°ç»„æ–¹æ³•å¯¼è‡´çš„å˜åŒ–
const state = { list: [] };
const ob = {};
Object.defineProperty(ob, "list", {
  get() {
    return state.list;
  },
  set(v) {
    state.list = v;
    console.log("render");
  },
});

ob.list.push(1); // ä¸ä¼šè§¦å‘ ob.list çš„ setter â†’ ä¸æ‰“å° "render"
ob.list = ob.list.concat(2); // èµ‹æ–°å€¼æ‰ä¼šè§¦å‘ setter â†’ æ‰“å° "render"
```

## `Proxy` + `Reflect`å®ç°

```js :collapsed-lines
// åˆ›å»ºä¸€ä¸ªè§‚å¯Ÿè€…ï¼ˆæ”¯æŒæ–°å¢å±æ€§ã€åˆ é™¤ã€æ•°ç»„æ–¹æ³•ç­‰ï¼›æŒ‰éœ€æ¸²æŸ“ï¼‰
function observer(target) {
  const div = document.getElementById("container");
  let scheduled = false;
  const scheduleRender = () => {
    if (scheduled) return;
    scheduled = true;
    Promise.resolve().then(() => {
      render();
      scheduled = false;
    });
  };

  const proxy = new Proxy(target, {
    get(t, key, receiver) {
      // è¿”å›çœŸå®å€¼ï¼›è‹¥ä¸ºå¯¹è±¡ï¼Œå¯åœ¨æ­¤å®ç°æƒ°æ€§æ·±åº¦ä»£ç†ï¼ˆç¤ºä¾‹ä¿æŒç®€å•ï¼‰
      return Reflect.get(t, key, receiver);
    },
    set(t, key, value, receiver) {
      // ä½¿ç”¨ Reflect.setï¼Œè¿”å›å¸ƒå°”å€¼ä»¥ç¬¦åˆä¸¥æ ¼æ¨¡å¼ä¸ä¸å˜å¼
      const ok = Reflect.set(t, key, value, receiver);
      if (ok) scheduleRender();
      return ok;
    },
    deleteProperty(t, key) {
      const ok = Reflect.deleteProperty(t, key);
      if (ok) scheduleRender();
      return ok;
    },
    // ownKeys å½±å“æšä¸¾ï¼ˆObject.keys/Object.getOwnPropertyNames ç­‰ï¼‰
    ownKeys(t) {
      return Reflect.ownKeys(t);
    },
    // å¯æ ¹æ®éœ€è¦æ‹¦æˆª defineProperty/has ç­‰
  });

  function render() {
    let html = "";
    for (const key of Object.keys(proxy)) {
      html += `<p><span>${key}ï¼š</span><span>${proxy[key]}</span></p>`;
    }
    div.innerHTML = html;
  }

  // åˆå§‹æ¸²æŸ“
  render();
  return proxy;
}

// ä½¿ç”¨ç¤ºä¾‹
const target = { a: 1, b: 2 };
const obj = observer(target);
obj.c = 3; // æ–°å¢å±æ€§ â†’ æ¸²æŸ“
delete obj.a; // åˆ é™¤å±æ€§ â†’ æ¸²æŸ“
obj.arr = [1]; // æ•°ç»„èµ‹å€¼ â†’ æ¸²æŸ“
obj.arr.push(2); // æ•°ç»„æ–¹æ³• â†’ set/ownKeys å½±å“æšä¸¾ â†’ æ¸²æŸ“
```

::: info ä¸¤ç§å®ç°çš„å¯¹æ¯”

- `defineProperty`ï¼šé€‚åˆç®€å•åœºæ™¯ä¸è€ç¯å¢ƒï¼ˆå…¼å®¹æ€§å¥½ï¼‰ï¼Œä½†æ–°å¢/åˆ é™¤/æ•°ç»„æ”¯æŒä¸è¶³ï¼Œæ·±åº¦æ‹¦æˆªéœ€è¦é¢„éå†ã€‚
- `Proxy`ï¼šå¤©ç„¶æ”¯æŒæ›´å¤šæ“ä½œï¼Œç»“åˆ `Reflect` èƒ½ä¿è¯è¿”å›å€¼è¯­ä¹‰ä¸è§„èŒƒä¸å˜å¼ï¼Œæ›´é€‚åˆç°ä»£åº”ç”¨ä¸å¤æ‚æ•°æ®ç»“æ„ã€‚
  :::

## è¿›ä¸€æ­¥ä¼˜åŒ–ï¼šæƒ°æ€§æ·±åº¦ä»£ç†

```js :collapsed-lines
const cache = new WeakMap();
function getProxy(obj, notify) {
  if (!obj || typeof obj !== "object") return obj;
  if (cache.has(obj)) return cache.get(obj);

  const p = new Proxy(obj, {
    get(t, k, r) {
      const v = Reflect.get(t, k, r);
      return v && typeof v === "object" ? getProxy(v, notify) : v;
    },
    set(t, k, v, r) {
      const ok = Reflect.set(t, k, v, r);
      if (ok) notify();
      return ok;
    },
    deleteProperty(t, k) {
      const ok = Reflect.deleteProperty(t, k);
      if (ok) notify();
      return ok;
    },
  });
  cache.set(obj, p);
  return p;
}

// ä½¿ç”¨ï¼š
const proxy = getProxy(target, scheduleRender);
```

::: danger å¸¸è§å‘ä½

- åœ¨ `set` æ‹¦æˆªä¸­æœªè¿”å›å¸ƒå°”å€¼æˆ–é”™è¯¯åœ°å§‹ç»ˆè¿”å› `true`ï¼Œä¼šè¿åä¸¥æ ¼æ¨¡å¼æˆ–å¯¹è±¡ä¸å˜å¼ã€‚
- å¿½ç•¥ `ownKeys` å¯¼è‡´æšä¸¾ç»“æœä¸çœŸå®å¯¹è±¡ä¸ä¸€è‡´ï¼Œå½±å“æ¸²æŸ“æ•°æ®æ¥æºã€‚
- æœªåšæ¸²æŸ“è°ƒåº¦ï¼ˆå»æŠ–/åˆå¹¶ï¼‰å¯¼è‡´é¢‘ç¹ DOM æ›´æ–°ï¼Œæ€§èƒ½è¾ƒå·®ã€‚
- æ·±åº¦ä»£ç†éœ€æ³¨æ„å¾ªç¯å¼•ç”¨ä¸é‡å¤åŒ…è£¹ï¼Œä½¿ç”¨ `WeakMap` ç¼“å­˜é¿å…é—®é¢˜ã€‚
  :::

## ä½¿ç”¨å»ºè®®

- ç®€å•/å…¼å®¹ä¼˜å…ˆï¼šå°å‹åœºæ™¯ä¸è€ç¯å¢ƒä¼˜å…ˆä½¿ç”¨ `defineProperty`ï¼›å¤æ‚åœºæ™¯ä½¿ç”¨ `Proxy`ã€‚
- ä¸€å¾‹é€šè¿‡ `Reflect` æ‰§è¡ŒçœŸå®æ“ä½œå¹¶ä½¿ç”¨å…¶è¿”å›å€¼ï¼Œä¿æŒè¯­ä¹‰ä¸è§„èŒƒã€‚
- ä¸ºæ¸²æŸ“æ·»åŠ å¾®ä»»åŠ¡è°ƒåº¦ï¼ˆæˆ–è¯·æ±‚åŠ¨ç”»å¸§ï¼‰ï¼Œåˆå¹¶å¤šæ¬¡å˜æ›´çš„å¼€é”€ã€‚
- æšä¸¾æ—¶å°½é‡ä»ä»£ç†è¯»å–ï¼ˆå¦‚ `Object.keys(proxy)`ï¼‰ï¼Œä»¥åŒ…å«æ–°å¢/åˆ é™¤çš„å®æ—¶çŠ¶æ€ã€‚

## å°ç»“

1. è§‚å¯Ÿè€…æ¨¡å¼çš„æ ¸å¿ƒæ˜¯ï¼šæ•°æ®å˜åŒ– â†’ é€šçŸ¥ â†’ å‰¯ä½œç”¨ï¼ˆå¦‚æ¸²æŸ“ï¼‰ã€‚
2. `defineProperty` èƒ½å®ç°åŸºç¡€è§‚å¯Ÿï¼›`Proxy` æ›´é€‚åˆç°ä»£å¤æ‚åœºæ™¯ï¼Œæ­é… `Reflect` ä¿éšœä¸å˜å¼ã€‚
3. å®æˆ˜ä¸­åº”å½“å¼•å…¥â€œæ¸²æŸ“è°ƒåº¦â€å’Œâ€œæƒ°æ€§æ·±åº¦ä»£ç† + ç¼“å­˜â€ä»¥å¹³è¡¡å‡†ç¡®æ€§ä¸æ€§èƒ½ã€‚
