# ã€åå°„ä¸ä»£ç†ã€‘å±æ€§æè¿°ç¬¦ ğŸ‘Œ

[[TOC]]

::: tip è¦ç‚¹é€Ÿè§ˆ

- å±æ€§æè¿°ç¬¦ç”¨äºç²¾ç¡®æ§åˆ¶å±æ€§çš„â€œå€¼/å¯å†™/å¯æšä¸¾/å¯é…ç½®â€ã€‚
- æ•°æ®å±æ€§ï¼ˆ`value/writable`ï¼‰ä¸å­˜å–å™¨å±æ€§ï¼ˆ`get/set`ï¼‰äº’æ–¥ï¼ŒäºŒè€…ä¸å¯åŒæ—¶å­˜åœ¨äºåŒä¸€å±æ€§ã€‚
- `configurable: false` ä¼šé”å®šç»“æ„ï¼šä¸å¯åˆ é™¤ã€ä¸å¯æ›´æ¢ä¸ºå­˜å–å™¨/æ•°æ®å±æ€§ã€éƒ¨åˆ†å­—æ®µä¸å¯å†ä¿®æ”¹ã€‚
- ç›´æ¥èµ‹å€¼åˆ›å»ºçš„å±æ€§é»˜è®¤ï¼š`writable: true`ã€`enumerable: true`ã€`configurable: true`ï¼›`defineProperty` æœªæ˜¾å¼å£°æ˜åˆ™é»˜è®¤ä¸º `false`ã€‚
- æ‰¹é‡åœºæ™¯ä¼˜å…ˆç”¨ `Object.defineProperties`ï¼›ä¸ä»£ç†ååŒæ—¶å»ºè®®ç”¨ `Reflect.defineProperty` ä¿æŒä¸€è‡´è¯­ä¹‰ï¼ˆè¿”å›å¸ƒå°”å€¼ï¼‰ã€‚
  :::

## åŸºç¡€æ¦‚å¿µ

å±æ€§æè¿°ç¬¦ï¼ˆProperty Descriptorï¼‰æ˜¯ä¸€ä¸ªæ™®é€šå¯¹è±¡ï¼Œç”¨äºæè¿°æŸä¸ªå±æ€§çš„â€œè¡Œä¸ºä¸å…ƒæ•°æ®â€ã€‚

```js
const obj = { x: 1 };
console.log(Object.getOwnPropertyDescriptor(obj, "x"));
// { value: 1, writable: true, enumerable: true, configurable: true }

console.log(Object.getOwnPropertyDescriptors(obj));
// { x: { value: 1, writable: true, enumerable: true, configurable: true } }
```

::: info æè¿°ç¬¦å­—æ®µé€Ÿè§ˆ

- `value`ï¼šå±æ€§å€¼ï¼ˆä»…æ•°æ®å±æ€§ï¼‰
- `writable`ï¼šæ˜¯å¦å¯è¢«é‡æ–°èµ‹å€¼ï¼ˆä»…æ•°æ®å±æ€§ï¼‰
- `get` / `set`ï¼šå±æ€§çš„è¯»å–/èµ‹å€¼é’©å­ï¼ˆä»…å­˜å–å™¨å±æ€§ï¼‰
- `enumerable`ï¼šèƒ½å¦åœ¨ `for...in` / `Object.keys` ç­‰æšä¸¾ä¸­å‡ºç°
- `configurable`ï¼šèƒ½å¦åˆ é™¤ã€èƒ½å¦å†æ¬¡ä¿®æ”¹æè¿°ç¬¦ç»“æ„
  :::

## æ•°æ®å±æ€§ vs å­˜å–å™¨å±æ€§

åŒä¸€ä¸ªå±æ€§è¦ä¹ˆæ˜¯â€œæ•°æ®å±æ€§â€ï¼Œè¦ä¹ˆæ˜¯â€œå­˜å–å™¨å±æ€§â€ã€‚ä¸¤è€…æè¿°ç¬¦ä¸å…¼å®¹ã€‚

```js
// æ•°æ®å±æ€§ï¼šé€šè¿‡ value/writable æ§åˆ¶
const user = {};
Object.defineProperty(user, "id", {
  value: 1001,
  writable: false, // ä¸å¯é‡æ–°èµ‹å€¼
  enumerable: true, // å¯æšä¸¾
  configurable: true, // å¯ä¿®æ”¹/å¯åˆ é™¤
});

// å­˜å–å™¨å±æ€§ï¼šé€šè¿‡ get/set æ§åˆ¶è¯»å–/å†™å…¥é€»è¾‘
let _name = "Alice";
Object.defineProperty(user, "name", {
  get() {
    return _name.toUpperCase();
  },
  set(v) {
    if (typeof v !== "string") throw new TypeError("name å¿…é¡»æ˜¯å­—ç¬¦ä¸²");
    _name = v.trim();
  },
  enumerable: true,
  configurable: true,
});
```

::: warning é»˜è®¤å€¼ä¸å·®å¼‚

- ç›´æ¥èµ‹å€¼åˆ›å»ºå±æ€§ï¼ˆå¦‚ `obj.a = 1`ï¼‰çš„é»˜è®¤æè¿°ç¬¦ä¸ºï¼š`writable/enumerable/configurable` å‡ä¸º `true`ã€‚
- ä½¿ç”¨ `Object.defineProperty` æ—¶ï¼Œæœªå£°æ˜çš„å¸ƒå°”å­—æ®µé»˜è®¤ä¸º `false`ï¼Œ`value/get/set` é»˜è®¤ä¸º `undefined`ã€‚
- åŒä¸€å±æ€§ä¸å¯åŒæ—¶å£°æ˜ `value/writable` ä¸ `get/set`ã€‚
  :::

## æ‰¹é‡å®šä¹‰ä¸åªè¯»/éšè—å±æ€§

```js
const model = {};
Object.defineProperties(model, {
  // åªè¯»ä¸”å¯æšä¸¾
  version: {
    value: "1.0.0",
    writable: false,
    enumerable: true,
    configurable: true,
  },
  // éšè—å†…éƒ¨å­—æ®µï¼šä¸å¯æšä¸¾
  _token: {
    value: "secret",
    writable: true,
    enumerable: false,
    configurable: false,
  },
});

console.log(Object.keys(model)); // ["version"]
console.log(model._token); // "secret"ï¼ˆèƒ½è®¿é—®ï¼Œä½†ä¸ä¼šè¢«æšä¸¾ï¼‰
```

::: danger æ˜“è¸©å‘

- å°†å±æ€§è®¾ä¸º `configurable: false` åï¼Œä¸èƒ½å†æŠŠâ€œæ•°æ®å±æ€§â€æ”¹ä¸ºâ€œå­˜å–å™¨å±æ€§â€ï¼Œä¹Ÿä¸èƒ½åˆ é™¤è¯¥å±æ€§ã€‚
- å¯¹äº `writable: false` çš„æ•°æ®å±æ€§ï¼Œé‡æ–°èµ‹å€¼åœ¨éä¸¥æ ¼æ¨¡å¼ä¸‹é™é»˜å¤±è´¥ï¼Œåœ¨ä¸¥æ ¼æ¨¡å¼ä¸‹æŠ›é”™ã€‚
- è¯¯æŠŠâ€œéšè—â€ç†è§£ä¸ºâ€œä¸å¯è®¿é—®â€ï¼š`enumerable: false` ä»…å½±å“æšä¸¾ï¼Œä»å¯é€šè¿‡ç‚¹/ä¸­æ‹¬å·è®¿é—®ã€‚
  :::

## ä¸ Proxy/Reflect çš„ååŒ

åœ¨ç°ä»£ä»£ç ä¸­ï¼Œæè¿°ç¬¦å¸¸ä¸ä»£ç†/åå°„ API é…åˆä½¿ç”¨ï¼Œä»¥è·å¾—ä¸€è‡´è¯­ä¹‰ä¸å¯¹è±¡ä¸å˜å¼ä¿éšœï¼š

```js
const obj = {};
// Reflect.defineProperty è¿”å›å¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæ˜¯å¦å®šä¹‰æˆåŠŸï¼›è¯­ä¹‰ä¸ Proxy æ‹¦æˆªä¿æŒä¸€è‡´
const ok = Reflect.defineProperty(obj, "age", {
  value: 18,
  writable: true,
  enumerable: true,
  configurable: true,
});
console.log(ok); // true
```

é…åˆ Proxy æ‹¦æˆª `defineProperty` å¯ç»Ÿä¸€çº¦æŸï¼š

```js
const target = {};
const p = new Proxy(target, {
  defineProperty(t, key, desc) {
    // ç»Ÿä¸€ç­–ç•¥ï¼šç¦æ­¢å®šä¹‰ä¸å¯é…ç½®çš„å±æ€§ï¼Œé¿å…åç»­ç»´æŠ¤å›°éš¾
    if (desc && desc.configurable === false) return false;
    return Reflect.defineProperty(t, key, desc);
  },
});

Reflect.defineProperty(p, "flag", { value: 1, configurable: true });
```

## å®æˆ˜åœºæ™¯ç¤ºä¾‹

### 1) åªè¯»è§†å›¾å­—æ®µ

```js
const view = {};
Object.defineProperty(view, "createdAt", {
  value: Date.now(),
  writable: false,
  enumerable: true,
  configurable: false, // é”å®šä¸å¯ä¿®æ”¹/åˆ é™¤
});
```

### 2) å—æ§èµ‹å€¼ï¼ˆæ ¡éªŒ/å½’ä¸€åŒ–ï¼‰

```js
let _email = "";
const profile = {};
Object.defineProperty(profile, "email", {
  get() {
    return _email;
  },
  set(v) {
    if (!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(v))
      throw new Error("é‚®ä»¶æ ¼å¼ä¸æ­£ç¡®");
    _email = v.toLowerCase();
  },
  enumerable: true,
  configurable: true,
});
```

### 3) éæšä¸¾çš„å†…éƒ¨å®ç°ç»†èŠ‚

```js
const service = {};
Object.defineProperty(service, "_ctx", {
  value: { token: "abc" },
  enumerable: false, // é¿å…è¢«å¤–ç•Œæšä¸¾åˆ°
  writable: true,
  configurable: true,
});
```

## æšä¸¾ä¸éå†çš„å½±å“

```js
const obj = {};
Object.defineProperties(obj, {
  a: { value: 1, enumerable: true, configurable: true, writable: true },
  b: { value: 2, enumerable: false, configurable: true, writable: true },
});

console.log(Object.keys(obj)); // ["a"]
console.log(Object.getOwnPropertyNames(obj)); // ["a", "b"]ï¼ˆåŒ…å«ä¸å¯æšä¸¾å±æ€§åï¼‰
for (const k in obj) console.log(k); // ä»…è¾“å‡º aï¼ˆåŸå‹é“¾å¯å½±å“ç»“æœï¼‰
```

::: tip ä½¿ç”¨å»ºè®®

- ä¸šåŠ¡å»ºæ¨¡ä¼˜å…ˆä½¿ç”¨â€œç›´æ¥èµ‹å€¼â€çš„å¯å†™ã€å¯æšä¸¾ã€å¯é…ç½®å±æ€§ï¼›åœ¨éœ€è¦çº¦æŸæ—¶å†åˆ‡æ¢åˆ° `defineProperty`ã€‚
- å¯¹å¤– API æš´éœ²é¢å°½é‡ä¿æŒå¯æšä¸¾ã€å¯é…ç½®ï¼Œå†…éƒ¨å®ç°ç»†èŠ‚ä½¿ç”¨â€œä¸å¯æšä¸¾â€è¿›è¡Œéšè—ã€‚
- ä¸ä»£ç†ç»“åˆæ—¶ç”¨ `Reflect.defineProperty`ï¼Œä»¥è·å¾—å¸ƒå°”è¿”å›å’Œæ›´ä¸€è‡´çš„ä¸å˜å¼è¡Œä¸ºã€‚
  :::

## å°ç»“

1. å±æ€§æè¿°ç¬¦æ˜¯ç²¾ç»†åŒ–æ§åˆ¶å¯¹è±¡å±æ€§è¡Œä¸ºçš„å·¥å…·ï¼šå¯å®šä¹‰åªè¯»ã€éšè—ã€å—æ§èµ‹å€¼ç­‰æ¨¡å¼ã€‚
2. æ•°æ®å±æ€§ä¸å­˜å–å™¨å±æ€§æ˜¯ä¸¤ç§äº’æ–¥å½¢æ€ï¼›`configurable` å†³å®šç»“æ„æ˜¯å¦å¯å˜æ›´ã€‚
3. ä¸ `Proxy/Reflect` ååŒå¯æå‡ä¸€è‡´æ€§ä¸å®‰å…¨æ€§ï¼›æ‰¹é‡å®šä¹‰å»ºè®®ä½¿ç”¨ `Object.defineProperties`ã€‚
